---
// Multi-step lead generation form with assisted answer fields

// Data
import { multiStepFormContent } from "../../data/content/forms";
import { commonText } from "../../data/content/shared/common";

// Utils
import { getBaseUrl, createUrl } from "../../utils/url";

const base = getBaseUrl();
---

<div class="max-w-4xl mx-auto">
  <div id="form-container" class="relative">
    <!-- Progress Bar -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium text-primary transition-colors">
          <span id="current-step-name">Basic Information</span> - Step <span
            id="current-step-num">1</span
          > of 4
        </span>
        <span class="text-sm text-secondary transition-colors">
          <span id="progress-percent">25</span>% Complete
        </span>
      </div>
      <div class="h-2 bg-surface rounded-full overflow-hidden mb-3">
        <div
          id="progress-bar"
          class="h-full bg-gradient-to-r from-accent-green to-green-500 transition-all duration-slow"
          style="width: 25%"
        >
        </div>
      </div>
    </div>

    <!-- Step 1: Basic Information -->
    <div class="form-step active" data-step="1">
      <h3 class="text-2xl font-bold mb-2">
        {multiStepFormContent.step1.title}
      </h3>
      <p class="text-secondary mb-6 transition-colors">
        {multiStepFormContent.step1.subtitle}
      </p>

      <div class="space-y-4">
        <div>
          <label for="name" class="block">
            <span class="block text-sm font-medium mb-2">
              Full Name <span class="text-accent-green">*</span>
            </span>
            <input
              type="text"
              id="name"
              name="name"
              required
              autocomplete="name"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary dark:placeholder:text-secondary/70 light:placeholder:text-secondary/60"
              placeholder="John Smith"
              aria-describedby="name-error"
            />
            <p
              id="name-error"
              class="mt-1 text-xs text-accent-red hidden"
              role="alert"
            >
            </p>
          </label>
        </div>

        <div>
          <label for="email" class="block">
            <span class="block text-sm font-medium mb-2">
              Work Email <span class="text-accent-green">*</span>
            </span>
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary dark:placeholder:text-secondary/70 light:placeholder:text-secondary/60"
              placeholder="john@company.com"
              aria-describedby="email-error"
            />
            <p
              id="email-error"
              class="mt-1 text-xs text-accent-red hidden"
              role="alert"
            >
            </p>
          </label>
        </div>

        <div>
          <label for="company" class="block">
            <span class="block text-sm font-medium mb-2">
              Company Name <span class="text-accent-green">*</span>
            </span>
            <input
              type="text"
              id="company"
              name="company"
              required
              autocomplete="organization"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary dark:placeholder:text-secondary/70 light:placeholder:text-secondary/60"
              placeholder="Acme Corporation"
              list="company-suggestions"
              aria-describedby="company-error"
            />
            <datalist id="company-suggestions">
              <option value="Dubai Corporation">Dubai Corporation</option>
              <option value="Abu Dhabi Holdings">Abu Dhabi Holdings</option>
              <option value="Sharjah Industries">Sharjah Industries</option>
            </datalist>
            <p
              id="company-error"
              class="mt-1 text-xs text-accent-red hidden"
              role="alert"
            >
            </p>
          </label>
        </div>

        <div>
          <label for="phone" class="block">
            <span class="block text-sm font-medium mb-2">
              Phone Number <span class="text-secondary text-xs transition-colors">(Optional)</span
              >
            </span>
            <input
              type="tel"
              id="phone"
              name="phone"
              autocomplete="tel"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary dark:placeholder:text-secondary/70 light:placeholder:text-secondary/60"
              placeholder="+971 50 123 4567"
              aria-describedby="phone-error"
            />
            <p
              id="phone-error"
              class="mt-1 text-xs text-accent-red hidden"
              role="alert"
            >
            </p>
          </label>
        </div>

        <div>
          <label for="whyReachingOut" class="block">
            <span class="block text-sm font-medium mb-2">
              Why are you reaching out? <span class="text-secondary text-xs transition-colors"
                >(Optional)</span
              >
            </span>
            <select
              id="whyReachingOut"
              name="whyReachingOut"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary"
            >
              <option value="">Select an option...</option>
              <option value="I have an immediate need"
                >I have an immediate need</option
              >
              <option value="Planning for next quarter"
                >Planning for next quarter</option
              >
              <option value="Just exploring options"
                >Just exploring options</option
              >
              <option value="Want to learn more">Want to learn more</option>
            </select>
          </label>
        </div>

        <div>
          <label for="preferredContact" class="block">
            <span class="block text-sm font-medium mb-2"
              >How would you prefer we reach out? (Optional)</span
            >
            <select
              id="preferredContact"
              name="preferredContact"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary"
            >
              <option value="">Select an option...</option>
              <option value="Email">Email</option>
              <option value="Phone call">Phone call</option>
              <option value="Video call">Video call</option>
              <option value="No preference">No preference</option>
            </select>
          </label>
        </div>

        <div>
          <label for="urgencyLevel" class="block">
            <span class="block text-sm font-medium mb-2"
              >When do you need to make a decision? (Optional)</span
            >
            <select
              id="urgencyLevel"
              name="urgencyLevel"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary"
            >
              <option value="">Select an option...</option>
              <option value="This week">This week</option>
              <option value="This month">This month</option>
              <option value="Next quarter">Next quarter</option>
              <option value="Just exploring">Just exploring</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <!-- Step 2: Company Details -->
    <div class="form-step" data-step="2">
      <h3 class="text-2xl font-bold mb-2">
        {multiStepFormContent.step2.title}
      </h3>
      <p class="text-tertiary mb-6 transition-colors">
        {multiStepFormContent.step2.subtitle}
      </p>

      <div class="space-y-4">
        <div>
          <label for="industry" class="block">
            <span class="block text-sm font-medium mb-2">Industry *</span>
            <select
              id="industry"
              name="industry"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary dark:placeholder:text-secondary/70 light:placeholder:text-secondary/60"
            >
              <option value="">Select your industry...</option>
              <option value="finance">Financial Services & Banking</option>
              <option value="healthcare">Healthcare & Life Sciences</option>
              <option value="retail">Retail & E-commerce</option>
              <option value="technology">Technology & Software</option>
              <option value="manufacturing">Manufacturing & Logistics</option>
              <option value="energy">Energy & Utilities</option>
              <option value="real-estate">Real Estate & Construction</option>
              <option value="government">Government & Public Sector</option>
              <option value="education">Education & Research</option>
              <option value="other">Other</option>
            </select>
          </label>
        </div>

        <div>
          <div class="block text-sm font-medium mb-2" id="company-size-label">
            Company Size *
          </div>
          <div
            class="grid grid-cols-2 gap-3"
            role="group"
            aria-labelledby="company-size-label"
          >
            <button
              type="button"
              class="size-option px-4 py-3 bg-surface border border-theme rounded-lg hover:border-accent-green/50 hover:bg-accent-green/10 transition-all text-left text-primary"
              data-value="1-50"
              aria-label="Company Size: 1-50 employees, Small Team"
            >
              <div class="font-medium">1-50</div>
              <div class="text-xs text-secondary transition-colors">
                Small Team
              </div>
            </button>
            <button
              type="button"
              class="size-option px-4 py-3 bg-surface border border-theme rounded-lg hover:border-accent-green/50 hover:bg-accent-green/10 transition-all text-left text-primary"
              data-value="51-200"
              aria-label="Company Size: 51-200 employees, Growing Business"
            >
              <div class="font-medium">51-200</div>
              <div class="text-xs text-tertiary transition-colors">
                Growing Business
              </div>
            </button>
            <button
              type="button"
              class="size-option px-4 py-3 bg-surface border border-theme rounded-lg hover:border-accent-green/50 hover:bg-accent-green/10 transition-all text-left text-primary"
              data-value="201-1000"
              aria-label="Company Size: 201-1000 employees, Mid-Market"
            >
              <div class="font-medium">201-1000</div>
              <div class="text-xs text-tertiary transition-colors">
                Mid-Market
              </div>
            </button>
            <button
              type="button"
              class="size-option px-4 py-3 bg-surface border border-theme rounded-lg hover:border-accent-green/50 hover:bg-accent-green/10 transition-all text-left text-primary"
              data-value="1000+"
              aria-label="Company Size: 1000+ employees, Enterprise"
            >
              <div class="font-medium">1000+</div>
              <div class="text-xs text-tertiary transition-colors">
                Enterprise
              </div>
            </button>
          </div>
          <input
            type="hidden"
            id="company-size"
            name="company-size"
            required
            aria-label="Company Size"
          />
        </div>

        <div>
          <label for="role" class="block">
            <span class="block text-sm font-medium mb-2">Your Role *</span>
            <input
              type="text"
              id="role"
              name="role"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary dark:placeholder:text-secondary/70 light:placeholder:text-secondary/60"
              placeholder="e.g., Data Manager, CTO, Business Analyst"
            />
          </label>
        </div>
      </div>
    </div>

    <!-- Step 3: Project Details -->
    <div class="form-step" data-step="3">
      <h3 class="text-2xl font-bold mb-2">
        {multiStepFormContent.step3.title}
      </h3>
      <p class="text-tertiary mb-6 transition-colors">
        {multiStepFormContent.step3.subtitle}
      </p>

      <div class="space-y-4">
        <fieldset>
          <legend class="block text-sm font-medium mb-3">
            Services You're Interested In *
          </legend>
          <div class="space-y-2">
            <label
              for="service-bi"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-bi"
                name="services[]"
                value="business-intelligence"
                aria-label="Business Intelligence & Reporting - Dashboards, KPIs, and data visualization"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Business Intelligence & Reporting</div>
                <div class="text-xs text-secondary transition-colors">
                  Dashboards, KPIs, and data visualization
                </div>
              </div>
            </label>
            <label
              for="service-analytics"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-analytics"
                name="services[]"
                value="data-analytics"
                aria-label="Advanced Data Analytics - Predictive analytics and data science"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Advanced Data Analytics</div>
                <div class="text-xs text-secondary transition-colors">
                  Predictive analytics and data science
                </div>
              </div>
            </label>
            <label
              for="service-strategy"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-strategy"
                name="services[]"
                value="data-strategy"
                aria-label="Data Strategy & Roadmap - Strategic planning and consulting"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Data Strategy & Roadmap</div>
                <div class="text-xs text-secondary transition-colors">
                  Strategic planning and consulting
                </div>
              </div>
            </label>
            <label
              for="service-engineering"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-engineering"
                name="services[]"
                value="data-engineering"
                aria-label="Data Engineering & Integration - Data pipelines and infrastructure"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Data Engineering & Integration</div>
                <div class="text-xs text-secondary transition-colors">
                  Data pipelines and infrastructure
                </div>
              </div>
            </label>
            <label
              for="service-ml"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-ml"
                name="services[]"
                value="ml-ai"
                aria-label="Machine Learning & AI - AI/ML models and automation"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Machine Learning & AI</div>
                <div class="text-xs text-secondary transition-colors">
                  AI/ML models and automation
                </div>
              </div>
            </label>
            <label
              for="service-governance"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-governance"
                name="services[]"
                value="data-governance"
                aria-label="Data Governance & Compliance - Security, privacy, and compliance"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Data Governance & Compliance</div>
                <div class="text-xs text-secondary transition-colors">
                  Security, privacy, and compliance
                </div>
              </div>
            </label>
          </div>
        </fieldset>

        <div>
          <label for="timeline" class="block">
            <span class="block text-sm font-medium mb-2"
              >Project Timeline *</span
            >
            <select
              id="timeline"
              name="timeline"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary dark:placeholder:text-secondary/70 light:placeholder:text-secondary/60"
            >
              <option value="">When do you need this?</option>
              <option value="urgent">Urgent (Within 1 month)</option>
              <option value="soon">Soon (1-3 months)</option>
              <option value="planning">Planning (3-6 months)</option>
              <option value="exploring">Just Exploring</option>
            </select>
          </label>
        </div>

        <div>
          <label for="budget" class="block">
            <span class="block text-sm font-medium mb-2"
              >Estimated Budget Range (Optional)</span
            >
            <select
              id="budget"
              name="budget"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary dark:placeholder:text-secondary/70 light:placeholder:text-secondary/60"
            >
              <option value="">Select a range...</option>
              <option value="small">$10k - $50k</option>
              <option value="medium">$50k - $150k</option>
              <option value="large">$150k - $500k</option>
              <option value="enterprise">$500k+</option>
              <option value="tbd">To Be Determined</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <!-- Step 4: Additional Details -->
    <div class="form-step" data-step="4">
      <h3 class="text-2xl font-bold mb-2">
        {multiStepFormContent.step4.title}
      </h3>
      <p class="text-tertiary mb-6 transition-colors">
        {multiStepFormContent.step4.subtitle}
      </p>

      <div class="space-y-4">
        <div>
          <label for="message" class="block">
            <span class="block text-sm font-medium mb-2"
              >Project Description *</span
            >
            <textarea
              id="message"
              name="message"
              rows="6"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all resize-none text-primary placeholder:text-secondary"
              placeholder="Describe your data analytics challenges, goals, or questions..."
            ></textarea>
          </label>
        </div>

        <div>
          <label for="hear-about" class="block">
            <span class="block text-sm font-medium mb-2"
              >How did you hear about us?</span
            >
            <select
              id="hear-about"
              name="hear-about"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary dark:placeholder:text-secondary/70 light:placeholder:text-secondary/60"
            >
              <option value="">Select an option...</option>
              <option value="search">Google / Search Engine</option>
              <option value="linkedin">LinkedIn</option>
              <option value="referral">Referral</option>
              <option value="event">Event / Conference</option>
              <option value="social">Social Media</option>
              <option value="other">Other</option>
            </select>
          </label>
        </div>

        <div
          class="p-4 bg-surface border border-theme rounded-lg transition-colors"
        >
          <label for="newsletter" class="flex items-start cursor-pointer">
            <input
              type="checkbox"
              id="newsletter"
              name="newsletter"
              aria-label="Subscribe to our newsletter - Get insights on data analytics trends and best practices"
              class="mt-1 mr-3"
            />
            <div>
              <div class="font-medium text-sm text-primary transition-colors">
                Subscribe to our newsletter
              </div>
              <div class="text-xs text-secondary mt-1 transition-colors">
                Get insights on data analytics trends and best practices (you
                can unsubscribe anytime)
              </div>
            </div>
          </label>
        </div>

        <div
          class="p-4 bg-accent-green/10 border border-accent-green/20 rounded-lg transition-colors"
        >
          <label for="privacy" class="flex items-start cursor-pointer">
            <input
              type="checkbox"
              id="privacy"
              name="privacy"
              required
              aria-label="I agree to the Privacy Policy and consent to AUXO Data Labs contacting me about my inquiry"
              class="mt-1 mr-3"
            />
            <div class="text-sm text-primary transition-colors">
              I agree to the <a
                href={createUrl('legal/privacy-policy')}
                class="text-accent-green hover:underline transition-colors"
                >Privacy Policy</a
              > and consent to AUXO Data Labs contacting me about my inquiry. *
            </div>
          </label>
        </div>

        <!-- Honeypot field (hidden from users, used for spam detection) -->
        <input
          type="text"
          name="website"
          id="website"
          tabindex="-1"
          autocomplete="off"
          aria-hidden="true"
          style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;"
        />
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="mt-8">
      <div class="flex flex-col sm:flex-row justify-between gap-3 sm:gap-4">
        <button
          type="button"
          id="prev-btn"
          class="order-2 sm:order-1 px-6 py-3 bg-surface border border-theme text-primary rounded-lg hover:bg-accent-green/10 hover:border-accent-green/30 transition-all disabled:opacity-50 disabled:cursor-not-allowed touch-target w-full sm:w-auto"
          disabled
        >
          {multiStepFormContent.navigation.back}
        </button>
        <div class="order-1 sm:order-2 flex-1 sm:flex-initial">
          <button
            type="button"
            id="next-btn"
            class="w-full sm:w-auto px-6 py-3 bg-accent-green text-on-accent font-semibold rounded-lg hover:bg-accent-green/90 transition-all touch-target cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-accent-green/50 disabled:hover:bg-accent-green/50"
            disabled
          >
            {multiStepFormContent.navigation.next}
          </button>
          <p
            id="next-btn-help"
            class="mt-2 text-xs text-secondary/90 transition-all duration-fast text-center sm:text-left flex items-center gap-1.5 justify-center sm:justify-start"
            role="status"
            aria-live="polite"
          >
            <svg
              class="w-3.5 h-3.5 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <span id="next-btn-help-text"
              >Fill all required fields to continue</span
            >
          </p>
        </div>
        <button
          type="submit"
          id="submit-btn"
          class="hidden order-1 sm:order-2 px-6 py-3 bg-accent-green text-on-accent font-semibold rounded-lg hover:bg-accent-green/90 transition-colors touch-target w-full sm:w-auto cursor-pointer"
        >
          {multiStepFormContent.navigation.submit}
        </button>
      </div>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="hidden">
      <div class="text-center py-12">
        <div
          class="w-16 h-16 bg-accent-green rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse"
        >
          <svg
            class="w-8 h-8 text-on-accent transition-colors"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="3"
              d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold mb-2" id="success-title">
          Thank you for your inquiry!
        </h3>
        <p
          class="text-secondary mb-6 transition-colors"
          id="success-message-text"
        >
          We've received your information and will get back to you within 24
          hours.
        </p>

        <!-- What Happens Next Timeline -->
        <div
          class="bg-accent-green/10 border border-accent-green/30 rounded-xl p-6 mb-6 max-w-2xl mx-auto text-left"
        >
          <h4 class="font-bold mb-4 text-primary transition-colors">
            What Happens Next
          </h4>
          <div class="space-y-4">
            <div class="flex items-start gap-3">
              <div
                class="flex-shrink-0 w-6 h-6 bg-accent-green rounded-full flex items-center justify-center text-xs font-bold text-on-accent"
              >
                1
              </div>
              <div>
                <p class="font-medium text-primary transition-colors">
                  Confirmation email
                </p>
                <p class="text-sm text-secondary transition-colors">
                  Check your inbox within minutes
                </p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div
                class="flex-shrink-0 w-6 h-6 bg-accent-green rounded-full flex items-center justify-center text-xs font-bold text-on-accent"
              >
                2
              </div>
              <div>
                <p class="font-medium text-primary transition-colors">
                  Founder review
                </p>
                <p class="text-sm text-secondary transition-colors">
                  Within 24 hours (usually faster)
                </p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div
                class="flex-shrink-0 w-6 h-6 bg-accent-green rounded-full flex items-center justify-center text-xs font-bold text-on-accent"
              >
                3
              </div>
              <div>
                <p class="font-medium text-primary transition-colors">
                  Personal response
                </p>
                <p class="text-sm text-secondary transition-colors">
                  Via your preferred contact method
                </p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div
                class="flex-shrink-0 w-6 h-6 bg-accent-green rounded-full flex items-center justify-center text-xs font-bold text-on-accent"
              >
                4
              </div>
              <div>
                <p class="font-medium text-primary transition-colors">
                  Strategic consultation
                </p>
                <p class="text-sm text-secondary transition-colors">
                  Schedule a call to discuss your needs
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <a
            href={base}
            class="inline-flex items-center justify-center px-6 py-3 bg-accent-green text-on-accent font-semibold rounded-lg hover:bg-accent-green/90 transition-colors touch-target"
          >
            {commonText.buttons.returnHome}
          </a>
          <a
            href={createUrl('about')}
            class="inline-flex items-center justify-center px-6 py-3 bg-surface text-primary font-semibold rounded-lg hover:bg-surface/80 transition-colors border border-theme touch-target"
          >
            Learn More About Us
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .form-step {
    display: none;
  }
  .form-step.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .size-option.selected {
    background-color: var(--accent-green-dim);
    border-color: var(--accent-green);
  }

  .step-name-indicator {
    transition: color 0.3s ease;
  }

  input.border-accent-red,
  select.border-accent-red,
  textarea.border-accent-red {
    border-color: var(--accent-red) !important;
  }

  /* Preset values styling - Light color in dark theme, Dark color in light theme */
  :root.dark select option,
  :root:not(.light) select option {
    background-color: var(--bg-surface);
    color: var(--text-secondary);
  }

  :root.light select option {
    background-color: var(--bg-surface);
    color: var(--text-secondary);
  }

  /* Placeholder colors - Light in dark theme, Dark in light theme */
  :root.dark input::placeholder,
  :root:not(.light) input::placeholder,
  :root.dark textarea::placeholder,
  :root:not(.light) textarea::placeholder {
    color: var(--text-secondary);
    opacity: 0.7;
  }

  :root.light input::placeholder,
  :root.light textarea::placeholder {
    color: var(--text-secondary);
    opacity: 0.6;
  }

  /* Autofill detection and styling */
  input:-webkit-autofill,
  input:-webkit-autofill:hover,
  input:-webkit-autofill:focus,
  input:-webkit-autofill:active {
    -webkit-box-shadow: 0 0 0 30px var(--bg-surface) inset !important;
    -webkit-text-fill-color: var(--text-primary) !important;
    transition: background-color 5000s ease-in-out 0s;
  }

  /* Animation for autofill detection */
  @keyframes onAutoFillStart {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  input:-webkit-autofill {
    animation-name: onAutoFillStart;
    animation-duration: 0.0001s;
  }

  /* Error message styling */
  [id$="-error"] {
    display: block;
    color: var(--accent-red);
    font-size: 0.75rem;
    margin-top: 0.25rem;
    min-height: 1.25rem;
  }

  [id$="-error"].hidden {
    display: none;
  }
</style>

<script
  is:inline
  define:vars={{
    formText: multiStepFormContent,
    commonText: commonText,
    baseUrl: base,
  }}
>
  // Verify script execution
  console.log("[Form] Script loaded");

  // Wrap everything in try-catch to catch errors
  try {
    // Constants
    const TOTAL_STEPS = 4;
    const API_TIMEOUT = 10000; // 10 seconds

    // State - will be initialized after DOM ready
    let currentStep = 1;
    let isSubmitting = false;
    let validationInterval = null;

    // Step names mapping
    const stepNames = {
      1: "Basic Information",
      2: "About Your Organization",
      3: "Your Analytics Challenges",
      4: "Review & Submit",
    };

    // Utility: Show toast notification
    function showNotification(message, type = "error") {
      const toast = document.createElement("div");
      toast.className = `fixed top-24 right-4 z-navigation px-6 py-4 rounded-lg shadow-lg transform transition-all duration-normal translate-x-0 ${
        type === "success"
          ? "bg-accent-green text-on-accent"
          : type === "error"
            ? "bg-accent-red text-on-accent"
            : "bg-yellow-500 text-primary"
      }`;
      toast.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="font-semibold">${message}</span>
        <button onclick="this.parentElement.parentElement.remove()" class="hover:opacity-70 min-h-[44px] min-w-[44px] flex items-center justify-center transition-colors" aria-label="Close notification">âœ•</button>
      </div>
    `;
      document.body.appendChild(toast);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        toast.style.transform = "translateX(400px)";
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // Company size selection handlers
    const sizeOptionHandlers = new Map();
    const handleSizeClick = function () {
      document
        .querySelectorAll(".size-option")
        .forEach((b) => b.classList.remove("selected"));
      this.classList.add("selected");
      const sizeInput = document.getElementById("company-size");
      if (sizeInput && this.dataset.value) {
        sizeInput.value = this.dataset.value;
      }
    };

    document.querySelectorAll(".size-option").forEach((btn) => {
      sizeOptionHandlers.set(btn, handleSizeClick.bind(btn));
      const handler = sizeOptionHandlers.get(btn);
      if (handler) {
        btn.addEventListener("click", handler);
      }
    });

    function updateProgress() {
      const percent = (currentStep / TOTAL_STEPS) * 100;
      const progressBarEl = document.getElementById("progress-bar");
      const currentStepNumEl = document.getElementById("current-step-num");
      const progressPercentEl = document.getElementById("progress-percent");
      const currentStepNameEl = document.getElementById("current-step-name");

      if (progressBarEl) progressBarEl.style.width = `${percent}%`;
      if (currentStepNumEl) currentStepNumEl.textContent = String(currentStep);
      if (progressPercentEl)
        progressPercentEl.textContent = String(Math.round(percent));
      if (currentStepNameEl)
        currentStepNameEl.textContent = stepNames[currentStep] || "";

      // Update step name indicators
      document.querySelectorAll(".step-name-indicator").forEach((indicator) => {
        const step = parseInt(indicator.getAttribute("data-step") || "0");
        if (step === currentStep) {
          indicator.classList.add("text-accent-green", "font-semibold");
          indicator.classList.remove("text-secondary");
        } else if (step < currentStep) {
          indicator.classList.add("text-accent-green/70");
          indicator.classList.remove("text-secondary");
        } else {
          indicator.classList.remove(
            "text-accent-green",
            "font-semibold",
            "text-accent-green/70",
          );
          indicator.classList.add("text-secondary");
        }
      });
    }

    function showStep(step) {
      document
        .querySelectorAll(".form-step")
        .forEach((s) => s.classList.remove("active"));
      const stepEl = document.querySelector(`[data-step="${step}"]`);
      stepEl?.classList.add("active");

      const prevBtnEl = document.getElementById("prev-btn");
      const nextBtnEl = document.getElementById("next-btn");
      const submitBtnEl = document.getElementById("submit-btn");

      if (prevBtnEl) prevBtnEl.disabled = step === 1;

      if (step === TOTAL_STEPS) {
        if (nextBtnEl) nextBtnEl.classList.add("hidden");
        if (submitBtnEl) submitBtnEl.classList.remove("hidden");
      } else {
        if (nextBtnEl) nextBtnEl.classList.remove("hidden");
        if (submitBtnEl) submitBtnEl.classList.add("hidden");
        // Check if current step is valid and update button state
        checkStepValidity(step);
      }

      updateProgress();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Field labels mapping for user-friendly messages
    const fieldLabels = {
      name: "Full Name",
      email: "Work Email",
      company: "Company Name",
      phone: "Phone Number",
      industry: "Industry",
      "company-size": "Company Size",
      role: "Your Role",
      timeline: "Project Timeline",
      message: "Project Description",
      "services[]": "Services You're Interested In",
    };

    // Get field label for display
    function getFieldLabel(fieldId) {
      // Try to get label from the field's associated label element
      const field = document.getElementById(fieldId);
      if (field) {
        const label = field.closest("label")?.querySelector("span:first-child");
        if (label) {
          const text = label.textContent.trim();
          // Remove asterisk and "(Optional)" text
          return text
            .replace(/\s*\*$/, "")
            .replace(/\s*\(Optional\).*$/, "")
            .trim();
        }
        // Fallback to fieldLabels mapping
        return fieldLabels[fieldId] || fieldId;
      }
      return fieldLabels[fieldId] || fieldId;
    }

    // Simple, reliable validation function
    function checkStepValidity(step) {
      const stepEl = document.querySelector(`[data-step="${step}"]`);
      const nextBtnEl = document.getElementById("next-btn");
      const helpMsg = document.getElementById("next-btn-help");
      const helpText = document.getElementById("next-btn-help-text");

      if (!stepEl || !nextBtnEl) {
        return false;
      }

      let isValid = true;
      const missingFields = [];

      // Step 2: Check hidden company-size field
      if (step === 2) {
        const companySizeField = document.getElementById("company-size");
        if (companySizeField && companySizeField.hasAttribute("required")) {
          const sizeValue = (companySizeField.value || "").trim();
          if (!sizeValue) {
            isValid = false;
            missingFields.push("Company Size");
          }
        }
      }

      // Step 3: Check service checkboxes
      if (step === 3) {
        const serviceChecks = document.querySelectorAll(
          'input[name="services[]"]',
        );
        const anyChecked = Array.from(serviceChecks).some((cb) => cb.checked);
        if (!anyChecked) {
          isValid = false;
          missingFields.push("Services You're Interested In");
        }
      }

      // Check all required fields
      const requiredFields = stepEl.querySelectorAll("[required]");
      requiredFields.forEach((field) => {
        // Skip hidden and checkbox fields (handled separately above)
        if (field.type === "hidden" || field.type === "checkbox") {
          return;
        }

        // Get field value
        let value = "";
        if (field.tagName === "SELECT") {
          value = (field.value || "").trim();
          // Check if it's a placeholder/default option
          const selectedOption = field.options[field.selectedIndex];
          if (
            selectedOption &&
            (selectedOption.disabled ||
              selectedOption.value === "" ||
              selectedOption.textContent.includes("Select") ||
              selectedOption.textContent.includes("When do you need"))
          ) {
            value = ""; // Treat placeholder options as empty
          }
        } else {
          value = (field.value || "").trim();
        }

        // Check if empty
        if (!value) {
          isValid = false;
          const label = getFieldLabel(field.id);
          if (label && !missingFields.includes(label)) {
            missingFields.push(label);
          }
        } else if (field.type === "email") {
          // Validate email format
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(value)) {
            isValid = false;
            const label = getFieldLabel(field.id);
            if (label && !missingFields.includes(label + " (invalid format)")) {
              missingFields.push(label + " (invalid format)");
            }
          }
        }
      });

      // Update button state
      nextBtnEl.disabled = !isValid;

      // Update help message
      if (helpMsg && helpText) {
        if (isValid) {
          helpMsg.classList.add("hidden");
          helpText.textContent = "";
        } else {
          helpMsg.classList.remove("hidden");
          if (missingFields.length === 1) {
            helpText.textContent = `Fill in ${missingFields[0]}`;
          } else if (missingFields.length > 1) {
            helpText.textContent = `Fill in: ${missingFields.slice(0, 3).join(", ")}${missingFields.length > 3 ? "..." : ""}`;
          } else {
            helpText.textContent = "Fill all required fields to continue";
          }
        }
      }

      return isValid;
    }

    // Inline validation helper
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorEl = document.getElementById(`${fieldId}-error`);
      if (field && errorEl) {
        field.classList.add("border-accent-red", "focus:border-accent-red");
        field.classList.remove(
          "border-theme",
          "focus:border-accent-green",
          "focus:ring-accent-green/30",
        );
        field.classList.add("focus:ring-accent-red/30");
        errorEl.textContent = message;
        errorEl.classList.remove("hidden");
        // Scroll to error if needed
        errorEl.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    }

    function clearFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      const errorEl = document.getElementById(`${fieldId}-error`);
      if (field && errorEl) {
        field.classList.remove(
          "border-accent-red",
          "focus:border-accent-red",
          "focus:ring-accent-red/30",
        );
        field.classList.add(
          "border-theme",
          "focus:border-accent-green",
          "focus:ring-accent-green/30",
        );
        errorEl.classList.add("hidden");
        errorEl.textContent = "";
      }
    }

    // Simple real-time validation setup
    function setupFieldValidation() {
      // Email validation
      const emailField = document.getElementById("email");
      if (emailField) {
        emailField.addEventListener("blur", () => {
          const email = emailField.value.trim();
          if (email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              showFieldError("email", formText.validation.invalidEmail);
            } else {
              clearFieldError("email");
            }
          }
          checkStepValidity(currentStep);
        });
      }

      // Phone validation (optional field)
      const phoneField = document.getElementById("phone");
      if (phoneField) {
        phoneField.addEventListener("blur", () => {
          const phone = phoneField.value.trim();
          if (phone) {
            const phoneRegex =
              /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$/;
            if (!phoneRegex.test(phone)) {
              showFieldError("phone", formText.validation.invalidPhone);
            } else {
              clearFieldError("phone");
            }
          }
        });
      }

      // Real-time validation for all required fields
      const allFields = document.querySelectorAll(
        "input[required], select[required], textarea[required]",
      );

      allFields.forEach((field) => {
        // Input event - fires as user types
        field.addEventListener("input", () => {
          clearFieldError(field.id);
          checkStepValidity(currentStep);
        });

        // Change event - fires when value changes (including autofill)
        field.addEventListener("change", () => {
          clearFieldError(field.id);
          checkStepValidity(currentStep);
        });

        // Blur event - catches autofill
        field.addEventListener("blur", () => {
          checkStepValidity(currentStep);
        });
      });

      // Handle company size buttons
      document.querySelectorAll(".size-option").forEach((btn) => {
        btn.addEventListener("click", () => {
          checkStepValidity(currentStep);
        });
      });

      // Handle service checkboxes (step 3)
      document
        .querySelectorAll('input[name="services[]"]')
        .forEach((checkbox) => {
          checkbox.addEventListener("change", () => {
            checkStepValidity(currentStep);
          });
        });

      // Continuous validation as fallback - runs every 500ms
      if (validationInterval) {
        clearInterval(validationInterval);
      }
      validationInterval = setInterval(() => {
        checkStepValidity(currentStep);
      }, 500);
    }

    function validateStep(step) {
      const currentStepEl = document.querySelector(`[data-step="${step}"]`);
      if (!currentStepEl) return false;

      let isValid = true;
      const errors = [];

      // Handle step 3 checkbox validation
      if (step === 3) {
        const serviceChecks = document.querySelectorAll(
          'input[name="services[]"]',
        );
        const anyChecked = Array.from(serviceChecks).some((cb) => cb.checked);
        if (!anyChecked) {
          showNotification("Please select at least one service", "warning");
          isValid = false;
        }
      }

      // Validate required fields
      const requiredFields = currentStepEl.querySelectorAll("[required]");
      for (let field of requiredFields) {
        // Skip hidden fields (like company-size which is handled by buttons)
        if (field.type === "hidden") {
          if (!field.value.trim()) {
            isValid = false;
            // Find the associated button group and highlight it
            const sizeButtons = document.querySelectorAll(".size-option");
            if (sizeButtons.length > 0) {
              sizeButtons.forEach((btn) => {
                btn.classList.add("border-accent-red");
              });
              showNotification("Please select a company size", "warning");
            }
          }
          continue;
        }

        if (field.type === "checkbox") {
          continue; // Already handled above for step 3
        }

        const fieldId = field.id;
        const value = field.value.trim();

        if (!value) {
          errors.push(fieldId);
          showFieldError(fieldId, formText.validation.required);
          isValid = false;
        } else {
          clearFieldError(fieldId);
          // Additional validation for email
          if (field.type === "email") {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
              showFieldError(fieldId, formText.validation.invalidEmail);
              isValid = false;
            }
          }
        }
      }

      // Focus first error field
      if (errors.length > 0 && !isValid) {
        const firstErrorField = document.getElementById(errors[0]);
        if (firstErrorField) {
          firstErrorField.focus();
          showNotification("Please fill in all required fields", "warning");
        }
      }

      return isValid;
    }

    const handleNext = () => {
      const nextBtnEl = document.getElementById("next-btn");
      if (nextBtnEl?.disabled) return; // Prevent click if disabled
      if (validateStep(currentStep)) {
        currentStep++;
        showStep(currentStep);
      }
    };

    const handlePrev = () => {
      currentStep--;
      showStep(currentStep);
    };

    const handleSubmit = async () => {
      if (!validateStep(currentStep)) return;
      if (isSubmitting) return; // Prevent double submission

      isSubmitting = true;
      const submitBtnEl = document.getElementById("submit-btn");
      const originalText = submitBtnEl?.textContent || "";
      if (submitBtnEl) submitBtnEl.textContent = formText.navigation.submitting;
      if (submitBtnEl) submitBtnEl.disabled = true;

      try {
        // XSS Prevention: Sanitize user input
        const sanitizeInput = (input) => {
          const div = document.createElement("div");
          div.textContent = input;
          return div.innerHTML.trim();
        };

        // Collect form data with type safety and XSS prevention
        const getInputValue = (id) => {
          const el = document.getElementById(id);
          return sanitizeInput(el?.value || "");
        };

        const formData = {
          name: getInputValue("name"),
          email: getInputValue("email"),
          company: getInputValue("company"),
          phone: getInputValue("phone"),
          industry: getInputValue("industry"),
          companySize: getInputValue("company-size"),
          role: getInputValue("role"),
          services: Array.from(
            document.querySelectorAll('input[name="services[]"]:checked'),
          ).map((cb) => sanitizeInput(cb.value)),
          timeline: getInputValue("timeline"),
          budget: getInputValue("budget"),
          message: getInputValue("message"),
          hearAbout: getInputValue("hear-about"),
          newsletter: document.getElementById("newsletter")?.checked || false,
          website: document.getElementById("website")?.value || "", // Honeypot field
          timestamp: new Date().toISOString(),
        };

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
          showNotification(formText.validation.invalidEmail, "warning");
          return;
        }

        // Backend submission with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);

        try {
          // Construct API URL with base URL
          const apiUrl = `${baseUrl}api/contact`;
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          // Check if response is JSON before parsing
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            // Clone response to read text without consuming the original
            const clonedResponse = response.clone();
            const text = await clonedResponse.text();
            console.error("[Form] Non-JSON response:", {
              status: response.status,
              statusText: response.statusText,
              contentType,
              url: apiUrl,
              responsePreview: text.substring(0, 200),
            });
            throw new Error(
              `Server returned ${response.status} ${response.statusText}. The API endpoint may not be configured correctly.`,
            );
          }

          const result = await response.json();

          if (!response.ok) {
            // Handle specific error messages from the API
            const errorMessage =
              result.error || `Server error: ${response.status}`;
            throw new Error(errorMessage);
          }

          // Show success message with personalization
          const userName = formData.name.split(" ")[0] || "there";
          const successTitle = document.getElementById("success-title");
          const successText = document.getElementById("success-message-text");

          if (successTitle) {
            successTitle.textContent = `Thank you, ${userName}!`;
          }
          if (successText) {
            successText.textContent = `We've received your information and will get back to you within 24 hours. ${formData.preferredContact ? `We'll reach out via ${formData.preferredContact.toLowerCase()}.` : ""}`;
          }

          document
            .querySelector(".form-step.active")
            ?.classList.remove("active");
          document
            .getElementById("success-message")
            ?.classList.remove("hidden");
          document
            .querySelector(".flex.justify-between")
            ?.classList.add("hidden");
          document.querySelector(".mb-8")?.classList.add("hidden");

          showNotification("Thank you! We'll be in touch soon.", "success");
        } catch (fetchError) {
          if (fetchError instanceof Error && fetchError.name === "AbortError") {
            throw new Error("Request timeout - please try again");
          }
          throw fetchError;
        }
      } catch (error) {
        console.error("Contact form submission error:", error);
        const errorMessage =
          error instanceof Error
            ? error.message
            : "An unexpected error occurred";
        showNotification(`Submission failed: ${errorMessage}`, "error");
      } finally {
        isSubmitting = false;
        const submitBtnEl = document.getElementById("submit-btn");
        if (submitBtnEl) {
          submitBtnEl.textContent = originalText;
          submitBtnEl.disabled = false;
        }
      }
    };

    // Initialize form - simplified and reliable
    function initializeForm() {
      // Get all elements
      const nextBtnEl = document.getElementById("next-btn");
      const prevBtnEl = document.getElementById("prev-btn");
      const submitBtnEl = document.getElementById("submit-btn");

      // Verify critical elements exist
      if (!nextBtnEl) {
        console.warn("Form elements not ready, retrying...");
        setTimeout(initializeForm, 100);
        return;
      }

      // Initialize form state
      showStep(1);
      setupFieldValidation();

      // Attach event listeners
      nextBtnEl.addEventListener("click", handleNext);
      if (prevBtnEl) {
        prevBtnEl.addEventListener("click", handlePrev);
      }
      if (submitBtnEl) {
        submitBtnEl.addEventListener("click", handleSubmit);
      }

      // Ensure help message is visible initially
      const helpMsg = document.getElementById("next-btn-help");
      if (helpMsg) {
        helpMsg.classList.remove("hidden");
      }

      // Run initial validation
      checkStepValidity(currentStep);

      // Make checkStepValidity available globally for debugging
      window.checkStepValidity = checkStepValidity;
    }

    // Start initialization when DOM is ready - use IIFE to ensure execution
    (function init() {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          setTimeout(initializeForm, 100);
        });
      } else {
        // DOM already ready, but give Astro time to hydrate
        if (document.getElementById("next-btn")) {
          initializeForm();
        } else {
          setTimeout(() => {
            if (document.getElementById("next-btn")) {
              initializeForm();
            } else {
              setTimeout(init, 100);
            }
          }, 100);
        }
      }
    })();

    // Cleanup function for Astro view transitions
    document.addEventListener("astro:before-swap", () => {
      const nextBtnEl = document.getElementById("next-btn");
      const prevBtnEl = document.getElementById("prev-btn");
      const submitBtnEl = document.getElementById("submit-btn");

      if (nextBtnEl) {
        nextBtnEl.removeEventListener("click", handleNext);
      }
      if (prevBtnEl) {
        prevBtnEl.removeEventListener("click", handlePrev);
      }
      if (submitBtnEl) {
        submitBtnEl.removeEventListener("click", handleSubmit);
      }

      // Clean up validation interval
      if (validationInterval) {
        clearInterval(validationInterval);
      }

      // Clean up size option handlers
      sizeOptionHandlers.forEach((handler, btn) => {
        btn.removeEventListener("click", handler);
      });
      sizeOptionHandlers.clear();
    });
  } catch (error) {
    console.error("[Form] Initialization error:", error);
  }
</script>
