---
import { Icon } from "astro-icon/components";
---

<button
  id="theme-toggle"
  type="button"
  class="theme-toggle relative w-10 h-10 rounded-lg bg-surface border border-theme text-secondary hover:text-accent-green transition-all duration-200 flex items-center justify-center min-w-[44px] min-h-[44px] hover:bg-accent-green/10 hover:border-accent-green/30 active:scale-95"
  style="color: var(--text-secondary) !important;"
  aria-label="Toggle theme"
  title="Toggle dark/light mode"
>
  <Icon
    name="mdi:moon-waning-crescent"
    class="theme-icon-dark absolute w-5 h-5 transition-all duration-300 opacity-100 rotate-0 scale-100"
    style="color: var(--text-secondary) !important;"
  />
  <Icon
    name="mdi:white-balance-sunny"
    class="theme-icon-light absolute w-5 h-5 transition-all duration-300 opacity-0 rotate-90 scale-0"
    style="color: var(--text-secondary) !important;"
  />
</button>

<script>
  (function initThemeToggle() {
    const themeToggle = document.getElementById("theme-toggle");
    if (!themeToggle) return;

    // Get theme from localStorage or default to 'dark'
    const getTheme = (): "light" | "dark" => {
      if (typeof window === "undefined") return "dark";
      const stored = localStorage.getItem("theme") as "light" | "dark" | null;
      if (stored) return stored;

      // Check system preference
      if (window.matchMedia("(prefers-color-scheme: light)").matches) {
        return "light";
      }
      return "dark";
    };

    // Apply theme to document
    const applyTheme = (theme: "light" | "dark") => {
      const root = document.documentElement;
      if (theme === "light") {
        root.classList.remove("dark");
        root.classList.add("light");
      } else {
        root.classList.remove("light");
        root.classList.add("dark");
      }
      localStorage.setItem("theme", theme);
      updateIcon(theme);
    };

    // Update icon based on theme
    const updateIcon = (theme: "light" | "dark") => {
      // Get fresh reference to theme toggle (important after view transitions)
      const currentToggle = document.getElementById("theme-toggle");
      if (!currentToggle) return;

      const darkIcon = currentToggle.querySelector(".theme-icon-dark");
      const lightIcon = currentToggle.querySelector(".theme-icon-light");

      if (darkIcon && lightIcon) {
        if (theme === "dark") {
          darkIcon.classList.remove("opacity-0", "rotate-90", "scale-0");
          darkIcon.classList.add("opacity-100", "rotate-0", "scale-100");
          lightIcon.classList.remove("opacity-100", "rotate-0", "scale-100");
          lightIcon.classList.add("opacity-0", "rotate-90", "scale-0");
        } else {
          darkIcon.classList.remove("opacity-100", "rotate-0", "scale-100");
          darkIcon.classList.add("opacity-0", "rotate-90", "scale-0");
          lightIcon.classList.remove("opacity-0", "rotate-90", "scale-0");
          lightIcon.classList.add("opacity-100", "rotate-0", "scale-100");
        }
      }
    };

    // Toggle theme
    const toggleTheme = () => {
      const currentTheme = getTheme();
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      applyTheme(newTheme);
    };

    // Initialize theme on load
    const initTheme = () => {
      const theme = getTheme();
      applyTheme(theme);
    };

    // Set up event listeners
    themeToggle.addEventListener("click", toggleTheme);

    // Initialize on page load
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initTheme);
    } else {
      initTheme();
    }

    // Listen for system theme changes
    if (typeof window !== "undefined") {
      window
        .matchMedia("(prefers-color-scheme: light)")
        .addEventListener("change", (e) => {
          // Only auto-switch if user hasn't manually set a preference
          if (!localStorage.getItem("theme")) {
            applyTheme(e.matches ? "light" : "dark");
          }
        });
    }

    // Re-initialize on Astro view transitions
    document.addEventListener("astro:page-load", () => {
      // Get fresh reference to theme toggle (might be new DOM element after swap)
      const currentToggle = document.getElementById("theme-toggle");
      if (currentToggle) {
        // Re-apply theme to ensure consistency across page transitions
        initTheme();
        // Re-attach event listener to the new button element
        currentToggle.addEventListener("click", toggleTheme);
      }
    });

    // Cleanup on Astro view transitions (optional - not strictly needed with replaceWith approach)
    document.addEventListener("astro:before-swap", () => {
      // Event listeners will be automatically removed when DOM is swapped
      // No manual cleanup needed
    });
  })();
</script>

<style>
  .theme-toggle {
    position: relative;
    overflow: hidden;
    /* Ensure theme toggle uses text-secondary, not text-on-accent */
    color: var(--text-secondary) !important;
  }

  .theme-toggle:hover {
    color: var(--accent-green) !important;
  }

  .theme-icon-dark,
  .theme-icon-light {
    transition:
      opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    /* Ensure icons use text-secondary, not text-on-accent */
    color: var(--text-secondary) !important;
  }

  .theme-toggle:hover .theme-icon-dark,
  .theme-toggle:hover .theme-icon-light {
    color: var(--accent-green) !important;
  }
</style>
