---
// Multi-step lead generation form with assisted answer fields
import { multiStepFormContent } from "../data/content/forms";
import { commonText } from "../data/shared/common";
import { Icon } from "astro-icon/components";

const base = import.meta.env.BASE_URL;
---

<div class="max-w-4xl mx-auto">
  <div id="form-container" class="relative">
    <!-- Progress Bar -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium text-primary transition-colors">
          <span id="current-step-name">Basic Information</span> - Step <span id="current-step-num">1</span> of 4
        </span>
        <span class="text-sm text-secondary transition-colors">
          <span id="progress-percent">25</span>% Complete
        </span>
      </div>
      <div class="h-2 bg-surface rounded-full overflow-hidden mb-3">
        <div
          id="progress-bar"
          class="h-full bg-gradient-to-r from-accent-green to-green-500 transition-all duration-500"
          style="width: 25%"
        >
        </div>
      </div>
    </div>

    <!-- Step 1: Basic Information -->
    <div class="form-step active" data-step="1">
      <h3 class="text-2xl font-bold mb-2">
        {multiStepFormContent.step1.title}
      </h3>
      <p class="text-secondary mb-6 transition-colors">{multiStepFormContent.step1.subtitle}</p>

      <div class="space-y-4">
        <div>
          <label for="name" class="block">
            <span class="block text-sm font-medium mb-2">
              Full Name <span class="text-accent-green">*</span>
            </span>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary"
              placeholder="John Smith"
              aria-describedby="name-help name-error"
            />
            <p id="name-help" class="mt-1 text-xs text-secondary transition-colors">
              We'll use this to personalize your consultation
            </p>
            <p id="name-error" class="mt-1 text-xs text-accent-red hidden" role="alert"></p>
          </label>
        </div>

        <div>
          <label for="email" class="block">
            <span class="block text-sm font-medium mb-2">
              Work Email <span class="text-accent-green">*</span>
            </span>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary"
              placeholder="john@company.com"
              aria-describedby="email-help email-error"
            />
            <p id="email-help" class="mt-1 text-xs text-secondary transition-colors">
              We'll send a confirmation and respond within 24 hours
            </p>
            <p id="email-error" class="mt-1 text-xs text-accent-red hidden" role="alert"></p>
          </label>
        </div>

        <div>
          <label for="company" class="block">
            <span class="block text-sm font-medium mb-2">
              Company Name <span class="text-accent-green">*</span>
            </span>
            <input
              type="text"
              id="company"
              name="company"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary"
              placeholder="Acme Corporation"
              list="company-suggestions"
              aria-describedby="company-help company-error"
            />
            <datalist id="company-suggestions">
              <option value="Dubai Corporation">Dubai Corporation</option>
              <option value="Abu Dhabi Holdings">Abu Dhabi Holdings</option>
              <option value="Sharjah Industries">Sharjah Industries</option>
            </datalist>
            <p id="company-help" class="mt-1 text-xs text-secondary transition-colors">
              Helps us understand your industry context
            </p>
            <p id="company-error" class="mt-1 text-xs text-accent-red hidden" role="alert"></p>
          </label>
        </div>

        <div>
          <label for="phone" class="block">
            <span class="block text-sm font-medium mb-2">
              Phone Number <span class="text-secondary text-xs">(Optional)</span>
            </span>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary"
              placeholder="+971 50 123 4567"
              aria-describedby="phone-help phone-error"
            />
            <p id="phone-help" class="mt-1 text-xs text-secondary transition-colors">
              For faster response - we can call if you prefer
            </p>
            <p id="phone-error" class="mt-1 text-xs text-accent-red hidden" role="alert"></p>
          </label>
        </div>

        <div>
          <label for="whyReachingOut" class="block">
            <span class="block text-sm font-medium mb-2">
              Why are you reaching out? <span class="text-secondary text-xs">(Optional)</span>
            </span>
            <select
              id="whyReachingOut"
              name="whyReachingOut"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary"
              aria-describedby="whyReachingOut-help"
            >
              <option value="">Select an option...</option>
              <option value="I have an immediate need">I have an immediate need</option>
              <option value="Planning for next quarter">Planning for next quarter</option>
              <option value="Just exploring options">Just exploring options</option>
              <option value="Want to learn more">Want to learn more</option>
            </select>
            <p id="whyReachingOut-help" class="mt-1 text-xs text-secondary transition-colors">
              Helps us prioritize your inquiry
            </p>
          </label>
        </div>

        <div>
          <label for="preferredContact" class="block">
            <span class="block text-sm font-medium mb-2"
              >How would you prefer we reach out? (Optional)</span
            >
            <select
              id="preferredContact"
              name="preferredContact"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary"
            >
              <option value="">Select an option...</option>
              <option value="Email">Email</option>
              <option value="Phone call">Phone call</option>
              <option value="Video call">Video call</option>
              <option value="No preference">No preference</option>
            </select>
          </label>
        </div>

        <div>
          <label for="urgencyLevel" class="block">
            <span class="block text-sm font-medium mb-2"
              >When do you need to make a decision? (Optional)</span
            >
            <select
              id="urgencyLevel"
              name="urgencyLevel"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary"
            >
              <option value="">Select an option...</option>
              <option value="This week">This week</option>
              <option value="This month">This month</option>
              <option value="Next quarter">Next quarter</option>
              <option value="Just exploring">Just exploring</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <!-- Step 2: Company Details -->
    <div class="form-step" data-step="2">
      <h3 class="text-2xl font-bold mb-2">
        {multiStepFormContent.step2.title}
      </h3>
      <p class="text-tertiary mb-6 transition-colors">{multiStepFormContent.step2.subtitle}</p>

      <div class="space-y-4">
        <div>
          <label for="industry" class="block">
            <span class="block text-sm font-medium mb-2">Industry *</span>
            <select
              id="industry"
              name="industry"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary"
            >
              <option value="">Select your industry...</option>
              <option value="finance">Financial Services & Banking</option>
              <option value="healthcare">Healthcare & Life Sciences</option>
              <option value="retail">Retail & E-commerce</option>
              <option value="technology">Technology & Software</option>
              <option value="manufacturing">Manufacturing & Logistics</option>
              <option value="energy">Energy & Utilities</option>
              <option value="real-estate">Real Estate & Construction</option>
              <option value="government">Government & Public Sector</option>
              <option value="education">Education & Research</option>
              <option value="other">Other</option>
            </select>
          </label>
        </div>

        <div>
          <div class="block text-sm font-medium mb-2" id="company-size-label">
            Company Size *
          </div>
          <div
            class="grid grid-cols-2 gap-3"
            role="group"
            aria-labelledby="company-size-label"
          >
            <button
              type="button"
              class="size-option px-4 py-3 bg-surface border border-theme rounded-lg hover:border-accent-green/50 hover:bg-accent-green/10 transition-all text-left text-primary"
              data-value="1-50"
              aria-label="Company Size: 1-50 employees, Small Team"
            >
              <div class="font-medium">1-50</div>
              <div class="text-xs text-secondary transition-colors">Small Team</div>
            </button>
            <button
              type="button"
              class="size-option px-4 py-3 bg-surface border border-theme rounded-lg hover:border-accent-green/50 hover:bg-accent-green/10 transition-all text-left text-primary"
              data-value="51-200"
              aria-label="Company Size: 51-200 employees, Growing Business"
            >
              <div class="font-medium">51-200</div>
              <div class="text-xs text-tertiary transition-colors">Growing Business</div>
            </button>
            <button
              type="button"
              class="size-option px-4 py-3 bg-surface border border-theme rounded-lg hover:border-accent-green/50 hover:bg-accent-green/10 transition-all text-left text-primary"
              data-value="201-1000"
              aria-label="Company Size: 201-1000 employees, Mid-Market"
            >
              <div class="font-medium">201-1000</div>
              <div class="text-xs text-tertiary transition-colors">Mid-Market</div>
            </button>
            <button
              type="button"
              class="size-option px-4 py-3 bg-surface border border-theme rounded-lg hover:border-accent-green/50 hover:bg-accent-green/10 transition-all text-left text-primary"
              data-value="1000+"
              aria-label="Company Size: 1000+ employees, Enterprise"
            >
              <div class="font-medium">1000+</div>
              <div class="text-xs text-tertiary transition-colors">Enterprise</div>
            </button>
          </div>
          <input
            type="hidden"
            id="company-size"
            name="company-size"
            required
            aria-label="Company Size"
          />
        </div>

        <div>
          <label for="role" class="block">
            <span class="block text-sm font-medium mb-2">Your Role *</span>
            <input
              type="text"
              id="role"
              name="role"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary"
              placeholder="e.g., Data Manager, CTO, Business Analyst"
            />
          </label>
          <p class="mt-1 text-xs text-secondary transition-colors">
            This helps us understand your perspective
          </p>
        </div>
      </div>
    </div>

    <!-- Step 3: Project Details -->
    <div class="form-step" data-step="3">
      <h3 class="text-2xl font-bold mb-2">
        {multiStepFormContent.step3.title}
      </h3>
      <p class="text-tertiary mb-6 transition-colors">{multiStepFormContent.step3.subtitle}</p>

      <div class="space-y-4">
        <fieldset>
          <legend class="block text-sm font-medium mb-3">
            Services You're Interested In *
          </legend>
          <div class="space-y-2">
            <label
              for="service-bi"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-bi"
                name="services[]"
                value="business-intelligence"
                aria-label="Business Intelligence & Reporting - Dashboards, KPIs, and data visualization"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Business Intelligence & Reporting</div>
                <div class="text-xs text-secondary transition-colors">
                  Dashboards, KPIs, and data visualization
                </div>
              </div>
            </label>
            <label
              for="service-analytics"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-analytics"
                name="services[]"
                value="data-analytics"
                aria-label="Advanced Data Analytics - Predictive analytics and data science"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Advanced Data Analytics</div>
                <div class="text-xs text-secondary transition-colors">
                  Predictive analytics and data science
                </div>
              </div>
            </label>
            <label
              for="service-strategy"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-strategy"
                name="services[]"
                value="data-strategy"
                aria-label="Data Strategy & Roadmap - Strategic planning and consulting"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Data Strategy & Roadmap</div>
                <div class="text-xs text-secondary transition-colors">
                  Strategic planning and consulting
                </div>
              </div>
            </label>
            <label
              for="service-engineering"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-engineering"
                name="services[]"
                value="data-engineering"
                aria-label="Data Engineering & Integration - Data pipelines and infrastructure"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Data Engineering & Integration</div>
                <div class="text-xs text-secondary transition-colors">
                  Data pipelines and infrastructure
                </div>
              </div>
            </label>
            <label
              for="service-ml"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-ml"
                name="services[]"
                value="ml-ai"
                aria-label="Machine Learning & AI - AI/ML models and automation"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Machine Learning & AI</div>
                <div class="text-xs text-secondary transition-colors">
                  AI/ML models and automation
                </div>
              </div>
            </label>
            <label
              for="service-governance"
              class="flex items-start p-3 bg-surface border border-theme rounded-lg cursor-pointer hover:border-accent-green/50 hover:bg-accent-green/10 transition-all"
            >
              <input
                type="checkbox"
                id="service-governance"
                name="services[]"
                value="data-governance"
                aria-label="Data Governance & Compliance - Security, privacy, and compliance"
                class="mt-1 mr-3"
              />
              <div>
                <div class="font-medium">Data Governance & Compliance</div>
                <div class="text-xs text-secondary transition-colors">
                  Security, privacy, and compliance
                </div>
              </div>
            </label>
          </div>
        </fieldset>

        <div>
          <label for="timeline" class="block">
            <span class="block text-sm font-medium mb-2"
              >Project Timeline *</span
            >
            <select
              id="timeline"
              name="timeline"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary"
            >
              <option value="">When do you need this?</option>
              <option value="urgent">Urgent (Within 1 month)</option>
              <option value="soon">Soon (1-3 months)</option>
              <option value="planning">Planning (3-6 months)</option>
              <option value="exploring">Just Exploring</option>
            </select>
          </label>
        </div>

        <div>
          <label for="budget" class="block">
            <span class="block text-sm font-medium mb-2"
              >Estimated Budget Range (Optional)</span
            >
            <select
              id="budget"
              name="budget"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary"
            >
              <option value="">Select a range...</option>
              <option value="small">$10k - $50k</option>
              <option value="medium">$50k - $150k</option>
              <option value="large">$150k - $500k</option>
              <option value="enterprise">$500k+</option>
              <option value="tbd">To Be Determined</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <!-- Step 4: Additional Details -->
    <div class="form-step" data-step="4">
      <h3 class="text-2xl font-bold mb-2">
        {multiStepFormContent.step4.title}
      </h3>
      <p class="text-tertiary mb-6 transition-colors">{multiStepFormContent.step4.subtitle}</p>

      <div class="space-y-4">
        <div>
          <label for="message" class="block">
            <span class="block text-sm font-medium mb-2"
              >Project Description *</span
            >
            <textarea
              id="message"
              name="message"
              rows="6"
              required
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all resize-none text-primary placeholder:text-secondary"
              placeholder="Describe your data analytics challenges, goals, or questions..."
            ></textarea>
          </label>
          <p class="mt-1 text-xs text-secondary transition-colors">
            Be as detailed as you'd like - this helps us prepare for our
            conversation
          </p>
        </div>

        <div>
          <label for="hear-about" class="block">
            <span class="block text-sm font-medium mb-2"
              >How did you hear about us?</span
            >
            <select
              id="hear-about"
              name="hear-about"
              class="w-full px-4 py-3 bg-surface border border-theme rounded-lg focus:outline-none focus:border-accent-green focus:ring-2 focus:ring-accent-green/30 transition-all text-primary placeholder:text-secondary"
            >
              <option value="">Select an option...</option>
              <option value="search">Google / Search Engine</option>
              <option value="linkedin">LinkedIn</option>
              <option value="referral">Referral</option>
              <option value="event">Event / Conference</option>
              <option value="social">Social Media</option>
              <option value="other">Other</option>
            </select>
          </label>
        </div>

        <div class="p-4 bg-surface border border-theme rounded-lg transition-colors">
          <label for="newsletter" class="flex items-start cursor-pointer">
            <input
              type="checkbox"
              id="newsletter"
              name="newsletter"
              aria-label="Subscribe to our newsletter - Get insights on data analytics trends and best practices"
              class="mt-1 mr-3"
            />
            <div>
              <div class="font-medium text-sm text-primary transition-colors">Subscribe to our newsletter</div>
              <div class="text-xs text-secondary mt-1 transition-colors">
                Get insights on data analytics trends and best practices (you
                can unsubscribe anytime)
              </div>
            </div>
          </label>
        </div>

        <div class="p-4 bg-accent-green/10 border border-accent-green/20 rounded-lg transition-colors">
          <label for="privacy" class="flex items-start cursor-pointer">
            <input
              type="checkbox"
              id="privacy"
              name="privacy"
              required
              aria-label="I agree to the Privacy Policy and consent to AUXO Data Labs contacting me about my inquiry"
              class="mt-1 mr-3"
            />
            <div class="text-sm text-primary transition-colors">
              I agree to the <a
                href={`${base}legal/privacy-policy/`}
                class="text-accent-green hover:underline transition-colors">Privacy Policy</a
              > and consent to AUXO Data Labs contacting me about my inquiry. *
            </div>
          </label>
        </div>

        <!-- Honeypot field (hidden from users, used for spam detection) -->
        <input
          type="text"
          name="website"
          id="website"
          tabindex="-1"
          autocomplete="off"
          aria-hidden="true"
          style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;"
        />
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="flex justify-between mt-8">
      <button
        type="button"
        id="prev-btn"
        class="px-6 py-3 bg-surface border border-theme text-primary rounded-lg hover:bg-accent-green/10 hover:border-accent-green/30 transition-all disabled:opacity-50 disabled:cursor-not-allowed min-h-[44px]"
        disabled
      >
        {multiStepFormContent.navigation.back}
      </button>
      <button
        type="button"
        id="next-btn"
        class="px-6 py-3 bg-accent-green text-on-accent font-semibold rounded-lg hover:bg-accent-green/90 transition-all min-h-[44px]"
      >
        {multiStepFormContent.navigation.next}
      </button>
      <button
        type="submit"
        id="submit-btn"
        class="hidden px-6 py-3 bg-accent-green text-on-accent font-semibold rounded-lg hover:bg-accent-green/90 transition-colors min-h-[44px]"
      >
        {multiStepFormContent.navigation.submit}
      </button>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="hidden">
      <div class="text-center py-12">
        <div
          class="w-16 h-16 bg-accent-green rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse"
        >
          <svg
            class="w-8 h-8 text-on-accent transition-colors"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="3"
              d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold mb-2" id="success-title">Thank you for your inquiry!</h3>
        <p class="text-secondary mb-6 transition-colors" id="success-message-text">
          We've received your information and will get back to you within 24 hours.
        </p>
        
        <!-- What Happens Next Timeline -->
        <div class="bg-accent-green/10 border border-accent-green/30 rounded-xl p-6 mb-6 max-w-2xl mx-auto text-left">
          <h4 class="font-bold mb-4 text-primary transition-colors">
            What Happens Next
          </h4>
          <div class="space-y-4">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 bg-accent-green rounded-full flex items-center justify-center text-xs font-bold text-on-accent">
                1
              </div>
              <div>
                <p class="font-medium text-primary transition-colors">Confirmation email</p>
                <p class="text-sm text-secondary transition-colors">Check your inbox within minutes</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 bg-accent-green rounded-full flex items-center justify-center text-xs font-bold text-on-accent">
                2
              </div>
              <div>
                <p class="font-medium text-primary transition-colors">Founder review</p>
                <p class="text-sm text-secondary transition-colors">Within 24 hours (usually faster)</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 bg-accent-green rounded-full flex items-center justify-center text-xs font-bold text-on-accent">
                3
              </div>
              <div>
                <p class="font-medium text-primary transition-colors">Personal response</p>
                <p class="text-sm text-secondary transition-colors">Via your preferred contact method</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 bg-accent-green rounded-full flex items-center justify-center text-xs font-bold text-on-accent">
                4
              </div>
              <div>
                <p class="font-medium text-primary transition-colors">Free consultation</p>
                <p class="text-sm text-secondary transition-colors">Schedule a call to discuss your needs</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <a
            href={base}
            class="inline-flex items-center justify-center px-6 py-3 bg-accent-green text-on-accent font-semibold rounded-lg hover:bg-accent-green/90 transition-colors min-h-[44px] min-w-[44px]"
          >
            {commonText.buttons.returnHome}
          </a>
          <a
            href={`${base}about/`}
            class="inline-flex items-center justify-center px-6 py-3 bg-surface text-primary font-semibold rounded-lg hover:bg-surface/80 transition-colors border border-theme min-h-[44px] min-w-[44px]"
          >
            Learn More About Us
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .form-step {
    display: none;
  }
  .form-step.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .size-option.selected {
    background-color: var(--accent-green-dim);
    border-color: var(--accent-green);
  }
  
  .step-name-indicator {
    transition: color 0.3s ease;
  }
  
  input.border-accent-red,
  select.border-accent-red,
  textarea.border-accent-red {
    border-color: var(--accent-red) !important;
  }
</style>

<script
  is:inline
  define:vars={{ formText: multiStepFormContent, commonText: commonText }}
>
  // Constants
  const TOTAL_STEPS = 4;
  const API_TIMEOUT = 10000; // 10 seconds

  // State
  let currentStep = 1;
  let isSubmitting = false;

  // Elements
  const prevBtn = document.getElementById("prev-btn");
  const nextBtn = document.getElementById("next-btn");
  const submitBtn = document.getElementById("submit-btn");
  const progressBar = document.getElementById("progress-bar");
  const currentStepNum = document.getElementById("current-step-num");
  const progressPercent = document.getElementById("progress-percent");
  const currentStepName = document.getElementById("current-step-name");
  
  // Step names mapping
  const stepNames = {
    1: "Basic Information",
    2: "About Your Organization",
    3: "Your Analytics Challenges",
    4: "Review & Submit"
  };

  // Utility: Show toast notification
  function showNotification(message, type = "error") {
    const toast = document.createElement("div");
    toast.className = `fixed top-24 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-0 ${
      type === "success"
        ? "bg-accent-green text-on-accent"
        : type === "error"
          ? "bg-accent-red text-on-accent"
          : "bg-yellow-500 text-black"
    }`;
    toast.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="font-semibold">${message}</span>
        <button onclick="this.parentElement.parentElement.remove()" class="hover:opacity-70">âœ•</button>
      </div>
    `;
    document.body.appendChild(toast);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      toast.style.transform = "translateX(400px)";
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }

  // Company size selection handlers
  const sizeOptionHandlers = new Map();
  const handleSizeClick = function () {
    document
      .querySelectorAll(".size-option")
      .forEach((b) => b.classList.remove("selected"));
    this.classList.add("selected");
    const sizeInput = document.getElementById("company-size");
    if (sizeInput && this.dataset.value) {
      sizeInput.value = this.dataset.value;
    }
  };

  document.querySelectorAll(".size-option").forEach((btn) => {
    sizeOptionHandlers.set(btn, handleSizeClick.bind(btn));
    const handler = sizeOptionHandlers.get(btn);
    if (handler) {
      btn.addEventListener("click", handler);
    }
  });

  function updateProgress() {
    const percent = (currentStep / TOTAL_STEPS) * 100;
    if (progressBar) progressBar.style.width = `${percent}%`;
    if (currentStepNum) currentStepNum.textContent = String(currentStep);
    if (progressPercent)
      progressPercent.textContent = String(Math.round(percent));
    if (currentStepName) currentStepName.textContent = stepNames[currentStep] || "";
    
    // Update step name indicators
    document.querySelectorAll(".step-name-indicator").forEach((indicator) => {
      const step = parseInt(indicator.getAttribute("data-step") || "0");
      if (step === currentStep) {
        indicator.classList.add("text-accent-green", "font-semibold");
        indicator.classList.remove("text-secondary");
      } else if (step < currentStep) {
        indicator.classList.add("text-accent-green/70");
        indicator.classList.remove("text-secondary");
      } else {
        indicator.classList.remove("text-accent-green", "font-semibold", "text-accent-green/70");
        indicator.classList.add("text-secondary");
      }
    });
  }

  function showStep(step) {
    document
      .querySelectorAll(".form-step")
      .forEach((s) => s.classList.remove("active"));
    const stepEl = document.querySelector(`[data-step="${step}"]`);
    stepEl?.classList.add("active");

    if (prevBtn) prevBtn.disabled = step === 1;

    if (step === TOTAL_STEPS) {
      nextBtn?.classList.add("hidden");
      submitBtn?.classList.remove("hidden");
    } else {
      nextBtn?.classList.remove("hidden");
      submitBtn?.classList.add("hidden");
    }

    updateProgress();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // Inline validation helper
  function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorEl = document.getElementById(`${fieldId}-error`);
    if (field && errorEl) {
      field.classList.add("border-accent-red", "focus:border-accent-red");
      field.classList.remove("border-theme", "focus:border-accent-green");
      errorEl.textContent = message;
      errorEl.classList.remove("hidden");
    }
  }

  function clearFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    const errorEl = document.getElementById(`${fieldId}-error`);
    if (field && errorEl) {
      field.classList.remove("border-accent-red", "focus:border-accent-red");
      field.classList.add("border-theme", "focus:border-accent-green");
      errorEl.classList.add("hidden");
      errorEl.textContent = "";
    }
  }

  // Real-time validation
  function setupFieldValidation() {
    // Email validation
    const emailField = document.getElementById("email");
    if (emailField) {
      emailField.addEventListener("blur", () => {
        const email = emailField.value.trim();
        if (email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            showFieldError("email", formText.validation.invalidEmail);
          } else {
            clearFieldError("email");
          }
        }
      });
      emailField.addEventListener("input", () => {
        if (emailField.value.trim()) clearFieldError("email");
      });
    }

    // Phone validation (optional field)
    const phoneField = document.getElementById("phone");
    if (phoneField) {
      phoneField.addEventListener("blur", () => {
        const phone = phoneField.value.trim();
        if (phone) {
          // Basic phone validation (international format)
          const phoneRegex = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$/;
          if (!phoneRegex.test(phone)) {
            showFieldError("phone", formText.validation.invalidPhone);
          } else {
            clearFieldError("phone");
          }
        }
      });
      phoneField.addEventListener("input", () => {
        if (phoneField.value.trim()) clearFieldError("phone");
      });
    }
  }

  function validateStep(step) {
    const currentStepEl = document.querySelector(`[data-step="${step}"]`);
    const requiredFields = currentStepEl?.querySelectorAll("[required]");

    if (!requiredFields) return false;

    let isValid = true;

    for (let field of requiredFields) {
      if (field.type === "checkbox") {
        // For step 3, at least one service must be selected
        if (step === 3) {
          const serviceChecks = document.querySelectorAll(
            'input[name="services[]"]',
          );
          const anyChecked = Array.from(serviceChecks).some((cb) => cb.checked);
          if (!anyChecked) {
            showNotification("Please select at least one service", "warning");
            isValid = false;
          }
        }
      } else {
        const fieldId = field.id;
        if (!field.value.trim()) {
          field.focus();
          showFieldError(fieldId, formText.validation.required);
          showNotification(formText.validation.required, "warning");
          isValid = false;
        } else {
          clearFieldError(fieldId);
          // Additional validation for email
          if (field.type === "email") {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(field.value.trim())) {
              showFieldError(fieldId, formText.validation.invalidEmail);
              isValid = false;
            }
          }
        }
      }
    }
    return isValid;
  }

  const handleNext = () => {
    if (validateStep(currentStep)) {
      currentStep++;
      showStep(currentStep);
    }
  };

  const handlePrev = () => {
    currentStep--;
    showStep(currentStep);
  };

  const handleSubmit = async () => {
    if (!validateStep(currentStep)) return;
    if (isSubmitting) return; // Prevent double submission

    isSubmitting = true;
    const originalText = submitBtn?.textContent || "";
    if (submitBtn) submitBtn.textContent = formText.navigation.submitting;
    if (submitBtn) submitBtn.disabled = true;

    try {
      // XSS Prevention: Sanitize user input
      const sanitizeInput = (input) => {
        const div = document.createElement("div");
        div.textContent = input;
        return div.innerHTML.trim();
      };

      // Collect form data with type safety and XSS prevention
      const getInputValue = (id) => {
        const el = document.getElementById(id);
        return sanitizeInput(el?.value || "");
      };

      const formData = {
        name: getInputValue("name"),
        email: getInputValue("email"),
        company: getInputValue("company"),
        phone: getInputValue("phone"),
        industry: getInputValue("industry"),
        companySize: getInputValue("company-size"),
        role: getInputValue("role"),
        services: Array.from(
          document.querySelectorAll('input[name="services[]"]:checked'),
        ).map((cb) => sanitizeInput(cb.value)),
        timeline: getInputValue("timeline"),
        budget: getInputValue("budget"),
        message: getInputValue("message"),
        hearAbout: getInputValue("hear-about"),
        newsletter: document.getElementById("newsletter")?.checked || false,
        website: document.getElementById("website")?.value || "", // Honeypot field
        timestamp: new Date().toISOString(),
      };

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(formData.email)) {
        showNotification(formText.validation.invalidEmail, "warning");
        return;
      }

      // Backend submission with timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);

      try {
        const response = await fetch(`${import.meta.env.BASE_URL}api/contact`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
          signal: controller.signal,
        });

        clearTimeout(timeoutId);

        const result = await response.json();

        if (!response.ok) {
          // Handle specific error messages from the API
          const errorMessage =
            result.error || `Server error: ${response.status}`;
          throw new Error(errorMessage);
        }

        // Show success message with personalization
        const userName = formData.name.split(" ")[0] || "there";
        const successTitle = document.getElementById("success-title");
        const successText = document.getElementById("success-message-text");
        
        if (successTitle) {
          successTitle.textContent = `Thank you, ${userName}!`;
        }
        if (successText) {
          successText.textContent = `We've received your information and will get back to you within 24 hours. ${formData.preferredContact ? `We'll reach out via ${formData.preferredContact.toLowerCase()}.` : ""}`;
        }
        
        document.querySelector(".form-step.active")?.classList.remove("active");
        document.getElementById("success-message")?.classList.remove("hidden");
        document
          .querySelector(".flex.justify-between")
          ?.classList.add("hidden");
        document.querySelector(".mb-8")?.classList.add("hidden");

        showNotification("Thank you! We'll be in touch soon.", "success");
      } catch (fetchError) {
        if (fetchError instanceof Error && fetchError.name === "AbortError") {
          throw new Error("Request timeout - please try again");
        }
        throw fetchError;
      }
    } catch (error) {
      console.error("Contact form submission error:", error);
      const errorMessage =
        error instanceof Error ? error.message : "An unexpected error occurred";
      showNotification(`Submission failed: ${errorMessage}`, "error");
    } finally {
      isSubmitting = false;
      if (submitBtn) {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }
  };

  nextBtn?.addEventListener("click", handleNext);
  prevBtn?.addEventListener("click", handlePrev);
  submitBtn?.addEventListener("click", handleSubmit);

  // Initialize
  showStep(1);
  setupFieldValidation();

  // Cleanup function for Astro view transitions
  document.addEventListener("astro:before-swap", () => {
    nextBtn?.removeEventListener("click", handleNext);
    prevBtn?.removeEventListener("click", handlePrev);
    submitBtn?.removeEventListener("click", handleSubmit);

    // Clean up size option handlers
    sizeOptionHandlers.forEach((handler, btn) => {
      btn.removeEventListener("click", handler);
    });
    sizeOptionHandlers.clear();
  });
</script>
