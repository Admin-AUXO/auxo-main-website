---
import { services } from '../data/collections/services';
import { Icon } from 'astro-icon/components';

const base = import.meta.env.BASE_URL;

interface DropdownItem {
  name: string;
  href: string;
  icon: string;
  description?: string;
}

interface NavItem {
  name: string;
  href: string;
  dropdown?: DropdownItem[];
}

const navItems: NavItem[] = [
  {
    name: 'Services',
    href: `${base}services/`,
    dropdown: services.map(s => ({
      name: s.title,
      href: `${base}services/${s.id}/`,
      icon: s.icon,
      description: s.description
    }))
  },
  { name: 'About', href: `${base}about/` },
  {
    name: 'Resources',
    href: `${base}blog/`,
    dropdown: [
      { name: 'Case Studies', href: `${base}case-studies/`, icon: 'case-studies' },
      { name: 'Blog', href: `${base}blog/`, icon: 'blog' },
      { name: 'FAQ', href: `${base}faq/`, icon: 'faq' }
    ]
  },
];
---

<nav id="main-navigation" class="fixed top-0 left-0 right-0 z-50 bg-black backdrop-blur-md border-b border-zinc-900/80 transition-all duration-500 ease-out shadow-xl shadow-black/30">
  <div class="container mx-auto px-3 sm:px-4 md:px-6 lg:px-8 relative">
    <div class="flex items-center justify-between h-16 sm:h-18 lg:h-20">
      <!-- Enhanced Logo Section -->
      <a 
        href={`${base}`} 
        class="flex items-center space-x-2.5 sm:space-x-3 group relative z-10" 
        aria-label="AUXO Data Labs Home"
      >
        <!-- Logo Container -->
        <div class="relative">
          <img 
            src={`${base}logo.svg`} 
            alt="AUXO Data Labs Logo" 
            class="relative h-9 w-9 sm:h-11 sm:w-11 lg:h-12 lg:w-12 transition-all duration-300 group-hover:scale-110 group-hover:rotate-3" 
          />
        </div>
        <!-- Brand Text with Enhanced Typography -->
        <div class="flex flex-col hidden sm:flex">
          <span class="text-white text-base sm:text-lg lg:text-xl font-bold tracking-tight leading-tight group-hover:text-lime-400 transition-colors duration-300">
            AUXO
          </span>
          <span class="text-xs text-gray-400 font-medium tracking-wider uppercase leading-tight">
            Data Labs
          </span>
        </div>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden lg:flex items-center space-x-1">
        {navItems.map((item, index) => (
          item.dropdown ? (
            <div class="relative dropdown-container" data-nav-item={index}>
              <button 
                class="nav-link dropdown-toggle relative px-5 py-3 text-sm font-medium text-gray-300 hover:text-white transition-all duration-300 rounded-lg hover:bg-zinc-800/60 flex items-center gap-2"
                aria-expanded="false"
                aria-haspopup="true"
                data-dropdown-toggle={index}
              >
                <span class="relative z-10">{item.name}</span>
                <!-- Active Indicator -->
                <span class="nav-indicator absolute bottom-0 left-1/2 -translate-x-1/2 w-0 h-0.5 bg-gradient-to-r from-lime-400 to-lime-500 rounded-full transition-all duration-300"></span>
                <!-- Dropdown Arrow -->
                <svg 
                  class="w-4 h-4 transition-transform duration-300 dropdown-arrow" 
                  fill="none" 
                  stroke="currentColor" 
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>

              <!-- Enhanced Dropdown Menu -->
              <div 
                class:list={[
                  "absolute left-0 top-full mt-2 opacity-0 invisible transition-all duration-300 transform scale-95 translate-y-2 pointer-events-none dropdown-menu z-[60]",
                  item.name === 'Services' ? 'w-[560px]' : 'w-[280px]'
                ]}
                data-dropdown-menu={index}
              >
                <div class="relative">
                  <!-- Arrow Pointer -->
                  <div class="absolute -top-2 left-6 w-4 h-4 bg-zinc-900 border-l border-t border-lime-400/20 rotate-45 z-10 dropdown-arrow-pointer"></div>
                  
                  <!-- Dropdown Content -->
                  <div class="relative bg-zinc-900 border border-lime-400/20 rounded-2xl shadow-2xl shadow-black/60 p-6 overflow-hidden">
                    <!-- Gradient Background Effect -->
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-lime-400/50 via-green-500/50 to-lime-400/50"></div>
                    
                    <div class:list={[
                      item.name === 'Services' ? 'grid grid-cols-2 gap-3' : 'space-y-2'
                    ]}>
                      {item.dropdown.map((sub: DropdownItem, subIndex) => (
                        <a
                          href={sub.href}
                          class={item.name === 'Services' 
                            ? "group/item relative flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-zinc-800 transition-all duration-300 border border-transparent hover:border-lime-400/30 hover:shadow-lg hover:shadow-lime-400/10 overflow-hidden"
                            : "group/item relative flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-zinc-800 transition-all duration-300 border border-transparent hover:border-lime-400/30 hover:shadow-lg hover:shadow-lime-400/10 overflow-hidden"
                          }
                          style={`animation-delay: ${subIndex * 50}ms`}
                        >
                          <!-- Hover Glow Effect -->
                          <div class="absolute inset-0 bg-gradient-to-br from-lime-400/0 to-lime-400/5 opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div>
                          
                          <!-- Icon Container -->
                          <div class="relative z-10 w-10 h-10 bg-gradient-to-br from-lime-400/20 via-lime-400/10 to-transparent rounded-lg flex items-center justify-center flex-shrink-0 group-hover/item:from-lime-400/30 group-hover/item:to-lime-500/20 transition-all duration-300 group-hover/item:scale-110">
                            {item.name === 'Services' ? (
                              <Icon name={sub.icon} class="w-5 h-5 text-lime-400" />
                            ) : (
                              <Icon
                                name={sub.icon === 'case-studies' ? 'mdi:briefcase' : sub.icon === 'blog' ? 'mdi:post' : 'mdi:help-circle'}
                                class="w-5 h-5 text-lime-400"
                              />
                            )}
                          </div>
                          
                          <!-- Content -->
                          <div class="relative z-10 flex-1 min-w-0">
                            <div class="font-semibold text-white text-sm group-hover/item:text-lime-400 transition-colors duration-300">
                              {sub.name}
                            </div>
                          </div>
                          
                          <!-- Arrow Indicator -->
                          <div class="relative z-10 flex items-center opacity-0 group-hover/item:opacity-100 transform translate-x-2 group-hover/item:translate-x-0 transition-all duration-300">
                            <svg class="w-4 h-4 text-lime-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                          </div>
                        </a>
                      ))}
                    </div>
                    
                    {item.name === 'Services' && (
                      <div class="mt-6 pt-4 border-t border-zinc-800/50">
                        <a 
                          href={`${base}services/`} 
                          class="group/viewall flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-lime-400 hover:text-white bg-lime-400/10 hover:bg-lime-400/20 rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg hover:shadow-lime-400/20"
                        >
                          <span>View All Services</span>
                          <svg class="w-4 h-4 transform group-hover/viewall:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                          </svg>
                        </a>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <a 
              href={item.href} 
              class="nav-link relative px-5 py-3 text-sm font-medium text-gray-300 hover:text-white transition-all duration-300 rounded-lg hover:bg-zinc-800/60 group"
            >
              <span class="relative z-10">{item.name}</span>
              <!-- Active Indicator -->
              <span class="nav-indicator absolute bottom-0 left-1/2 -translate-x-1/2 w-0 h-0.5 bg-gradient-to-r from-lime-400 to-lime-500 rounded-full transition-all duration-300 group-hover:w-4/5"></span>
            </a>
          )
        ))}
        
        <!-- Enhanced CTA Button -->
        <a 
          href={`${base}contact/`} 
          class="ml-4 px-6 py-3 text-sm font-semibold bg-gradient-to-r from-lime-400 via-lime-400 to-green-500 text-black rounded-lg hover:from-lime-500 hover:via-lime-500 hover:to-green-600 transition-all duration-300 hover:scale-105 relative overflow-hidden group"
        >
          <span class="relative z-10 flex items-center gap-2">
            Get Started
            <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </span>
          <!-- Shimmer Effect -->
          <div class="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
        </a>
      </div>

      <!-- Mobile Menu Button -->
      <button 
        id="mobile-menu-button" 
        class="lg:hidden relative text-white p-2.5 min-w-[44px] min-h-[44px] rounded-lg hover:bg-zinc-800/80 active:bg-zinc-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-lime-400/50 touch-manipulation" 
        aria-label="Toggle mobile menu" 
        aria-expanded="false"
      >
        <div class="relative w-6 h-6">
          <svg 
            class="absolute inset-0 w-6 h-6 menu-icon transition-all duration-300" 
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24"
          >
            <path 
              class="menu-open transition-opacity duration-300" 
              stroke-linecap="round" 
              stroke-linejoin="round" 
              stroke-width="2.5" 
              d="M4 6h16M4 12h16M4 18h16"
            ></path>
            <path 
              class="menu-close absolute inset-0 opacity-0 transition-opacity duration-300" 
              stroke-linecap="round" 
              stroke-linejoin="round" 
              stroke-width="2.5" 
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </div>
      </button>
    </div>
  </div>

  <!-- Enhanced Mobile Menu - Improved for better touch interaction -->
  <div 
    id="mobile-menu" 
    class="lg:hidden fixed inset-x-0 top-16 sm:top-18 bg-zinc-950 border-t border-zinc-800/60 max-h-[calc(100vh-4rem)] overflow-y-auto overscroll-contain transform -translate-y-full opacity-0 transition-all duration-250 ease-out shadow-2xl shadow-black/40"
    style="touch-action: pan-y; -webkit-overflow-scrolling: touch;"
  >
    <div class="px-4 sm:px-5 py-5 space-y-2">
      {navItems.map((item, index) => (
        item.dropdown ? (
          <div class="mobile-dropdown" data-nav-item={index}>
            <button 
              type="button"
              class="mobile-dropdown-btn w-full flex items-center justify-between px-4 py-3.5 min-h-[52px] text-gray-300 hover:text-white active:text-white active:bg-zinc-800 rounded-lg transition-all duration-200 font-medium touch-manipulation bg-zinc-900/50 border border-zinc-800/50 hover:border-lime-400/30 active:border-lime-400/50 text-base sm:text-base"
              aria-expanded="false"
            >
              <span>{item.name}</span>
              <svg 
                class="w-5 h-5 transition-transform duration-300 flex-shrink-0 text-lime-400" 
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="mobile-dropdown-content hidden pl-5 mt-2 space-y-2 overflow-hidden">
              {item.dropdown.map((sub: DropdownItem) => (
                <a 
                  href={sub.href} 
                  class="flex items-center gap-3 px-4 py-3 min-h-[48px] text-sm sm:text-base text-gray-400 hover:text-lime-400 active:text-lime-400 active:bg-zinc-800/80 rounded-lg transition-all duration-200 touch-manipulation group/item"
                >
                  <div class="w-2 h-2 rounded-full bg-lime-400/60 group-hover/item:bg-lime-400 transition-colors duration-300 flex-shrink-0"></div>
                  <span class="flex-1 font-medium">{sub.name}</span>
                  <svg class="w-4 h-4 opacity-0 group-hover/item:opacity-100 transform -translate-x-2 group-hover/item:translate-x-0 transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>
              ))}
            </div>
          </div>
        ) : (
          <a 
            href={item.href} 
            class="block px-4 py-3.5 min-h-[52px] text-base text-gray-300 hover:text-white active:text-white active:bg-zinc-800/80 rounded-lg transition-all duration-200 font-medium touch-manipulation flex items-center bg-zinc-900/50 border border-zinc-800/50 hover:border-lime-400/30 active:border-lime-400/50"
          >
            {item.name}
          </a>
        )
      ))}
      
      <!-- Mobile CTA Button - Improved touch target -->
      <a 
        href={`${base}contact/`} 
        class="block mt-5 px-6 py-4 min-h-[56px] bg-gradient-to-r from-lime-400 to-lime-500 text-black font-bold rounded-lg active:from-lime-500 active:to-lime-600 active:scale-[0.96] transition-all duration-200 text-center shadow-xl shadow-lime-400/30 touch-manipulation flex items-center justify-center text-base relative overflow-hidden group"
      >
        <span class="relative z-10 flex items-center gap-2">
          Get Started
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
          </svg>
        </span>
        <div class="absolute inset-0 -translate-x-full group-active:translate-x-full transition-transform duration-500 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
      </a>
    </div>
  </div>
</nav>

<!-- Spacer to prevent content from going under fixed nav -->
<div class="h-16 sm:h-18 lg:h-20"></div>

<style>
  /* Custom height utilities for navigation */
  .h-16 {
    height: 4rem;
  }
  .h-18 {
    height: 4.5rem;
  }
  .h-20 {
    height: 5rem;
  }
  .top-16 {
    top: 4rem;
  }
  .top-18 {
    top: 4.5rem;
  }
  
  /* Mobile menu open state */
  #mobile-menu.open {
    transform: translateY(0);
    opacity: 1;
  }
  
  /* Dropdown open state */
  .dropdown-menu.open {
    opacity: 1;
    visibility: visible;
    transform: scale(1) translateY(0);
    pointer-events: auto;
  }
  
  /* Right-aligned dropdown */
  .dropdown-menu.dropdown-right-aligned {
    left: auto;
    right: 0;
  }
  
  .dropdown-arrow.open {
    transform: rotate(180deg);
  }
  
  .dropdown-toggle.active .nav-indicator {
    width: 80%;
  }
</style>

<script>
  // Utility: Debounce function for performance optimization
  function debounce<T extends (...args: any[]) => void>(
    func: T,
    wait: number
  ): (...args: Parameters<T>) => void {
    let timeout: ReturnType<typeof setTimeout> | null = null;
    return function(...args: Parameters<T>) {
      if (timeout) clearTimeout(timeout);
      timeout = setTimeout(() => func(...args), wait);
    };
  }

  // Mobile menu toggle with enhanced animations
  const btn = document.getElementById('mobile-menu-button');
  const menu = document.getElementById('mobile-menu');
  const menuOpen = document.querySelector('.menu-open');
  const menuClose = document.querySelector('.menu-close');

  const toggleMenu = () => {
    if (!menu || !menuOpen || !menuClose) return;
    
    const isOpen = menu.classList.contains('open');
    
    if (isOpen) {
      // Close menu
      menu.classList.remove('open');
      menu.classList.add('-translate-y-full', 'opacity-0');
      menu.classList.remove('translate-y-0', 'opacity-100');
      menuOpen.classList.remove('opacity-0');
      menuOpen.classList.add('opacity-100');
      menuClose.classList.add('opacity-0');
      menuClose.classList.remove('opacity-100');
      document.body.style.overflow = '';
    } else {
      // Open menu
      menu.classList.add('open');
      menu.classList.remove('-translate-y-full', 'opacity-0');
      menu.classList.add('translate-y-0', 'opacity-100');
      menuOpen.classList.add('opacity-0');
      menuOpen.classList.remove('opacity-100');
      menuClose.classList.remove('opacity-0');
      menuClose.classList.add('opacity-100');
      document.body.style.overflow = 'hidden';
    }
    
    btn?.setAttribute('aria-expanded', String(!isOpen));
  };

  // Mobile dropdown toggles with optimized animations
  // Ensure proper event handling with preventDefault and stopPropagation
  function setupMobileDropdowns() {
    const mobileDropdownButtons = document.querySelectorAll('#mobile-menu .mobile-dropdown-btn');
    
    mobileDropdownButtons.forEach(button => {
      // Check if already has listener to avoid duplicates
      if ((button as any).__dropdownHandlerAttached) return;
      
      const handler = (e: MouseEvent | TouchEvent) => {
        // Prevent any default behavior and stop event bubbling
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const content = (button as HTMLElement).nextElementSibling as HTMLElement;
        const icon = button.querySelector('svg');
        const isExpanded = button.getAttribute('aria-expanded') === 'true';
        
        if (content) {
          const isHidden = content.classList.contains('hidden');
          content.classList.toggle('hidden');
          icon?.classList.toggle('rotate-180');
          button.setAttribute('aria-expanded', String(!isExpanded));
          
          // Optimized height transition with better performance
          if (!isHidden) {
            content.style.maxHeight = '0';
            setTimeout(() => {
              content.style.maxHeight = '';
            }, 200);
          } else {
            // Measure first, then animate
            content.style.maxHeight = '0';
            requestAnimationFrame(() => {
              content.style.maxHeight = content.scrollHeight + 'px';
              setTimeout(() => {
                content.style.maxHeight = '';
              }, 200);
            });
          }
        }
      };

      // Attach with capture phase to ensure it runs first
      button.addEventListener('click', handler, { capture: true, passive: false });
      button.addEventListener('touchend', handler, { capture: true, passive: false });
      
      // Mark as attached to prevent duplicates
      (button as any).__dropdownHandlerAttached = true;
    });
  }

  btn?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleMenu();
    // Setup dropdowns after menu opens (small delay to ensure DOM is ready)
    setTimeout(setupMobileDropdowns, 50);
  });

  // Close mobile menu when clicking on any link
  const closeMobileMenu = () => {
    if (!menu || !menuOpen || !menuClose) return;
    
    menu.classList.remove('open');
    menu.classList.add('-translate-y-full', 'opacity-0');
    menu.classList.remove('translate-y-0', 'opacity-100');
    menuOpen.classList.remove('opacity-0');
    menuOpen.classList.add('opacity-100');
    menuClose.classList.add('opacity-0');
    menuClose.classList.remove('opacity-100');
    btn?.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';
  };

  // Add click listeners to all mobile menu links (but NOT dropdown buttons)
  const mobileLinks = document.querySelectorAll('#mobile-menu a');
  mobileLinks.forEach(link => {
    link.addEventListener('click', closeMobileMenu);
  });

  // Setup dropdowns on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupMobileDropdowns);
  } else {
    setupMobileDropdowns();
  }

  // Close mobile menu when clicking outside
  const handleOutsideClick = (e: Event) => {
    const target = e.target as HTMLElement;
    const nav = document.getElementById('main-navigation');
    
    if (nav && !nav.contains(target) && menu?.classList.contains('open')) {
      closeMobileMenu();
    }
  };

  document.addEventListener('click', handleOutsideClick);

  // Enhanced scroll behavior with smooth transitions
  const nav = document.getElementById('main-navigation');
  const SCROLL_THRESHOLD = 10;

  const handleScroll = () => {
    if (!nav) return;
    
    // Only update on desktop or if mobile menu is closed
    if (window.innerWidth >= 1024 || !menu?.classList.contains('open')) {
      const currentScroll = window.pageYOffset || document.documentElement.scrollTop;

      if (currentScroll > SCROLL_THRESHOLD) {
        nav.classList.add('shadow-2xl');
        nav.style.backdropFilter = 'blur(12px)';
      } else {
        nav.classList.remove('shadow-2xl');
        nav.style.backdropFilter = 'blur(8px)';
      }
    }
  };

  // Optimized scroll handler - use requestAnimationFrame for better performance
  let scrollRaf: number | null = null;
  const optimizedScroll = () => {
    if (scrollRaf) return;
    scrollRaf = requestAnimationFrame(() => {
      handleScroll();
      scrollRaf = null;
    });
  };
  window.addEventListener('scroll', optimizedScroll, { passive: true });

  // Desktop dropdown click handlers
  let openDropdown: HTMLElement | null = null;
  let dropdownLeaveTimer: ReturnType<typeof setTimeout> | null = null;

  const closeDropdown = (dropdown: HTMLElement) => {
    const menu = dropdown.querySelector('.dropdown-menu') as HTMLElement;
    const button = dropdown.querySelector('.dropdown-toggle') as HTMLElement;
    const arrow = dropdown.querySelector('.dropdown-arrow') as HTMLElement;
    
    if (menu && button && arrow) {
      menu.classList.remove('open');
      button.classList.remove('active');
      button.setAttribute('aria-expanded', 'false');
      arrow.classList.remove('open');
      openDropdown = null;
    }
  };

  const openDropdownMenu = (dropdown: HTMLElement) => {
    // Close any previously open dropdown
    if (openDropdown && openDropdown !== dropdown) {
      closeDropdown(openDropdown);
    }
    
    const menu = dropdown.querySelector('.dropdown-menu') as HTMLElement;
    const button = dropdown.querySelector('.dropdown-toggle') as HTMLElement;
    const arrow = dropdown.querySelector('.dropdown-arrow') as HTMLElement;
    const arrowPointer = menu?.querySelector('.dropdown-arrow-pointer') as HTMLElement;
    
    if (menu && button && arrow) {
      // First, make menu visible but off-screen to measure
      menu.style.position = 'absolute';
      menu.style.visibility = 'hidden';
      menu.style.display = 'block';
      menu.style.opacity = '1';
      menu.style.transform = 'scale(1)';
      
      // Get dimensions
      const buttonRect = button.getBoundingClientRect();
      const menuWidth = menu.offsetWidth;
      const viewportWidth = window.innerWidth;
      const padding = 16; // Padding from viewport edge
      
      // Reset styles
      menu.style.visibility = '';
      menu.style.display = '';
      menu.style.opacity = '';
      menu.style.transform = '';
      menu.style.left = '';
      menu.style.right = '';
      menu.classList.remove('dropdown-right-aligned');
      
      // Check if menu would overflow right side of viewport
      if (buttonRect.left + menuWidth > viewportWidth - padding) {
        // Align to right edge
        menu.classList.add('dropdown-right-aligned');
        if (arrowPointer) {
          // Adjust arrow position for right-aligned dropdown
          const buttonCenter = buttonRect.left + buttonRect.width / 2;
          const menuRight = viewportWidth - padding;
          const arrowOffset = buttonCenter - (menuRight - menuWidth);
          arrowPointer.style.left = `${Math.max(20, Math.min(arrowOffset, menuWidth - 20))}px`;
        }
      } else {
        // Default left alignment
        if (arrowPointer) {
          arrowPointer.style.left = '24px'; // Default position
        }
      }
      
      // Add open class for animation
      menu.classList.add('open');
      button.classList.add('active');
      button.setAttribute('aria-expanded', 'true');
      arrow.classList.add('open');
      openDropdown = dropdown;
    }
  };

  // Initialize dropdowns
  function initializeDropdowns() {
    // Handle dropdown toggle on click
    document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
      // Remove existing listener if any
      const newToggle = toggle.cloneNode(true);
      toggle.parentNode?.replaceChild(newToggle, toggle);
      
      newToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = (newToggle as HTMLElement).closest('.dropdown-container') as HTMLElement;
        if (!dropdown) return;
        
        const menu = dropdown.querySelector('.dropdown-menu') as HTMLElement;
        const isOpen = menu?.classList.contains('open');
        
        if (isOpen) {
          closeDropdown(dropdown);
        } else {
          openDropdownMenu(dropdown);
        }
      });
    });

    // Reinitialize dropdown containers for mouse events
    document.querySelectorAll('.dropdown-container').forEach(container => {
      const containerEl = container as HTMLElement;
      containerEl.addEventListener('mouseleave', () => {
        if (openDropdown === containerEl) {
          dropdownLeaveTimer = setTimeout(() => {
            closeDropdown(containerEl);
          }, 300);
        }
      });

      containerEl.addEventListener('mouseenter', () => {
        if (dropdownLeaveTimer) {
          clearTimeout(dropdownLeaveTimer);
          dropdownLeaveTimer = null;
        }
      });
    });
  }

  // Initialize dropdowns when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDropdowns);
  } else {
    initializeDropdowns();
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (openDropdown && !openDropdown.contains(target)) {
      closeDropdown(openDropdown);
    }
  });

  // Mouse leave handlers are now in initializeDropdowns function

  // Close dropdown on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && openDropdown) {
      closeDropdown(openDropdown);
    }
  });

  // Active link highlighting with path matching
  const updateActiveLinks = () => {
    const currentPath = window.location.pathname;
    const basePath = currentPath.replace(/\/$/, '') || '/';
    
    document.querySelectorAll('.nav-link').forEach(link => {
      const href = link.getAttribute('href');
      if (!href) return;
      
      // Normalize paths for comparison
      const linkPath = href.replace(/\/$/, '');
      const normalizedCurrentPath = currentPath.replace(/\/$/, '');
      
      // Check if current path matches
      if (normalizedCurrentPath === linkPath || 
          (normalizedCurrentPath.startsWith(linkPath) && linkPath !== '' && linkPath !== '/') ||
          currentPath === href) {
        link.classList.add('text-lime-400');
        const indicator = link.querySelector('.nav-indicator');
        if (indicator) {
          (indicator as HTMLElement).style.width = '80%';
        }
      }
    });
  };

  // Update active links on load and navigation
  updateActiveLinks();
  
  // Listen for Astro view transitions
  document.addEventListener('astro:page-load', updateActiveLinks);

  // Enhanced keyboard navigation
  document.addEventListener('keydown', (e) => {
    // Close mobile menu on Escape
    if (e.key === 'Escape' && menu?.classList.contains('open')) {
      closeMobileMenu();
    }
  });

  // Cleanup function for Astro view transitions
  document.addEventListener('astro:before-swap', () => {
    // Remove event listeners before page swap
    btn?.removeEventListener('click', toggleMenu);
    document.removeEventListener('click', handleOutsideClick);
    window.removeEventListener('scroll', optimizedScroll);
    if (scrollRaf) {
      cancelAnimationFrame(scrollRaf);
      scrollRaf = null;
    }
    
    // Clean up desktop dropdown handlers
    if (dropdownLeaveTimer) {
      clearTimeout(dropdownLeaveTimer);
      dropdownLeaveTimer = null;
    }
    
    // Clean up mobile menu link handlers
    mobileLinks.forEach(link => {
      link.removeEventListener('click', closeMobileMenu);
    });

    // Clean up mobile dropdown handlers
    mobileDropdownHandlers.forEach((handler, button) => {
      button.removeEventListener('click', handler);
    });
    mobileDropdownHandlers.clear();
    
    // Reset dropdown state
    openDropdown = null;
  });

  // Reinitialize dropdowns on page load (for Astro view transitions)
  document.addEventListener('astro:page-load', initializeDropdowns);

  // Initialize on load
  handleScroll();
</script>
