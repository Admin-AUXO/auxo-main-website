---
import { getCollection, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Breadcrumbs } from "astro-breadcrumbs";
import { SocialShare } from "astro-social-share";
import PageContainer from "../../components/layouts/PageContainer.astro";
import ContentWrapper from "../../components/layouts/ContentWrapper.astro";
import { Icon } from "astro-icon/components";
import { calculateReadTime } from "../../utils/content";
import { formatDateLong } from "../../utils/date";
import { generateBlogBreadcrumbs } from "../../utils/breadcrumbs";

const base = import.meta.env.BASE_URL;

// Generate static paths for all blog posts
export async function getStaticPaths() {
  try {
    // Get all blog posts that are not drafts
    const posts = await getCollection("blog", ({ data }) => {
      return data.draft !== true;
    });

    // If no posts exist, return empty array
    if (!posts || posts.length === 0) {
      if (import.meta.env.DEV) {
        console.warn("No blog posts found");
      }
      return [];
    }

    if (import.meta.env.DEV) {
      console.log(`Generating ${posts.length} blog post pages`);
    }

    return posts
      .map((post) => {
        if (!post.id) {
          if (import.meta.env.DEV) {
            console.error("Post missing id:", post);
          }
          return null;
        }

        // Use id instead of slug for better compatibility
        const slug = post.id.replace(/\.mdx?$/, "");

        return {
          params: { slug },
          props: { post },
        };
      })
      .filter(Boolean);
  } catch (error) {
    if (import.meta.env.DEV) {
      console.error("Error fetching blog posts:", error);
    }
    return [];
  }
}

const { post } = Astro.props;

// If post doesn't exist, this will be handled by Astro's 404 page
if (!post) {
  return Astro.redirect("/404");
}

// Render the post content using the render function from astro:content
const { Content } = await render(post);

// Generate formatted breadcrumbs
const breadcrumbItems = generateBlogBreadcrumbs(
  Astro.url.pathname,
  post.data.title
);
---

<BaseLayout
  title={`${post.data.title} | AUXO Data Labs Blog`}
  description={post.data.description}
  article={true}
  publishedTime={post.data.publishDate.toISOString()}
  author="AUXO Data Labs"
  tags={post.data.tags}
>
  <PageContainer maxWidth="4xl" paddingTop="pt-24" paddingBottom="pb-16">
    <article>
      <!-- Breadcrumb with Structured Data -->
      <ContentWrapper maxWidth="4xl" class="mb-8">
        <Breadcrumbs 
          class="text-sm breadcrumb-theme" 
          separator="chevron"
          crumbs={breadcrumbItems}
        />
      </ContentWrapper>

      <!-- Article Header -->
      <ContentWrapper maxWidth="4xl" class="mb-10 sm:mb-12">
        <!-- Tags -->
        {
          post.data.tags && post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4 sm:mb-6">
              {post.data.tags.map((tag: string) => (
                <span class="px-2.5 sm:px-3 py-1 sm:py-1.5 bg-accent-green/10 text-accent-green transition-colors text-xs sm:text-sm rounded-full border border-accent-green/20 font-medium">
                  #{tag}
                </span>
              ))}
            </div>
          )
        }

        <!-- Title -->
        <h1
          class="text-3xl sm:text-4xl md:text-5xl font-bold mb-4 sm:mb-6 leading-tight"
        >
          {post.data.title}
        </h1>

        <!-- Meta Information -->
        <div
          class="flex flex-wrap items-center gap-3 sm:gap-4 text-secondary transition-colors text-xs sm:text-sm border-l-4 border-accent-green pl-3 sm:pl-4 py-2 sm:py-2 bg-accent-green/5 rounded-r-lg"
        >
          <div class="flex items-center gap-2">
            <Icon
              name="mdi:calendar"
              class="w-5 h-5 text-accent-green transition-colors"
            />
            <span>{formatDateLong(post.data.publishDate)}</span>
          </div>
          <span class="text-tertiary transition-colors">•</span>
          <div class="flex items-center gap-2">
            <Icon
              name="mdi:account"
              class="w-5 h-5 text-accent-green transition-colors"
            />
            <span>{post.data.author}</span>
          </div>
          <span class="text-tertiary transition-colors">•</span>
          <div class="flex items-center gap-2">
            <Icon
              name="mdi:clock"
              class="w-5 h-5 text-accent-green transition-colors"
            />
            <span>{calculateReadTime(post.body)} min read</span>
          </div>
        </div>

        <!-- Description -->
        <p
          class="text-lg sm:text-xl text-secondary transition-colors mt-4 sm:mt-6 leading-relaxed"
        >
          {post.data.description}
        </p>
      </ContentWrapper>

      <!-- Featured Image (if available) -->
      {
        post.data.image && (
          <ContentWrapper maxWidth="4xl" class="mb-10 sm:mb-12">
            <figure class="my-0">
              <img
                src={post.data.image}
                alt={post.data.title}
                class="w-full rounded-xl border border-theme shadow-2xl object-cover"
                loading="eager"
                decoding="async"
              />
            </figure>
          </ContentWrapper>
        )
      }

      <!-- Article Content -->
      <ContentWrapper maxWidth="4xl">
        <div
          class="prose prose-sm sm:prose-base md:prose-lg max-w-none
          prose-headings:text-primary prose-headings:font-bold
          prose-h1:text-3xl sm:prose-h1:text-4xl md:prose-h1:text-5xl prose-h1:mb-6 prose-h1:mt-0
          prose-h2:text-2xl sm:prose-h2:text-3xl md:prose-h2:text-4xl prose-h2:mt-10 sm:prose-h2:mt-12 prose-h2:mb-5 sm:prose-h2:mb-6 prose-h2:text-primary prose-h2:font-bold prose-h2:leading-tight
          prose-h3:text-xl sm:prose-h3:text-2xl md:prose-h3:text-3xl prose-h3:mt-8 sm:prose-h3:mt-10 prose-h3:mb-3 sm:prose-h3:mb-4 prose-h3:text-primary prose-h3:font-semibold
          prose-h4:text-lg sm:prose-h4:text-xl prose-h4:mt-6 sm:prose-h4:mt-8 prose-h4:mb-3 prose-h4:text-secondary
          prose-p:text-secondary prose-p:leading-relaxed prose-p:mb-5 sm:prose-p:mb-6 prose-p:text-sm sm:prose-p:text-base prose-p:font-normal
          prose-a:text-primary prose-a:no-underline hover:prose-a:text-accent-green hover:prose-a:underline prose-a:font-medium prose-a:transition-colors
          prose-strong:text-primary prose-strong:font-semibold
          prose-ul:text-secondary prose-ul:my-5 sm:prose-ul:my-6 prose-ul:space-y-2
          prose-ol:text-secondary prose-ol:my-5 sm:prose-ol:my-6 prose-ol:space-y-2
          prose-li:my-2 prose-li:text-sm sm:prose-li:text-base prose-li:leading-relaxed
          prose-li::marker:text-primary
          prose-code:text-primary prose-code:bg-card/80 prose-code:px-2 prose-code:py-1 prose-code:rounded prose-code:text-xs sm:prose-code:text-sm prose-code:font-mono prose-code:before:content-none prose-code:after:content-none
          prose-pre:bg-card prose-pre:border prose-pre:border-theme prose-pre:rounded-xl prose-pre:shadow-lg prose-pre:text-xs sm:prose-pre:text-sm prose-pre:overflow-x-auto
          prose-pre code:text-secondary prose-pre code:bg-transparent prose-pre code:p-0
          prose-blockquote:border-l-4 prose-blockquote:border-accent-green prose-blockquote:bg-accent-green/5 prose-blockquote:pl-4 sm:prose-blockquote:pl-6 prose-blockquote:pr-4 sm:prose-blockquote:pr-6 prose-blockquote:py-4 prose-blockquote:my-6 sm:prose-blockquote:my-8 prose-blockquote:rounded-r-lg prose-blockquote:not-italic
          prose-blockquote p:text-secondary prose-blockquote p:mb-0
          prose-img:rounded-xl prose-img:border prose-img:border-theme prose-img:my-6 sm:prose-img:my-8 prose-img:shadow-xl prose-img:w-full prose-img:h-auto
          prose-hr:border-theme prose-hr:my-8 sm:prose-hr:my-12
          prose-table:w-full prose-table:my-6 sm:prose-table:my-8
          prose-thead:border-b prose-thead:border-theme
          prose-th:bg-card prose-th:text-primary prose-th:font-semibold prose-th:p-3 sm:prose-th:p-4 prose-th:text-left prose-th:text-sm sm:prose-th:text-base
          prose-td:border-b prose-td:border-theme prose-td:p-3 sm:prose-td:p-4 prose-td:text-secondary prose-td:text-sm sm:prose-td:text-base
          prose-tr:hover:bg-card/50 prose-tr:transition-colors"
        >
          <Content />
        </div>

        <!-- Social Share Buttons -->
        <div class="mt-10 sm:mt-12 pt-6 sm:pt-8 border-t border-theme">
          <div
            class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"
          >
            <div class="w-full sm:w-auto">
              <p
                class="text-xs sm:text-sm font-semibold text-primary transition-colors mb-3 sm:mb-2"
              >
                Share this article:
              </p>
              {/* @ts-expect-error - platforms prop is supported by astro-social-share but not in types */}
              <SocialShare
                description={post.data.description}
                title={post.data.title}
                url={`${Astro.site || "https://auxodata.com"}${base}blog/${post.id.replace(/\.mdx?$/, "")}/`}
                platforms={["twitter", "linkedin", "facebook", "reddit"]}
              />
            </div>
          </div>
        </div>
      </ContentWrapper>

      <!-- Call to Action -->
      <ContentWrapper maxWidth="4xl" class="mt-12 sm:mt-16">
        <div
          class="bg-gradient-to-r from-accent-green/10 to-accent-green/20 border-2 border-accent-green/20 rounded-2xl p-6 sm:p-8 md:p-12 text-center"
        >
          <h2 class="text-2xl sm:text-3xl font-bold mb-3 sm:mb-4">
            Ready to Transform Your Data?
          </h2>
          <p
            class="text-sm sm:text-base text-secondary transition-colors mb-6 sm:mb-8 max-w-2xl mx-auto leading-relaxed"
          >
            Let's discuss how AUXO Data Labs can help your business leverage
            data analytics and business intelligence.
          </p>
          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
            <a
              href={`${base}contact/`}
              class="px-6 sm:px-8 py-3 sm:py-4 bg-accent-green font-bold rounded-lg hover:bg-accent-green/90 active:bg-accent-green/80 transition-all transform hover:scale-105 active:scale-95 inline-flex items-center justify-center gap-2 text-sm sm:text-base min-h-[44px] touch-manipulation"
            >
              <Icon name="mdi:email" class="w-4 h-4 sm:w-5 sm:h-5" />
              Get In Touch
            </a>
            <a
              href={`${base}services/`}
              class="px-6 sm:px-8 py-3 sm:py-4 bg-surface text-primary font-bold rounded-lg hover:bg-surface/80 active:bg-surface/70 transition-all transform hover:scale-105 active:scale-95 inline-flex items-center justify-center gap-2 text-sm sm:text-base min-h-[44px] touch-manipulation"
            >
              <Icon name="mdi:briefcase" class="w-4 h-4 sm:w-5 sm:h-5" />
              View Our Services
            </a>
          </div>
        </div>
      </ContentWrapper>

      <!-- Back to Blog -->
      <ContentWrapper maxWidth="4xl" class="mt-10 sm:mt-12 text-center">
        <a
          href={`${base}blog/`}
          class="inline-flex items-center gap-2 text-accent-green transition-colors hover:text-accent-green/80 active:text-accent-green/70 transition-colors font-semibold text-sm sm:text-base py-2 touch-manipulation min-h-[44px] justify-center"
        >
          <Icon name="mdi:arrow-left" class="w-4 h-4 sm:w-5 sm:h-5" />
          Back to All Posts
        </a>
      </ContentWrapper>
    </article>
  </PageContainer>
</BaseLayout>

<style>
  /* Enhanced code block styling - Theme-aware */
  .prose pre {
    background: var(--bg-card) !important;
    border: 1px solid var(--border-color) !important;
    padding: 1.25rem 1.5rem;
    overflow-x: auto;
    position: relative;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .prose pre code {
    background: transparent !important;
    padding: 0 !important;
    border-radius: 0;
    font-size: 0.875rem;
    line-height: 1.75;
    color: var(--text-secondary) !important;
    display: block;
    width: 100%;
  }

  /* Plaintext code blocks - Theme-aware */
  .prose pre code[class="language-plaintext"],
  .prose pre code[class*="plaintext"] {
    color: var(--text-secondary) !important;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Code block wrapper for copy functionality */
  .prose pre::before {
    content: "";
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    width: 1rem;
    height: 1rem;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23a3e635'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z' /%3E%3C/svg%3E")
      no-repeat center;
    opacity: 0.5;
    cursor: pointer;
  }

  /* Responsive tables */
  @media (max-width: 768px) {
    .prose table {
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .prose table thead {
      display: none;
    }

    .prose table tbody {
      display: block;
      width: 100%;
    }

    .prose table tr {
      display: block;
      margin-bottom: 1rem;
      border: 1px solid var(--border-color) !important;
      border-radius: 0.5rem;
      padding: 0.75rem;
      background: var(--bg-card) !important;
    }

    .prose table td {
      display: block;
      text-align: right;
      padding: 0.5rem 0;
      border: none;
      border-bottom: 1px solid var(--border-color) !important;
    }

    .prose table td:last-child {
      border-bottom: none;
    }

    .prose table td::before {
      content: attr(data-label) ": ";
      float: left;
      font-weight: 600;
      color: var(--accent-green) !important;
    }
  }

  /* Better code inline styling - Theme-aware */
  .prose code:not(pre code) {
    background: rgba(var(--accent-green-rgb), 0.1) !important;
    border: 1px solid rgba(var(--accent-green-rgb), 0.2) !important;
  }

  /* Enhanced blockquote */
  .prose blockquote {
    border-left-width: 4px;
  }

  .prose blockquote p:first-child {
    margin-top: 0;
  }

  .prose blockquote p:last-child {
    margin-bottom: 0;
  }

  /* Better list spacing */
  .prose ul > li,
  .prose ol > li {
    padding-left: 0.5rem;
  }

  /* Nested lists */
  .prose ul ul,
  .prose ol ol,
  .prose ul ol,
  .prose ol ul {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  /* Improved image rendering */
  .prose img {
    max-width: 100%;
    height: auto;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  /* Shiki theme adjustments for better contrast - Theme-aware */
  .prose pre[class*="language-"] {
    background: var(--bg-card) !important;
  }

  /* Ensure proper text selection - Theme-aware */
  .prose *::selection {
    background: rgba(var(--accent-green-rgb), 0.3) !important;
  }
</style>
