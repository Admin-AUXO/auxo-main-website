---
// Cookie Consent Banner Component for GDPR/UAE PDPL Compliance
import { cookieConsentContent } from "../data/content/cookies";

const base = import.meta.env.BASE_URL;
---

<div
  id="cookie-consent"
  class="hidden fixed bottom-0 left-0 right-0 z-[100] bg-card/98 border-t border-theme backdrop-blur-lg transition-colors"
>
  <div class="container mx-auto px-4 py-6">
    <div
      class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4"
    >
      <div class="flex-1">
        <div class="flex items-start gap-3">
            <svg
              class="w-6 h-6 text-accent-green flex-shrink-0 mt-0.5 transition-colors"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <div>
            <h3 class="font-bold text-primary mb-1 transition-colors">
              {cookieConsentContent.banner.title}
            </h3>
            <p class="text-sm text-secondary leading-relaxed max-w-3xl transition-colors">
              {cookieConsentContent.banner.description}
              <a
                href={`${base}${cookieConsentContent.banner.privacyPolicyHref}`}
                class="text-accent-green hover:underline ml-1 transition-colors"
                >{cookieConsentContent.banner.learnMore}</a
              >
            </p>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap gap-3">
        <button
          id="cookie-settings-btn"
          class="px-4 py-2 text-sm font-medium text-primary bg-surface border border-theme rounded-lg hover:bg-accent-green/10 hover:border-accent-green/30 transition-all focus:outline-none focus:ring-2 focus:ring-accent-green/50 min-h-[44px]"
        >
          {cookieConsentContent.banner.customize}
        </button>
        <button
          id="cookie-reject-btn"
          class="px-4 py-2 text-sm font-medium text-primary bg-surface border border-theme rounded-lg hover:bg-accent-green/10 hover:border-accent-green/30 transition-all focus:outline-none focus:ring-2 focus:ring-accent-green/50 min-h-[44px]"
        >
          {cookieConsentContent.banner.rejectOptional}
        </button>
        <button
          id="cookie-accept-btn"
          class="px-6 py-2 text-sm font-bold text-on-accent bg-accent-green rounded-lg hover:bg-accent-green/90 transition-all focus:outline-none focus:ring-2 focus:ring-accent-green/50 min-h-[44px]"
        >
          {cookieConsentContent.banner.acceptAll}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Cookie Settings Modal -->
<div
  id="cookie-settings-modal"
  class="hidden fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm"
>
  <div class="flex items-center justify-center min-h-screen p-4">
    <div
      class="bg-card border border-theme rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl transition-colors"
    >
      <div class="p-6 border-b border-theme">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-primary transition-colors">
            {cookieConsentContent.modal.title}
          </h2>
          <button
            id="cookie-modal-close"
            class="text-secondary hover:text-primary transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center"
            aria-label="Close modal"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="p-6 space-y-6">
        <!-- Essential Cookies -->
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold text-primary transition-colors">
                {cookieConsentContent.modal.essential.title}
              </h3>
              <p class="text-sm text-secondary transition-colors">
                {cookieConsentContent.modal.essential.description}
              </p>
            </div>
            <div class="px-3 py-1 bg-surface rounded-full">
              <span class="text-xs font-medium text-secondary transition-colors"
                >{cookieConsentContent.modal.essential.alwaysActive}</span
              >
            </div>
          </div>
          <p class="text-sm text-secondary transition-colors">
            {cookieConsentContent.modal.essential.details}
          </p>
        </div>

        <!-- Analytics Cookies -->
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold text-primary transition-colors">
                {cookieConsentContent.modal.analytics.title}
              </h3>
              <p class="text-sm text-secondary transition-colors">
                {cookieConsentContent.modal.analytics.description}
              </p>
            </div>
            <label
              for="cookie-analytics"
              class="relative inline-flex items-center cursor-pointer"
              aria-label="Toggle analytics cookies"
            >
              <input
                type="checkbox"
                id="cookie-analytics"
                class="sr-only peer"
              />
              <div
                class="w-11 h-6 bg-surface border border-theme peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent-green/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-green"
              >
              </div>
            </label>
          </div>
          <p class="text-sm text-secondary transition-colors">
            {cookieConsentContent.modal.analytics.details}
          </p>
        </div>

        <!-- Marketing Cookies -->
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold text-primary transition-colors">
                {cookieConsentContent.modal.marketing.title}
              </h3>
              <p class="text-sm text-secondary transition-colors">
                {cookieConsentContent.modal.marketing.description}
              </p>
            </div>
            <label
              for="cookie-marketing"
              class="relative inline-flex items-center cursor-pointer"
              aria-label="Toggle marketing cookies"
            >
              <input
                type="checkbox"
                id="cookie-marketing"
                class="sr-only peer"
              />
              <div
                class="w-11 h-6 bg-surface border border-theme peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent-green/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-green"
              >
              </div>
            </label>
          </div>
          <p class="text-sm text-secondary transition-colors">
            {cookieConsentContent.modal.marketing.details}
          </p>
        </div>
      </div>

      <div class="p-6 border-t border-theme flex flex-col sm:flex-row gap-3">
        <button
          id="cookie-save-settings"
          class="flex-1 px-6 py-3 text-sm font-bold text-on-accent bg-accent-green rounded-lg hover:bg-accent-green/90 transition-all focus:outline-none focus:ring-2 focus:ring-accent-green/50 min-h-[44px]"
        >
          {cookieConsentContent.modal.savePreferences}
        </button>
        <button
          id="cookie-accept-all-modal"
          class="flex-1 px-6 py-3 text-sm font-medium text-primary bg-surface border border-theme rounded-lg hover:bg-accent-green/10 hover:border-accent-green/30 transition-all focus:outline-none focus:ring-2 focus:ring-accent-green/50 min-h-[44px]"
        >
          {cookieConsentContent.modal.acceptAll}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Cookie Consent Management
  const COOKIE_CONSENT_KEY = "auxo-cookie-consent";
  const COOKIE_EXPIRY_DAYS = 365;

  interface CookieConsent {
    essential: boolean;
    analytics: boolean;
    marketing: boolean;
    timestamp: string;
  }

  // Check if consent already given
  function hasConsent(): boolean {
    return localStorage.getItem(COOKIE_CONSENT_KEY) !== null;
  }

  // Get current consent
  function getConsent(): CookieConsent | null {
    const stored = localStorage.getItem(COOKIE_CONSENT_KEY);
    if (!stored) return null;

    try {
      return JSON.parse(stored);
    } catch {
      // Clear corrupted data
      localStorage.removeItem(COOKIE_CONSENT_KEY);
      return null;
    }
  }

  // Save consent
  function saveConsent(consent: CookieConsent): void {
    localStorage.setItem(COOKIE_CONSENT_KEY, JSON.stringify(consent));

    // Set cookie for server-side detection
    document.cookie = `cookie_consent=true; max-age=${COOKIE_EXPIRY_DAYS * 24 * 60 * 60}; path=/; SameSite=Lax`;

    // Initialize services based on consent
    initializeServices(consent);
  }

  // Initialize third-party services
  function initializeServices(consent: CookieConsent): void {
    if (consent.analytics) {
      // TODO: Initialize Google Analytics when configured
      // gtag('consent', 'update', { 'analytics_storage': 'granted' });
    }

    if (consent.marketing) {
      // TODO: Initialize marketing pixels when configured
    }
  }

  // Show/hide banner
  const banner = document.getElementById("cookie-consent");
  const modal = document.getElementById("cookie-settings-modal");

  if (!hasConsent() && banner) {
    banner.classList.remove("hidden");
  } else {
    // Apply saved consent
    const consent = getConsent();
    if (consent) {
      initializeServices(consent);
    }
  }

  // Accept all cookies
  function acceptAll(): void {
    const consent: CookieConsent = {
      essential: true,
      analytics: true,
      marketing: true,
      timestamp: new Date().toISOString(),
    };
    saveConsent(consent);
    banner?.classList.add("hidden");
    modal?.classList.add("hidden");
  }

  // Reject optional cookies
  function rejectOptional(): void {
    const consent: CookieConsent = {
      essential: true,
      analytics: false,
      marketing: false,
      timestamp: new Date().toISOString(),
    };
    saveConsent(consent);
    banner?.classList.add("hidden");
  }

  // Show settings modal
  function showSettings(): void {
    const consent = getConsent();
    if (consent) {
      // Restore previous settings
      const analyticsCheckbox = document.getElementById(
        "cookie-analytics",
      ) as HTMLInputElement;
      const marketingCheckbox = document.getElementById(
        "cookie-marketing",
      ) as HTMLInputElement;

      if (analyticsCheckbox) analyticsCheckbox.checked = consent.analytics;
      if (marketingCheckbox) marketingCheckbox.checked = consent.marketing;
    }

    modal?.classList.remove("hidden");
  }

  // Save custom settings
  function saveSettings(): void {
    const analyticsCheckbox = document.getElementById(
      "cookie-analytics",
    ) as HTMLInputElement;
    const marketingCheckbox = document.getElementById(
      "cookie-marketing",
    ) as HTMLInputElement;

    const consent: CookieConsent = {
      essential: true,
      analytics: analyticsCheckbox?.checked || false,
      marketing: marketingCheckbox?.checked || false,
      timestamp: new Date().toISOString(),
    };

    saveConsent(consent);
    banner?.classList.add("hidden");
    modal?.classList.add("hidden");
  }

  // Event handlers with cleanup
  const closeModal = () => modal?.classList.add("hidden");
  const handleEscape = (e: KeyboardEvent) => {
    if (e.key === "Escape" && modal && !modal.classList.contains("hidden")) {
      modal.classList.add("hidden");
    }
  };

  // Event listeners
  const acceptBtn = document.getElementById("cookie-accept-btn");
  const rejectBtn = document.getElementById("cookie-reject-btn");
  const settingsBtn = document.getElementById("cookie-settings-btn");
  const modalClose = document.getElementById("cookie-modal-close");
  const saveSettingsBtn = document.getElementById("cookie-save-settings");
  const acceptAllModalBtn = document.getElementById("cookie-accept-all-modal");

  acceptBtn?.addEventListener("click", acceptAll);
  rejectBtn?.addEventListener("click", rejectOptional);
  settingsBtn?.addEventListener("click", showSettings);
  modalClose?.addEventListener("click", closeModal);
  saveSettingsBtn?.addEventListener("click", saveSettings);
  acceptAllModalBtn?.addEventListener("click", acceptAll);
  document.addEventListener("keydown", handleEscape);

  // Cleanup function for Astro view transitions
  document.addEventListener("astro:before-swap", () => {
    acceptBtn?.removeEventListener("click", acceptAll);
    rejectBtn?.removeEventListener("click", rejectOptional);
    settingsBtn?.removeEventListener("click", showSettings);
    modalClose?.removeEventListener("click", closeModal);
    saveSettingsBtn?.removeEventListener("click", saveSettings);
    acceptAllModalBtn?.removeEventListener("click", acceptAll);
    document.removeEventListener("keydown", handleEscape);
  });
</script>

<style>
  /* Smooth animations */
  #cookie-consent {
    animation: slideUp 0.3s ease-out;
  }

  @keyframes slideUp {
    from {
      transform: translateY(100%);
    }
    to {
      transform: translateY(0);
    }
  }

  #cookie-settings-modal {
    animation: fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>
