---
import { Icon } from "astro-icon/components";

interface Props {
  isMobileSwitch?: boolean;
}

const { isMobileSwitch = false } = Astro.props;
---

<button
  id="theme-toggle"
  type="button"
  class:list={[
    "theme-toggle relative transition-all duration-200 flex items-center justify-center active:scale-95",
    isMobileSwitch
      ? "theme-toggle-switch w-12 h-6 rounded-full bg-surface border border-theme flex-shrink-0"
      : "w-10 h-10 rounded-lg bg-surface border border-theme text-secondary hover:text-accent-green hover:bg-accent-green/10 hover:border-accent-green/30 min-w-[44px] min-h-[44px]",
  ]}
  style={!isMobileSwitch
    ? "color: var(--text-secondary) !important;"
    : undefined}
  aria-label="Toggle theme"
  title="Toggle dark/light mode"
  data-mobile-switch={isMobileSwitch}
>
  {
    isMobileSwitch ? (
      <div class="theme-switch-track relative w-full h-full rounded-full bg-surface overflow-hidden">
        <div class="theme-switch-bg absolute inset-0 transition-colors duration-300" />
        <div class="theme-switch-knob absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-primary border border-theme shadow-md transition-transform duration-300 flex items-center justify-center">
          <Icon
            name="mdi:moon-waning-crescent"
            class="theme-icon-dark absolute w-3 h-3 transition-all duration-300 opacity-100"
            style="color: var(--text-secondary) !important;"
          />
          <Icon
            name="mdi:white-balance-sunny"
            class="theme-icon-light absolute w-3 h-3 transition-all duration-300 opacity-0"
            style="color: var(--text-secondary) !important;"
          />
        </div>
      </div>
    ) : (
      <div class="relative w-full h-full flex items-center justify-center">
        <Icon
          name="mdi:moon-waning-crescent"
          class="theme-icon-dark absolute w-5 h-5 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 transition-all duration-300 opacity-100 rotate-0 scale-100"
          style="color: var(--text-secondary) !important;"
        />
        <Icon
          name="mdi:white-balance-sunny"
          class="theme-icon-light absolute w-5 h-5 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 transition-all duration-300 opacity-0 rotate-90 scale-0"
          style="color: var(--text-secondary) !important;"
        />
      </div>
    )
  }
</button>

<script>
  (function initThemeToggle() {
    const themeToggle = document.getElementById("theme-toggle");
    if (!themeToggle) return;

    // Get theme from localStorage or default to 'dark'
    const getTheme = (): "light" | "dark" => {
      if (typeof window === "undefined") return "dark";
      const stored = localStorage.getItem("theme") as "light" | "dark" | null;
      if (stored) return stored;

      // Check system preference
      if (window.matchMedia("(prefers-color-scheme: light)").matches) {
        return "light";
      }
      return "dark";
    };

    // Apply theme to document - synchronous and immediate
    const applyTheme = (theme: "light" | "dark") => {
      const root = document.documentElement;
      // Remove both classes first, then add the correct one - prevents flicker
      root.classList.remove("dark", "light");
      root.classList.add(theme);
      localStorage.setItem("theme", theme);
      // Update icon immediately, synchronously
      updateIcon(theme);
    };

    // Update icon and switch based on theme - synchronous and immediate
    const updateIcon = (theme: "light" | "dark") => {
      // Get fresh reference to theme toggle (important after view transitions)
      const currentToggle = document.getElementById("theme-toggle");
      if (!currentToggle) return;

      const isMobileSwitch =
        currentToggle.getAttribute("data-mobile-switch") === "true";
      const darkIcon = currentToggle.querySelector(".theme-icon-dark");
      const lightIcon = currentToggle.querySelector(".theme-icon-light");
      const switchKnob = currentToggle.querySelector(".theme-switch-knob");
      const switchBg = currentToggle.querySelector(".theme-switch-bg");

      if (isMobileSwitch && switchKnob) {
        // Update switch position using inline style for immediate, precise control
        if (theme === "dark") {
          (switchKnob as HTMLElement).style.transform = "translateX(0)";
          if (switchBg) {
            switchBg.classList.remove("bg-accent-green/20");
            switchBg.classList.add("bg-surface");
          }
        } else {
          // Calculate: button width (3rem/48px) - knob width (1.25rem/20px) - padding (0.125rem/2px)
          (switchKnob as HTMLElement).style.transform =
            "translateX(calc(3rem - 1.25rem - 0.125rem))";
          if (switchBg) {
            switchBg.classList.remove("bg-surface");
            switchBg.classList.add("bg-accent-green/20");
          }
        }

        // Update icons in switch (for mobile switch style) - synchronous
        if (darkIcon && lightIcon) {
          if (theme === "dark") {
            darkIcon.classList.remove("opacity-0");
            darkIcon.classList.add("opacity-100");
            lightIcon.classList.remove("opacity-100");
            lightIcon.classList.add("opacity-0");
          } else {
            darkIcon.classList.remove("opacity-100");
            darkIcon.classList.add("opacity-0");
            lightIcon.classList.remove("opacity-0");
            lightIcon.classList.add("opacity-100");
          }
        }
      } else if (darkIcon && lightIcon) {
        // Update icons for desktop button style - synchronous
        if (theme === "dark") {
          darkIcon.classList.remove("opacity-0", "rotate-90", "scale-0");
          darkIcon.classList.add("opacity-100", "rotate-0", "scale-100");
          lightIcon.classList.remove("opacity-100", "rotate-0", "scale-100");
          lightIcon.classList.add("opacity-0", "rotate-90", "scale-0");
        } else {
          darkIcon.classList.remove("opacity-100", "rotate-0", "scale-100");
          darkIcon.classList.add("opacity-0", "rotate-90", "scale-0");
          lightIcon.classList.remove("opacity-0", "rotate-90", "scale-0");
          lightIcon.classList.add("opacity-100", "rotate-0", "scale-100");
        }
      }
    };

    // Toggle theme - immediate and synchronous
    const toggleTheme = (e?: Event) => {
      // Prevent any default behavior or propagation issues
      if (e) {
        e.stopPropagation();
      }

      const currentTheme = getTheme();
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      // Apply theme immediately - no delays
      applyTheme(newTheme);

      // Dispatch custom event for navigation to listen to (async, doesn't block)
      requestAnimationFrame(() => {
        document.dispatchEvent(
          new CustomEvent("themechange", {
            detail: { theme: newTheme, duration: 300 },
          }),
        );
      });
    };

    // Initialize theme on load
    const initTheme = () => {
      const theme = getTheme();
      applyTheme(theme);
    };

    // Set up event listeners with proper mobile support
    const handleThemeToggle = (e: Event) => {
      e.stopPropagation(); // Prevent event bubbling
      toggleTheme(e);
    };

    // Use both click and touchend for better mobile support
    // Handle all theme toggles (desktop and mobile) on initial load
    const allToggles = document.querySelectorAll("#theme-toggle");
    allToggles.forEach((toggle) => {
      toggle.addEventListener("click", handleThemeToggle, {
        passive: false,
      });
      toggle.addEventListener("touchend", handleThemeToggle, {
        passive: false,
      });
    });

    // Initialize on page load
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initTheme);
    } else {
      initTheme();
    }

    // Listen for system theme changes
    if (typeof window !== "undefined") {
      window
        .matchMedia("(prefers-color-scheme: light)")
        .addEventListener("change", (e) => {
          // Only auto-switch if user hasn't manually set a preference
          if (!localStorage.getItem("theme")) {
            applyTheme(e.matches ? "light" : "dark");
          }
        });
    }

    // Re-initialize on Astro view transitions - use requestAnimationFrame for immediate execution
    document.addEventListener("astro:page-load", () => {
      // Use requestAnimationFrame to ensure DOM is ready but execute immediately on next frame
      requestAnimationFrame(() => {
        // Get fresh reference to ALL theme toggles (there might be multiple - desktop and mobile)
        const currentToggles = document.querySelectorAll("#theme-toggle");
        if (currentToggles.length > 0) {
          // Re-apply theme to ensure consistency across page transitions
          const theme = getTheme();
          applyTheme(theme);

          // Re-attach event listeners to all theme toggle buttons with mobile support
          const handleThemeToggle = (e: Event) => {
            e.stopPropagation();
            toggleTheme(e);
          };
          
          currentToggles.forEach((toggle) => {
            // Remove old listeners by cloning the element
            const newToggle = toggle.cloneNode(true);
            toggle.parentNode?.replaceChild(newToggle, toggle);
            
            // Re-attach listeners to the new element
            newToggle.addEventListener("click", handleThemeToggle, {
              passive: false,
            });
            newToggle.addEventListener("touchend", handleThemeToggle, {
              passive: false,
            });
          });
        }
      });
    });

    // Also update on initial page load using requestAnimationFrame for immediate execution
    requestAnimationFrame(() => {
      const currentToggles = document.querySelectorAll("#theme-toggle");
      if (currentToggles.length > 0) {
        const theme = getTheme();
        // updateIcon will handle all toggles since it queries fresh
        updateIcon(theme);
      }
    });

    // Cleanup on Astro view transitions (optional - not strictly needed with replaceWith approach)
    document.addEventListener("astro:before-swap", () => {
      // Event listeners will be automatically removed when DOM is swapped
      // No manual cleanup needed
    });
  })();
</script>

<style>
  .theme-toggle {
    position: relative;
    overflow: hidden;
    /* Ensure theme toggle uses text-secondary, not text-on-accent */
    color: var(--text-secondary) !important;
  }

  .theme-toggle:hover {
    color: var(--accent-green) !important;
  }

  .theme-icon-dark,
  .theme-icon-light {
    transition:
      opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    /* Ensure icons use text-secondary, not text-on-accent */
    color: var(--text-secondary) !important;
  }

  .theme-toggle:hover .theme-icon-dark,
  .theme-toggle:hover .theme-icon-light {
    color: var(--accent-green) !important;
  }

  /* Switch style for mobile */
  .theme-toggle-switch {
    padding: 0;
  }

  .theme-switch-track {
    position: relative;
  }

  .theme-switch-bg {
    background-color: var(--bg-surface);
    transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .theme-switch-knob {
    transform: translateX(0);
    z-index: 1;
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Dark theme - knob on left (default position) */
  :root.dark .theme-switch-knob,
  :root:not(.light) .theme-switch-knob {
    transform: translateX(0);
  }

  /* Light theme - knob on right */
  :root.light .theme-switch-knob {
    transform: translateX(calc(3rem - 1.25rem - 0.125rem));
  }

  .theme-toggle-switch:hover {
    border-color: var(--accent-green);
  }

  /* Ensure switch is properly sized and doesn't take too much space */
  .theme-toggle-switch {
    flex-shrink: 0;
  }
</style>
