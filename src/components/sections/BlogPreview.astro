---
import { Icon } from "astro-icon/components";
import { getCollection, render, type CollectionEntry } from "astro:content";
import { homepageContent } from "../../data/content/homepage";
import { commonText } from "../../data/shared/common";
import { calculateReadTime } from "../../utils/content";
import { formatDate } from "../../utils/date";
import SectionContainer from "../layouts/SectionContainer.astro";

const base = import.meta.env.BASE_URL;

// Get latest blog posts - moved to component for streaming optimization
const allPosts = await getCollection("blog");
const latestPosts = allPosts
  .filter((post) => !post.data.draft)
  .sort(
    (a, b) =>
      new Date(b.data.publishDate).getTime() -
      new Date(a.data.publishDate).getTime(),
  )
  .slice(0, 3);

// Handle empty state
const hasPosts = latestPosts.length > 0;
---

<SectionContainer id="blog-preview" padding="md">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-12 sm:mb-16">
      <div
        class="inline-block mb-4 px-4 py-2 bg-accent-green/10 border border-accent-green/20 rounded-full"
      >
        <span class="text-accent-green text-sm font-semibold">Insights</span>
      </div>
      <h2
        class="text-3xl sm:text-4xl md:text-5xl font-bold mb-4 text-primary transition-colors"
      >
        {homepageContent.blog.title}
        <span class="text-gradient-green"
          >{homepageContent.blog.titleHighlight}</span
        >
      </h2>
      <p
        class="text-base sm:text-lg text-secondary max-w-2xl mx-auto transition-colors"
      >
        {homepageContent.blog.subtitle}
      </p>
    </div>

    {
      hasPosts ? (
        <>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8 max-w-7xl mx-auto mb-10 sm:mb-12">
            {latestPosts.map((post, index) => (
              <article
                class="bg-card border-2 border-accent-green/30 rounded-xl overflow-hidden hover:border-accent-green pulse-box transition-all duration-300 group shadow-lg hover:shadow-xl hover:-translate-y-2 animate-fade-in"
                data-animation-delay={index * 100}
                key={post.id}
              >
                <div class="p-6 sm:p-8">
                  {post.data.tags && post.data.tags[0] && (
                    <div class="inline-block px-3 py-1 bg-accent-green/10 border border-accent-green/20 rounded-full mb-4">
                      <span class="text-accent-green text-xs font-semibold uppercase tracking-wide">
                        {post.data.tags[0]}
                      </span>
                    </div>
                  )}

                  <h3 class="text-lg sm:text-xl font-bold mb-3 group-hover:text-accent-green transition-colors line-clamp-2 text-primary">
                    {post.data.title}
                  </h3>

                  <p class="text-secondary mb-4 leading-relaxed line-clamp-3 text-sm sm:text-base transition-colors">
                    {post.data.description}
                  </p>

                  <div class="flex items-center justify-between text-xs sm:text-sm text-secondary mb-4 transition-colors">
                    <time datetime={post.data.publishDate.toISOString()}>
                      {formatDate(post.data.publishDate)}
                    </time>
                    <span>{calculateReadTime(post.body)} min read</span>
                  </div>

                  <a
                    href={`${base}blog/${post.id}`}
                    class="inline-flex items-center gap-2 text-accent-green hover:text-accent-green/80 font-semibold text-sm sm:text-base group-hover:gap-3 transition-all min-h-[44px]"
                    aria-label={`Read article: ${post.data.title}`}
                  >
                    {commonText.buttons.viewArticle}
                    <Icon name="mdi:arrow-right" class="w-4 h-4" />
                  </a>
                </div>
              </article>
            ))}
          </div>

          <div class="text-center">
            <a
              href={`${base}blog/`}
              class="inline-flex items-center gap-2 px-8 py-4 bg-surface border border-theme text-primary rounded-lg hover:border-accent-green/50 hover:bg-accent-green/10 transition-all font-semibold min-h-[48px]"
              prefetch={true}
            >
              {homepageContent.blog.viewAllText}
              <Icon name="mdi:arrow-right" class="w-5 h-5" />
            </a>
          </div>
        </>
      ) : (
        <div class="text-center py-12">
          <p class="text-secondary text-lg transition-colors">
            {homepageContent.blog.subtitle}
          </p>
        </div>
      )
    }
  </div>
</SectionContainer>
