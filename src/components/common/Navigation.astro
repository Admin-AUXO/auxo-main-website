---
import { services } from '../../data/collections/services';
import { Icon } from 'astro-icon/components';
import ThemeToggle from '../ui/ThemeToggle.astro';

const base = import.meta.env.BASE_URL;

interface DropdownItem {
  name: string;
  href: string;
  icon: string;
  description?: string;
}

interface NavItem {
  name: string;
  href: string;
  dropdown?: DropdownItem[];
}

const navItems: NavItem[] = [
  {
    name: 'Services',
    href: `${base}services/`,
    dropdown: services.map(s => ({
      name: s.title,
      href: `${base}services/${s.id}/`,
      icon: s.icon,
      description: s.description
    }))
  },
  { name: 'About', href: `${base}about/` },
  {
    name: 'Resources',
    href: `${base}blog/`,
    dropdown: [
      { name: 'Case Studies', href: `${base}case-studies/`, icon: 'mdi:briefcase' },
      { name: 'Blog', href: `${base}blog/`, icon: 'mdi:post' },
      { name: 'FAQ', href: `${base}faq/`, icon: 'mdi:help-circle' },
      { name: 'Maturity Assessment', href: `${base}tools/maturity-calculator/`, icon: 'mdi:calculator' }
    ]
  },
];
---

<nav 
  id="main-navigation" 
  class="fixed top-0 left-0 right-0 z-50 bg-primary/98 backdrop-blur-md border-b border-theme transition-all duration-300 shadow-lg nav-scrolled"
>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16 sm:h-18 lg:h-20">
      <!-- Logo Section -->
      <a 
        href={`${base}`} 
        class="flex items-center space-x-2.5 sm:space-x-3 group relative" 
        aria-label="AUXO Data Labs Home"
      >
        <div class="relative">
          <img 
            src={`${base}logo.svg`} 
            alt="AUXO Data Labs Logo" 
            class="h-9 w-9 sm:h-11 sm:w-11 lg:h-12 lg:w-12 transition-transform duration-300 group-hover:scale-110 group-hover:rotate-3" 
          />
          <div class="absolute inset-0 bg-accent-green/20 rounded-full blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        </div>
        <div class="flex flex-col hidden sm:flex">
          <span class="text-primary text-base sm:text-lg lg:text-xl font-bold tracking-tight leading-tight transition-colors">
            AUXO
          </span>
          <span class="text-secondary text-xs font-medium tracking-wider uppercase leading-tight transition-colors">
            Data Labs
          </span>
        </div>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden lg:flex items-center space-x-5">
        {navItems.map((item, index) => (
          item.dropdown ? (
            <div class="relative dropdown-container group" data-nav-item={index}>
              <button 
                class="nav-link dropdown-toggle relative px-4 py-2.5 text-sm font-medium text-secondary hover:text-primary transition-all duration-200 rounded-lg hover:bg-surface active:bg-surface flex items-center gap-1.5 min-h-[44px] group-hover:text-primary"
                style="color: var(--text-secondary);"
                aria-expanded="false"
                aria-haspopup="true"
                aria-label={`${item.name} menu`}
                data-dropdown-toggle={index}
              >
                <span>{item.name}</span>
                <Icon 
                  name="mdi:chevron-down" 
                  class="w-4 h-4 transition-transform duration-200 dropdown-arrow"
                  aria-hidden="true"
                />
                <!-- Active Indicator -->
                <span class="nav-indicator absolute bottom-1 left-1/2 -translate-x-1/2 w-0 h-0.5 bg-accent-green rounded-full transition-all duration-300 group-hover:w-3/4"></span>
                <!-- Active Background -->
                <span class="nav-active-bg absolute inset-0 bg-accent-green/10 rounded-lg opacity-0 transition-opacity duration-300 pointer-events-none"></span>
              </button>

              <!-- Dropdown Menu -->
              <div 
                class:list={[
                  "absolute left-0 top-full mt-2 opacity-0 invisible transition-all duration-300 pointer-events-none dropdown-menu z-[60] transform translate-y-2",
                  item.name === 'Services' ? 'w-[600px]' : 'w-[280px]'
                ]}
                data-dropdown-menu={index}
              >
                <div class="relative">
                  <!-- Arrow Pointer -->
                  <div class="absolute -top-2 left-6 w-4 h-4 bg-card border-l border-t border-theme rotate-45"></div>
                  
                  <!-- Dropdown Content -->
                  <div class="relative bg-card border border-theme rounded-xl p-4 shadow-2xl backdrop-blur-xl">
                    <div class:list={[
                      item.name === 'Services' ? 'grid grid-cols-2 gap-3' : 'space-y-1'
                    ]}>
                      {item.dropdown.map((sub: DropdownItem) => (
                        <a
                          href={sub.href}
                          class="group/item flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-surface transition-all duration-200 border border-transparent hover:border-theme-light"
                        >
                          <!-- Icon Container -->
                          <div class="w-10 h-10 bg-surface rounded-lg flex items-center justify-center flex-shrink-0 group-hover/item:bg-accent-green/10 transition-colors duration-200">
                            <Icon name={sub.icon} class="w-5 h-5 text-accent-green" />
                          </div>
                          
                          <!-- Content -->
                          <div class="flex-1 min-w-0">
                            <div class="font-semibold text-primary text-sm leading-snug group-hover/item:text-accent-green transition-colors duration-200">
                              {sub.name}
                            </div>
                          </div>
                        </a>
                      ))}
                    </div>
                    
                    {item.name === 'Services' && (
                      <div class="mt-4 pt-4 border-t border-theme">
                        <a 
                          href={`${base}services/`} 
                          class="flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium text-accent-green hover:text-primary bg-surface hover:bg-accent-green/10 rounded-lg transition-all duration-200"
                          aria-label="View all services"
                        >
                          <span>View All Services</span>
                          <Icon name="mdi:arrow-right" class="w-4 h-4" aria-hidden="true" />
                        </a>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <a 
              href={item.href} 
              class="nav-link relative px-4 py-2.5 text-sm font-medium text-secondary hover:text-primary transition-all duration-200 rounded-lg hover:bg-surface active:bg-surface min-h-[44px] flex items-center group"
              style="color: var(--text-secondary);"
            >
              <span>{item.name}</span>
              <!-- Active Indicator -->
              <span class="nav-indicator absolute bottom-1 left-1/2 -translate-x-1/2 w-0 h-0.5 bg-accent-green rounded-full transition-all duration-300 group-hover:w-3/4"></span>
              <!-- Active Background -->
              <span class="nav-active-bg absolute inset-0 bg-accent-green/10 rounded-lg opacity-0 transition-opacity duration-300 pointer-events-none"></span>
            </a>
          )
        ))}
        
        <!-- Theme Toggle -->
        <div class="ml-3">
          <ThemeToggle />
        </div>
        
        <!-- CTA Button - Theme-aware: Black text in dark mode, White text in light mode -->
        <a 
          href={`${base}contact/`} 
          class="nav-cta ml-3 px-5 py-2.5 text-sm font-semibold bg-accent-green rounded-lg hover:bg-accent-green/90 active:bg-accent-green/80 transition-colors duration-200 min-h-[44px] flex items-center active:scale-95 relative shadow-lg shadow-accent-green/20"
          aria-label="Let's Talk - Contact us"
        >
          <span class="text-on-accent font-bold">Let's Talk</span>
        </a>
      </div>

      <!-- Mobile Menu Button -->
      <div class="flex items-center gap-2 lg:hidden">
        <ThemeToggle />
        <button 
          type="button"
          id="mobile-menu-button" 
          class="relative z-50 text-secondary hover:text-primary p-2 min-w-[44px] min-h-[44px] rounded-lg hover:bg-surface active:bg-surface transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-accent-green/50 touch-manipulation" 
          aria-label="Toggle mobile menu" 
          aria-expanded="false"
        >
          <div class="relative w-6 h-6">
            <svg 
              class="absolute inset-0 w-6 h-6 menu-icon transition-all duration-300" 
              fill="none" 
              stroke="currentColor" 
              viewBox="0 0 24 24"
            >
              <path 
                class="menu-open transition-opacity duration-300" 
                stroke-linecap="round" 
                stroke-linejoin="round" 
                stroke-width="2" 
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
              <path 
                class="menu-close absolute inset-0 opacity-0 transition-opacity duration-300" 
                stroke-linecap="round" 
                stroke-linejoin="round" 
                stroke-width="2" 
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div 
    id="mobile-menu" 
    class="lg:hidden fixed inset-x-0 top-16 sm:top-18 bg-card border-t border-theme max-h-[calc(100vh-4rem)] overflow-y-auto overscroll-contain transform -translate-y-full opacity-0 transition-all duration-300 ease-out shadow-2xl"
    style="touch-action: pan-y; -webkit-overflow-scrolling: touch;"
  >
    <div class="px-4 sm:px-6 py-6 space-y-3">
      {navItems.map((item, index) => (
        item.dropdown ? (
          <div class="mobile-dropdown" data-nav-item={index}>
            <button 
              type="button"
              class="mobile-dropdown-btn w-full flex items-center justify-between px-4 py-3.5 min-h-[52px] text-secondary hover:text-primary active:text-primary active:bg-surface rounded-lg transition-all duration-200 font-medium touch-manipulation bg-surface border border-theme hover:border-theme-light active:border-theme-light text-base relative group"
              aria-expanded="false"
              aria-label={`${item.name} menu`}
            >
              <span class="relative z-10">{item.name}</span>
              <Icon 
                name="mdi:chevron-down" 
                class="w-5 h-5 transition-transform duration-200 flex-shrink-0 text-accent-green dropdown-arrow-mobile relative z-10"
                aria-hidden="true"
              />
              <!-- Active Background -->
              <span class="mobile-nav-active-bg absolute inset-0 bg-accent-green/10 rounded-lg opacity-0 transition-opacity duration-300 pointer-events-none"></span>
            </button>
            <div class="mobile-dropdown-content hidden pl-4 mt-3 space-y-2 overflow-hidden border-l-2 border-theme ml-2">
              {item.dropdown.map((sub: DropdownItem) => (
                <a 
                  href={sub.href} 
                  class="flex items-center gap-3 px-4 py-3 min-h-[48px] text-sm text-secondary hover:text-accent-green active:text-accent-green active:bg-surface rounded-lg transition-all duration-200 touch-manipulation group/item bg-surface border border-transparent hover:border-theme-light active:border-theme-light relative"
                >
                  <!-- Visual Connector Line -->
                  <div class="absolute -left-[18px] top-1/2 -translate-y-1/2 w-3 h-0.5 bg-theme"></div>
                  <div class="w-8 h-8 bg-surface rounded-lg flex items-center justify-center flex-shrink-0 group-hover/item:bg-accent-green/10 transition-colors duration-200 border border-theme group-hover/item:border-accent-green/30">
                    <Icon name={sub.icon} class="w-4 h-4 text-accent-green" />
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold text-primary text-sm leading-snug group-hover/item:text-accent-green transition-colors duration-200">
                      {sub.name}
                    </div>
                  </div>
                </a>
              ))}
            </div>
          </div>
        ) : (
          <a 
            href={item.href} 
            class="mobile-nav-link block px-4 py-3.5 min-h-[52px] text-base text-secondary hover:text-primary active:text-primary active:bg-surface rounded-lg transition-all duration-200 font-medium touch-manipulation flex items-center bg-surface border border-theme hover:border-theme-light active:border-theme-light relative group"
          >
            <span>{item.name}</span>
            <!-- Active Background -->
            <span class="mobile-nav-active-bg absolute inset-0 bg-accent-green/10 rounded-lg opacity-0 transition-opacity duration-300 pointer-events-none"></span>
            <!-- Active Border -->
            <span class="mobile-nav-active-border absolute inset-0 rounded-lg border-2 border-accent-green opacity-0 transition-opacity duration-300 pointer-events-none"></span>
          </a>
        )
      ))}
      
      <!-- Mobile CTA Button - Theme-aware: Black text in dark mode, White text in light mode -->
      <a 
        href={`${base}contact/`} 
        class="block mt-4 px-6 py-3.5 min-h-[56px] bg-accent-green text-on-accent font-bold rounded-lg active:bg-accent-green/90 transition-colors duration-200 text-center touch-manipulation flex items-center justify-center text-base relative"
        aria-label="Let's Talk - Contact us"
      >
        <span class="text-on-accent">Let's Talk</span>
      </a>
    </div>
  </div>
</nav>

<!-- Spacer to prevent content from going under fixed nav -->
<div class="h-16 sm:h-18 lg:h-20"></div>

<style>
  /* Custom height utilities for navigation */
  .h-16 { height: 4rem; }
  .h-18 { height: 4.5rem; }
  .h-20 { height: 5rem; }
  .top-16 { top: 4rem; }
  .top-18 { top: 4.5rem; }
  
  /* Mobile menu open state */
  #mobile-menu.open {
    transform: translateY(0);
    opacity: 1;
  }
  
  /* Dropdown open state */
  .dropdown-menu.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }
  
  .dropdown-arrow.open {
    transform: rotate(180deg);
  }

  .dropdown-arrow-mobile.open {
    transform: rotate(180deg);
  }
  
  .dropdown-toggle.active .nav-indicator,
  .nav-link:hover .nav-indicator {
    width: 75%;
  }

  /* Active state styling */
  .nav-link.active .nav-active-bg,
  .dropdown-toggle.active .nav-active-bg {
    opacity: 1;
  }

  .mobile-nav-link.active .mobile-nav-active-bg,
  .mobile-nav-link.active .mobile-nav-active-border {
    opacity: 1;
  }

  /* Scroll-based navigation styling */
  #main-navigation.nav-scrolled {
    background: rgb(var(--bg-primary-rgb) / 0.99);
    backdrop-filter: blur(12px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  :root.light #main-navigation.nav-scrolled {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  }

  #main-navigation.nav-scrolled .container > div {
    height: 4rem;
  }
  
  @media (min-width: 1024px) {
    #main-navigation.nav-scrolled .container > div {
      height: 4.5rem;
    }
  }

  /* Scroll progress indicator */
  .nav-scroll-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 2px;
    background: linear-gradient(to right, var(--accent-green), var(--accent-green));
    transform-origin: left;
    transform: scaleX(0);
    transition: transform 0.1s ease-out;
    z-index: 1;
  }

  /* Pulse animation for CTA */
  @keyframes nav-pulse {
    0%, 100% {
      opacity: 0.75;
    }
    50% {
      opacity: 0.4;
    }
  }

  .nav-cta .animate-pulse {
    animation: nav-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  /* Tooltip positioning */
  .nav-tooltip {
    transform: translateX(-50%) translateY(4px);
  }

  .nav-tooltip span {
    border-top-color: var(--color-card);
  }

  /* Mobile menu slide animation */
  #mobile-menu {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-out;
  }

  #mobile-menu.open {
    transform: translateY(0);
    opacity: 1;
  }
</style>

<script>
  // Mobile menu toggle
  const btn = document.getElementById('mobile-menu-button');
  const menu = document.getElementById('mobile-menu');
  const menuOpen = document.querySelector('.menu-open');
  const menuClose = document.querySelector('.menu-close');

  const toggleMenu = () => {
    // Re-query elements to handle view transitions
    const currentMenu = document.getElementById('mobile-menu');
    const currentMenuOpen = document.querySelector('.menu-open');
    const currentMenuClose = document.querySelector('.menu-close');
    const currentBtn = document.getElementById('mobile-menu-button');
    
    if (!currentMenu || !currentMenuOpen || !currentMenuClose) return;
    
    const isOpen = currentMenu.classList.contains('open');
    
    if (isOpen) {
      currentMenu.classList.remove('open');
      currentMenu.classList.add('-translate-y-full', 'opacity-0');
      currentMenu.classList.remove('translate-y-0', 'opacity-100');
      currentMenuOpen.classList.remove('opacity-0');
      currentMenuOpen.classList.add('opacity-100');
      currentMenuClose.classList.add('opacity-0');
      currentMenuClose.classList.remove('opacity-100');
      document.body.style.overflow = '';
    } else {
      currentMenu.classList.add('open');
      currentMenu.classList.remove('-translate-y-full', 'opacity-0');
      currentMenu.classList.add('translate-y-0', 'opacity-100');
      currentMenuOpen.classList.add('opacity-0');
      currentMenuOpen.classList.remove('opacity-100');
      currentMenuClose.classList.remove('opacity-0');
      currentMenuClose.classList.add('opacity-100');
      document.body.style.overflow = 'hidden';
    }
    
    currentBtn?.setAttribute('aria-expanded', String(!isOpen));
  };

  // Mobile dropdown toggles
  function setupMobileDropdowns() {
    const mobileDropdownButtons = document.querySelectorAll('#mobile-menu .mobile-dropdown-btn');
    
    mobileDropdownButtons.forEach(button => {
      if ((button as any).__dropdownHandlerAttached) return;
      
      const handler = (e: Event) => {
        e.preventDefault();
        e.stopPropagation();
        
        const content = (button as HTMLElement).nextElementSibling as HTMLElement;
        const icon = button.querySelector('.dropdown-arrow-mobile');
        
        if (content) {
          const isHidden = content.classList.contains('hidden');
          
          if (isHidden) {
            content.classList.remove('hidden');
            content.style.maxHeight = '0';
            requestAnimationFrame(() => {
              content.style.maxHeight = content.scrollHeight + 'px';
              setTimeout(() => {
                content.style.maxHeight = '';
              }, 300);
            });
            icon?.classList.add('open');
            button.setAttribute('aria-expanded', 'true');
          } else {
            content.style.maxHeight = content.scrollHeight + 'px';
            requestAnimationFrame(() => {
              content.style.maxHeight = '0';
              setTimeout(() => {
                content.classList.add('hidden');
                content.style.maxHeight = '';
              }, 300);
            });
            icon?.classList.remove('open');
            button.setAttribute('aria-expanded', 'false');
          }
        }
      };

      button.addEventListener('click', handler, { capture: true });
      button.addEventListener('touchend', handler as EventListener, { capture: true, passive: false });
      
      (button as any).__dropdownHandlerAttached = true;
    });
  }

  const handleMenuButtonClick = (e: Event) => {
    e.preventDefault();
    e.stopPropagation();
    toggleMenu();
    setTimeout(setupMobileDropdowns, 50);
    return false;
  };

  // Close mobile menu when clicking on any link
  const closeMobileMenu = () => {
    // Re-query elements to handle view transitions
    const currentMenu = document.getElementById('mobile-menu');
    const currentMenuOpen = document.querySelector('.menu-open');
    const currentMenuClose = document.querySelector('.menu-close');
    const currentBtn = document.getElementById('mobile-menu-button');
    
    if (!currentMenu || !currentMenuOpen || !currentMenuClose) return;
    
    currentMenu.classList.remove('open');
    currentMenu.classList.add('-translate-y-full', 'opacity-0');
    currentMenu.classList.remove('translate-y-0', 'opacity-100');
    currentMenuOpen.classList.remove('opacity-0');
    currentMenuOpen.classList.add('opacity-100');
    currentMenuClose.classList.add('opacity-0');
    currentMenuClose.classList.remove('opacity-100');
    currentBtn?.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';
    
    document.querySelectorAll('#mobile-menu .mobile-dropdown-content').forEach(content => {
      const button = (content as HTMLElement).previousElementSibling;
      if (button && button.classList.contains('mobile-dropdown-btn')) {
        const contentEl = content as HTMLElement;
        contentEl.classList.add('hidden');
        contentEl.style.maxHeight = '';
        button.setAttribute('aria-expanded', 'false');
        const icon = button.querySelector('.dropdown-arrow-mobile');
        icon?.classList.remove('open');
      }
    });
  };

  // Close mobile menu when clicking outside
  const handleOutsideClick = (e: Event) => {
    const target = e.target as HTMLElement;
    const nav = document.getElementById('main-navigation');
    const currentMenu = document.getElementById('mobile-menu');
    
    if (nav && !nav.contains(target) && currentMenu?.classList.contains('open')) {
      closeMobileMenu();
    }
  };

  // Initialize mobile menu functionality
  function initializeMobileMenu() {
    // Re-get elements after DOM swap
    const currentBtn = document.getElementById('mobile-menu-button');
    const currentMenu = document.getElementById('mobile-menu');
    const currentMenuOpen = document.querySelector('.menu-open');
    const currentMenuClose = document.querySelector('.menu-close');
    
    if (!currentBtn || !currentMenu || !currentMenuOpen || !currentMenuClose) return;
    
    // Remove old event listeners if they exist
    currentBtn.replaceWith(currentBtn.cloneNode(true));
    const newBtn = document.getElementById('mobile-menu-button');
    if (!newBtn) return;
    
    // Re-attach menu button handlers
    newBtn.addEventListener('click', handleMenuButtonClick, { capture: true });
    newBtn.addEventListener('touchend', handleMenuButtonClick, { capture: true, passive: false });
    
    // Ensure menu is closed and body scroll is unlocked
    if (currentMenu.classList.contains('open')) {
      closeMobileMenu();
    }
    document.body.style.overflow = '';
    newBtn.setAttribute('aria-expanded', 'false');
    
    // Re-attach link click handlers
    const currentMobileLinks = document.querySelectorAll('#mobile-menu a');
    currentMobileLinks.forEach(link => {
      // Remove old listener if exists
      link.removeEventListener('click', closeMobileMenu);
      // Add new listener
      link.addEventListener('click', closeMobileMenu);
    });
    
    // Setup mobile dropdowns
    setupMobileDropdowns();
    
    // Re-attach outside click handler
    document.removeEventListener('click', handleOutsideClick);
    document.addEventListener('click', handleOutsideClick);
  }

  // Initial setup
  if (btn && menu && menuOpen && menuClose) {
    btn.addEventListener('click', handleMenuButtonClick, { capture: true });
    btn.addEventListener('touchend', handleMenuButtonClick, { capture: true, passive: false });
    
    const mobileLinks = document.querySelectorAll('#mobile-menu a');
    mobileLinks.forEach(link => {
      link.addEventListener('click', closeMobileMenu);
    });
    
    document.addEventListener('click', handleOutsideClick);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupMobileDropdowns);
  } else {
    setupMobileDropdowns();
  }

  // Desktop dropdown handlers
  let openDropdown: HTMLElement | null = null;
  let dropdownLeaveTimer: ReturnType<typeof setTimeout> | null = null;

  const closeDropdown = (dropdown: HTMLElement) => {
    const menu = dropdown.querySelector('.dropdown-menu') as HTMLElement;
    const button = dropdown.querySelector('.dropdown-toggle') as HTMLElement;
    const arrow = dropdown.querySelector('.dropdown-arrow') as HTMLElement;
    
    if (menu && button && arrow) {
      menu.classList.remove('open');
      button.classList.remove('active');
      button.setAttribute('aria-expanded', 'false');
      arrow.classList.remove('open');
      openDropdown = null;
    }
  };

  const openDropdownMenu = (dropdown: HTMLElement) => {
    if (openDropdown && openDropdown !== dropdown) {
      closeDropdown(openDropdown);
    }
    
    const menu = dropdown.querySelector('.dropdown-menu') as HTMLElement;
    const button = dropdown.querySelector('.dropdown-toggle') as HTMLElement;
    const arrow = dropdown.querySelector('.dropdown-arrow') as HTMLElement;
    
    if (menu && button && arrow) {
      menu.style.position = 'absolute';
      menu.style.visibility = 'hidden';
      menu.style.display = 'block';
      menu.style.opacity = '1';
      
      const buttonRect = button.getBoundingClientRect();
      const menuWidth = menu.offsetWidth;
      const viewportWidth = window.innerWidth;
      const padding = 16;
      
      menu.style.visibility = '';
      menu.style.display = '';
      menu.style.opacity = '';
      menu.style.left = '';
      menu.style.right = '';
      menu.classList.remove('dropdown-right-aligned');
      
      if (buttonRect.left + menuWidth > viewportWidth - padding) {
        menu.classList.add('dropdown-right-aligned');
      }
      
      menu.classList.add('open');
      button.classList.add('active');
      button.setAttribute('aria-expanded', 'true');
      arrow.classList.add('open');
      openDropdown = dropdown;
    }
  };

  function initializeDropdowns() {
    document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
      const newToggle = toggle.cloneNode(true);
      toggle.parentNode?.replaceChild(newToggle, toggle);
      
      newToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = (newToggle as HTMLElement).closest('.dropdown-container') as HTMLElement;
        if (!dropdown) return;
        
        const menu = dropdown.querySelector('.dropdown-menu') as HTMLElement;
        const isOpen = menu?.classList.contains('open');
        
        if (isOpen) {
          closeDropdown(dropdown);
        } else {
          openDropdownMenu(dropdown);
        }
      });
    });

    document.querySelectorAll('.dropdown-container').forEach(container => {
      const containerEl = container as HTMLElement;
      containerEl.addEventListener('mouseleave', () => {
        if (openDropdown === containerEl) {
          dropdownLeaveTimer = setTimeout(() => {
            closeDropdown(containerEl);
          }, 200);
        }
      });

      containerEl.addEventListener('mouseenter', () => {
        if (dropdownLeaveTimer) {
          clearTimeout(dropdownLeaveTimer);
          dropdownLeaveTimer = null;
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDropdowns);
  } else {
    initializeDropdowns();
  }

  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (openDropdown && !openDropdown.contains(target)) {
      closeDropdown(openDropdown);
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (openDropdown) {
        closeDropdown(openDropdown);
      }
      const currentMenu = document.getElementById('mobile-menu');
      if (currentMenu?.classList.contains('open')) {
        closeMobileMenu();
      }
    }
  });

  // Scroll-based navigation styling
  const nav = document.getElementById('main-navigation');
  const scrollProgress = document.createElement('div');
  scrollProgress.className = 'nav-scroll-progress';
  if (nav) {
    nav.appendChild(scrollProgress);
  }
  let isScrolling = false;
  
  function handleScroll() {
    if (!isScrolling) {
      window.requestAnimationFrame(() => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
        
        // Update scroll progress
        if (scrollProgress) {
          scrollProgress.style.transform = `scaleX(${scrollPercent / 100})`;
        }
        
        // Add scrolled class after initial scroll
        if (scrollTop > 10) {
          nav?.classList.add('nav-scrolled');
        } else {
          nav?.classList.remove('nav-scrolled');
        }
        
        isScrolling = false;
      });
    }
  }

  window.addEventListener('scroll', handleScroll, { passive: true });
  handleScroll(); // Initial call

  // Active link highlighting
  const updateActiveLinks = () => {
    const currentPath = window.location.pathname;
    
    document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
      const href = link.getAttribute('href');
      if (!href) return;
      
      // Remove active class first
      link.classList.remove('active', 'text-accent-green');
      
      const linkPath = href.replace(/\/$/, '');
      const normalizedCurrentPath = currentPath.replace(/\/$/, '');
      
      // Check if this link matches current path
      const isActive = normalizedCurrentPath === linkPath || 
          (normalizedCurrentPath.startsWith(linkPath) && linkPath !== '' && linkPath !== '/') ||
          currentPath === href ||
          (normalizedCurrentPath === '' && linkPath === '');
      
      if (isActive) {
        link.classList.add('active', 'text-accent-green');
        const indicator = link.querySelector('.nav-indicator');
        if (indicator) {
          (indicator as HTMLElement).style.width = '75%';
        }
      }
    });

    // Also check dropdown items for active state
    document.querySelectorAll('#mobile-menu a, .dropdown-menu a').forEach(link => {
      const href = link.getAttribute('href');
      if (!href) return;
      
      const linkPath = href.replace(/\/$/, '');
      const normalizedCurrentPath = currentPath.replace(/\/$/, '');
      
      const isActive = normalizedCurrentPath === linkPath || 
          currentPath === href;
      
      if (isActive) {
        // Mark parent dropdown as active if applicable
        const parentButton = link.closest('.mobile-dropdown-content')?.previousElementSibling;
        if (parentButton && parentButton.classList.contains('mobile-dropdown-btn')) {
          parentButton.classList.add('active');
        }
      }
    });
  };

  updateActiveLinks();
  document.addEventListener('astro:page-load', updateActiveLinks);

  document.addEventListener('astro:before-swap', () => {
    // Close mobile menu if open before navigation
    const currentMenu = document.getElementById('mobile-menu');
    if (currentMenu?.classList.contains('open')) {
      closeMobileMenu();
    }
    
    // Ensure body scroll is unlocked
    document.body.style.overflow = '';
    
    // Clean up event listeners (they'll be re-attached on page-load)
    const currentBtn = document.getElementById('mobile-menu-button');
    if (currentBtn) {
      currentBtn.removeEventListener('click', handleMenuButtonClick);
      currentBtn.removeEventListener('touchend', handleMenuButtonClick);
    }
    document.removeEventListener('click', handleOutsideClick);
    
    const currentMobileLinks = document.querySelectorAll('#mobile-menu a');
    currentMobileLinks.forEach(link => {
      link.removeEventListener('click', closeMobileMenu);
    });
    
    if (dropdownLeaveTimer) {
      clearTimeout(dropdownLeaveTimer);
      dropdownLeaveTimer = null;
    }
    
    openDropdown = null;
  });

  // Reinitialize everything after page transition
  document.addEventListener('astro:page-load', () => {
    initializeMobileMenu();
    initializeDropdowns();
    updateActiveLinks();
  });
</script>
