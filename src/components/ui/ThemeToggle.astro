---
import { Icon } from "astro-icon/components";

interface Props {
  isMobileSwitch?: boolean;
}

const { isMobileSwitch = false } = Astro.props;
---

<button
  id="theme-toggle"
  type="button"
  class:list={[
    "theme-toggle relative transition-all duration-200 flex items-center justify-center active:scale-95",
    isMobileSwitch 
      ? "theme-toggle-switch w-12 h-6 rounded-full bg-surface border border-theme flex-shrink-0" 
      : "w-10 h-10 rounded-lg bg-surface border border-theme text-secondary hover:text-accent-green hover:bg-accent-green/10 hover:border-accent-green/30 min-w-[44px] min-h-[44px]"
  ]}
  style={!isMobileSwitch ? "color: var(--text-secondary) !important;" : undefined}
  aria-label="Toggle theme"
  title="Toggle dark/light mode"
  data-mobile-switch={isMobileSwitch}
>
  {isMobileSwitch ? (
    <!-- Switch Style for Mobile -->
    <div class="theme-switch-track relative w-full h-full rounded-full bg-surface overflow-hidden">
      <!-- Background gradient that changes with theme -->
      <div class="theme-switch-bg absolute inset-0 transition-colors duration-300"></div>
      <!-- Switch knob -->
      <div class="theme-switch-knob absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-primary border border-theme shadow-md transition-transform duration-300 flex items-center justify-center">
        <Icon
          name="mdi:moon-waning-crescent"
          class="theme-icon-dark absolute w-3 h-3 transition-all duration-300 opacity-100"
          style="color: var(--text-secondary) !important;"
        />
        <Icon
          name="mdi:white-balance-sunny"
          class="theme-icon-light absolute w-3 h-3 transition-all duration-300 opacity-0"
          style="color: var(--text-secondary) !important;"
        />
      </div>
    </div>
  ) : (
    <!-- Icon Button Style for Desktop -->
    <>
      <Icon
        name="mdi:moon-waning-crescent"
        class="theme-icon-dark absolute w-5 h-5 transition-all duration-300 opacity-100 rotate-0 scale-100"
        style="color: var(--text-secondary) !important;"
      />
      <Icon
        name="mdi:white-balance-sunny"
        class="theme-icon-light absolute w-5 h-5 transition-all duration-300 opacity-0 rotate-90 scale-0"
        style="color: var(--text-secondary) !important;"
      />
    </>
  )}
</button>

<script>
  (function initThemeToggle() {
    const themeToggle = document.getElementById("theme-toggle");
    if (!themeToggle) return;

    // Get theme from localStorage or default to 'dark'
    const getTheme = (): "light" | "dark" => {
      if (typeof window === "undefined") return "dark";
      const stored = localStorage.getItem("theme") as "light" | "dark" | null;
      if (stored) return stored;

      // Check system preference
      if (window.matchMedia("(prefers-color-scheme: light)").matches) {
        return "light";
      }
      return "dark";
    };

    // Apply theme to document
    const applyTheme = (theme: "light" | "dark") => {
      const root = document.documentElement;
      if (theme === "light") {
        root.classList.remove("dark");
        root.classList.add("light");
      } else {
        root.classList.remove("light");
        root.classList.add("dark");
      }
      localStorage.setItem("theme", theme);
      updateIcon(theme);
    };

    // Update icon and switch based on theme
    const updateIcon = (theme: "light" | "dark") => {
      // Get fresh reference to theme toggle (important after view transitions)
      const currentToggle = document.getElementById("theme-toggle");
      if (!currentToggle) return;

      const isMobileSwitch = currentToggle.getAttribute("data-mobile-switch") === "true";
      const darkIcon = currentToggle.querySelector(".theme-icon-dark");
      const lightIcon = currentToggle.querySelector(".theme-icon-light");
      const switchKnob = currentToggle.querySelector(".theme-switch-knob");
      const switchBg = currentToggle.querySelector(".theme-switch-bg");

      if (isMobileSwitch && switchKnob) {
        // Update switch position using inline style for precise control
        if (theme === "dark") {
          (switchKnob as HTMLElement).style.transform = "translateX(0)";
          if (switchBg) {
            switchBg.classList.remove("bg-accent-green/20");
            switchBg.classList.add("bg-surface");
          }
        } else {
          // Calculate: button width (3rem/48px) - knob width (1.25rem/20px) - padding (0.125rem/2px)
          (switchKnob as HTMLElement).style.transform = "translateX(calc(3rem - 1.25rem - 0.125rem))";
          if (switchBg) {
            switchBg.classList.remove("bg-surface");
            switchBg.classList.add("bg-accent-green/20");
          }
        }
        
        // Update icons in switch (for mobile switch style)
        if (darkIcon && lightIcon) {
          if (theme === "dark") {
            darkIcon.classList.remove("opacity-0");
            darkIcon.classList.add("opacity-100");
            lightIcon.classList.remove("opacity-100");
            lightIcon.classList.add("opacity-0");
          } else {
            darkIcon.classList.remove("opacity-100");
            darkIcon.classList.add("opacity-0");
            lightIcon.classList.remove("opacity-0");
            lightIcon.classList.add("opacity-100");
          }
        }
      } else if (darkIcon && lightIcon) {
        // Update icons for desktop button style
        if (theme === "dark") {
          darkIcon.classList.remove("opacity-0", "rotate-90", "scale-0");
          darkIcon.classList.add("opacity-100", "rotate-0", "scale-100");
          lightIcon.classList.remove("opacity-100", "rotate-0", "scale-100");
          lightIcon.classList.add("opacity-0", "rotate-90", "scale-0");
        } else {
          darkIcon.classList.remove("opacity-100", "rotate-0", "scale-100");
          darkIcon.classList.add("opacity-0", "rotate-90", "scale-0");
          lightIcon.classList.remove("opacity-0", "rotate-90", "scale-0");
          lightIcon.classList.add("opacity-100", "rotate-0", "scale-100");
        }
      }
    };

    // Toggle theme
    const toggleTheme = () => {
      const currentTheme = getTheme();
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      applyTheme(newTheme);
      
      // Dispatch custom event for navigation to listen to
      document.dispatchEvent(new CustomEvent('themechange', {
        detail: { theme: newTheme }
      }));
    };

    // Initialize theme on load
    const initTheme = () => {
      const theme = getTheme();
      applyTheme(theme);
    };

    // Set up event listeners
    themeToggle.addEventListener("click", toggleTheme);

    // Initialize on page load
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initTheme);
    } else {
      initTheme();
    }

    // Listen for system theme changes
    if (typeof window !== "undefined") {
      window
        .matchMedia("(prefers-color-scheme: light)")
        .addEventListener("change", (e) => {
          // Only auto-switch if user hasn't manually set a preference
          if (!localStorage.getItem("theme")) {
            applyTheme(e.matches ? "light" : "dark");
          }
        });
    }

    // Re-initialize on Astro view transitions
    document.addEventListener("astro:page-load", () => {
      // Small delay to ensure DOM is fully ready
      setTimeout(() => {
        // Get fresh reference to theme toggle (might be new DOM element after swap)
        const currentToggle = document.getElementById("theme-toggle");
        if (currentToggle) {
          // Re-apply theme to ensure consistency across page transitions
          const theme = getTheme();
          applyTheme(theme);
          
          // Re-attach event listener to the new button element
          currentToggle.addEventListener("click", toggleTheme);
          
          // Update switch position and icons (important for mobile switch)
          updateIcon(theme);
        }
      }, 50);
    });
    
    // Also update on initial page load after a short delay to ensure DOM is ready
    setTimeout(() => {
      const currentToggle = document.getElementById("theme-toggle");
      if (currentToggle) {
        const theme = getTheme();
        updateIcon(theme);
      }
    }, 100);

    // Cleanup on Astro view transitions (optional - not strictly needed with replaceWith approach)
    document.addEventListener("astro:before-swap", () => {
      // Event listeners will be automatically removed when DOM is swapped
      // No manual cleanup needed
    });
  })();
</script>

<style>
  .theme-toggle {
    position: relative;
    overflow: hidden;
    /* Ensure theme toggle uses text-secondary, not text-on-accent */
    color: var(--text-secondary) !important;
  }

  .theme-toggle:hover {
    color: var(--accent-green) !important;
  }

  .theme-icon-dark,
  .theme-icon-light {
    transition:
      opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    /* Ensure icons use text-secondary, not text-on-accent */
    color: var(--text-secondary) !important;
  }

  .theme-toggle:hover .theme-icon-dark,
  .theme-toggle:hover .theme-icon-light {
    color: var(--accent-green) !important;
  }

  /* Switch style for mobile */
  .theme-toggle-switch {
    padding: 0;
  }

  .theme-switch-track {
    position: relative;
  }

  .theme-switch-bg {
    background-color: var(--bg-surface);
  }

  .theme-switch-knob {
    transform: translateX(0);
    z-index: 1;
  }

  /* Dark theme - knob on left (default position) */
  :root.dark .theme-switch-knob,
  :root:not(.light) .theme-switch-knob {
    transform: translateX(0);
  }

  /* Light theme - knob on right */
  :root.light .theme-switch-knob {
    transform: translateX(calc(3rem - 1.25rem - 0.125rem));
  }

  .theme-toggle-switch:hover {
    border-color: var(--accent-green);
  }
  
  /* Ensure switch is properly sized and doesn't take too much space */
  .theme-toggle-switch {
    flex-shrink: 0;
  }
</style>
