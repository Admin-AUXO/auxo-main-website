---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import FAQSchema from "../../components/FAQSchema.astro";
import { maturityCalculatorContent } from "../../data/content/maturityCalculator";
import { Icon } from "astro-icon/components";

const base = import.meta.env.BASE_URL;

// FAQ data for structured data
const calculatorFAQs = [
  {
    question: "What is a data maturity assessment?",
    answer:
      "A data maturity assessment evaluates your organization's current data capabilities across key dimensions including data strategy, infrastructure, analytics capabilities, governance, and organizational readiness. It helps identify strengths, gaps, and opportunities for improvement in your data journey.",
  },
  {
    question: "How long does the assessment take?",
    answer:
      "The AUXO Data Maturity Assessment typically takes 5-10 minutes to complete. It consists of targeted questions across five key dimensions of data maturity.",
  },
  {
    question: "What will I get from this assessment?",
    answer:
      "You'll receive an overall maturity score (1-5), detailed scores for each dimension, personalized recommendations for improvement, and insights into your organization's data strengths and areas for development.",
  },
  {
    question: "Is the maturity assessment free?",
    answer:
      "Yes, the AUXO Data Maturity Assessment is completely free. There are no hidden costs or obligations. We provide this tool to help organizations understand their data capabilities and identify improvement opportunities.",
  },
  {
    question: "How is my data used?",
    answer:
      "Your assessment responses are used only to calculate your maturity score and provide personalized recommendations. We respect your privacy and handle all data according to our privacy policy and UAE PDPL regulations.",
  },
];
---

<FAQSchema faqs={calculatorFAQs} />

<BaseLayout
  title="Data Analytics Maturity Assessment | AUXO Data Labs"
  description="Discover your organization's data analytics maturity level with our free interactive assessment. Get personalized recommendations to advance your data capabilities."
>
  <div class="pt-24 pb-16">
    <div class="container mx-auto px-4">
      <!-- Breadcrumb with Structured Data -->
      <div class="max-w-4xl mx-auto">
        <Breadcrumbs
          items={[
            { label: "Home", href: base },
            { label: "Maturity Assessment Calculator" },
          ]}
        />
      </div>

      <!-- Header -->
      <div class="max-w-4xl mx-auto text-center mb-12">
        <div
          class="inline-block px-4 py-2 bg-lime-400/10 border border-lime-400/20 rounded-full mb-4"
        >
          <span class="text-lime-400 text-sm font-semibold"
            >{maturityCalculatorContent.hero.badge}</span
          >
        </div>
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          {maturityCalculatorContent.hero.title}
          <span class="text-lime-400">
            {maturityCalculatorContent.hero.titleHighlight}</span
          >
        </h1>
        <p class="text-xl text-gray-400 mb-6">
          {maturityCalculatorContent.hero.subtitle}
        </p>
        <p class="text-sm text-gray-500">
          {maturityCalculatorContent.hero.subtitleMeta}
        </p>
      </div>

      <!-- Assessment Container -->
      <div class="max-w-4xl mx-auto">
        <!-- Introduction Screen -->
        <div
          id="intro-screen"
          class="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 md:p-12"
        >
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-zinc-800 p-6 rounded-lg">
              <Icon
                name={maturityCalculatorContent.intro.benefits.icon}
                class="w-10 h-10 text-lime-400 mb-3"
              />
              <h3 class="font-bold mb-2">
                {maturityCalculatorContent.intro.benefits.title}
              </h3>
              <ul class="text-sm text-gray-400 space-y-2">
                {
                  maturityCalculatorContent.intro.benefits.items.map((item) => (
                    <li>• {item}</li>
                  ))
                }
              </ul>
            </div>

            <div class="bg-zinc-800 p-6 rounded-lg">
              <Icon
                name={maturityCalculatorContent.intro.privacy.icon}
                class="w-10 h-10 text-lime-400 mb-3"
              />
              <h3 class="font-bold mb-2">
                {maturityCalculatorContent.intro.privacy.title}
              </h3>
              <ul class="text-sm text-gray-400 space-y-2">
                {
                  maturityCalculatorContent.intro.privacy.items.map((item) => (
                    <li>• {item}</li>
                  ))
                }
              </ul>
            </div>
          </div>

          <div
            class="bg-gradient-to-r from-lime-400/10 to-green-500/10 border border-lime-400/20 rounded-lg p-6 mb-8"
          >
            <h3 class="font-bold mb-3">
              {maturityCalculatorContent.intro.dimensions.title}
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
              {
                maturityCalculatorContent.intro.dimensions.list.map(
                  (dimension) => (
                    <div class="text-center">
                      <div class="w-12 h-12 bg-lime-400/20 rounded-full flex items-center justify-center mx-auto mb-2">
                        <Icon
                          name={dimension.icon}
                          class="w-6 h-6 text-lime-400"
                        />
                      </div>
                      <p class="text-sm font-medium">{dimension.name}</p>
                    </div>
                  ),
                )
              }
            </div>
          </div>

          <button
            id="start-btn"
            class="w-full py-4 bg-lime-400 text-black font-bold rounded-lg hover:bg-lime-500 transition-all transform hover:scale-105"
          >
            {maturityCalculatorContent.intro.startButton}
          </button>
        </div>

        <!-- Question Screen -->
        <div
          id="question-screen"
          class="hidden bg-zinc-900 border border-zinc-800 rounded-2xl p-8 md:p-12"
        >
          <!-- Progress -->
          <div class="mb-8">
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-gray-400"
                >{maturityCalculatorContent.questionScreen.questionLabel}
                <span id="q-num">1</span>
                {maturityCalculatorContent.questionScreen.ofLabel}
                <span id="total-questions">20</span></span
              >
              <span class="text-sm text-gray-400"
                ><span id="q-progress">5</span>% {
                  maturityCalculatorContent.questionScreen.completeLabel
                }</span
              >
            </div>
            <div class="h-2 bg-zinc-800 rounded-full overflow-hidden">
              <div
                id="q-bar"
                class="h-full bg-gradient-to-r from-lime-400 to-green-500 transition-all duration-300"
                style="width: 5%"
              >
              </div>
            </div>
          </div>

          <!-- Category Badge -->
          <div
            class="inline-block px-4 py-2 bg-lime-400/10 border border-lime-400/20 rounded-full mb-4"
          >
            <span id="category-name" class="text-lime-400 text-sm font-semibold"
            ></span>
          </div>

          <!-- Question -->
          <h2
            class="text-2xl font-bold mb-8"
            aria-live="polite"
            aria-atomic="true"
          >
            <span class="sr-only">Question: </span>
            <span id="question-text"></span>
          </h2>

          <!-- Answer Options -->
          <div id="answer-options" class="space-y-3 mb-8">
            <!-- Options will be inserted here -->
          </div>

          <!-- Navigation -->
          <div class="flex justify-between">
            <button
              id="q-back-btn"
              class="px-6 py-3 bg-zinc-800 text-white rounded-lg hover:bg-zinc-700 transition-colors disabled:opacity-50"
              disabled
            >
              {maturityCalculatorContent.questionScreen.backButton}
            </button>
            <button
              id="q-next-btn"
              class="px-6 py-3 bg-lime-400 text-black font-semibold rounded-lg hover:bg-lime-500 transition-colors disabled:opacity-50"
              disabled
            >
              {maturityCalculatorContent.questionScreen.nextButton}
            </button>
          </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden">
          <div
            class="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 md:p-12 mb-6"
          >
            <!-- Overall Score -->
            <div class="text-center mb-12">
              <h2 class="text-3xl font-bold mb-2">
                {maturityCalculatorContent.results.title}
              </h2>
              <div
                id="maturity-level"
                class="text-6xl font-black text-lime-400 my-6"
              >
              </div>
              <p id="maturity-description" class="text-xl text-gray-400"></p>
            </div>

            <!-- Dimension Scores -->
            <div class="mb-12">
              <h3 class="text-2xl font-bold mb-6 text-center">
                {maturityCalculatorContent.results.scoresTitle}
              </h3>
              <div class="space-y-6">
                <div id="dimension-results">
                  <!-- Will be populated by JavaScript -->
                </div>
              </div>
            </div>

            <!-- Recommendations -->
            <div
              class="bg-gradient-to-r from-lime-400/10 to-green-500/10 border border-lime-400/20 rounded-lg p-6 mb-8"
            >
              <h3 class="text-xl font-bold mb-4 flex items-center">
                <Icon name="mdi:lightbulb" class="w-6 h-6 text-lime-400 mr-2" />
                Next Steps for Your Organization
              </h3>
              <div id="recommendations" class="space-y-3 text-gray-300">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>

            <!-- CTA Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <button
                id="download-btn"
                class="px-6 py-3 bg-zinc-800 text-white font-semibold rounded-lg hover:bg-zinc-700 transition-colors flex items-center justify-center"
              >
                <Icon name="mdi:download" class="w-5 h-5 mr-2" />
                {maturityCalculatorContent.results.downloadReport}
              </button>
              <button
                id="email-btn"
                class="px-6 py-3 bg-zinc-800 text-white font-semibold rounded-lg hover:bg-zinc-700 transition-colors flex items-center justify-center"
              >
                <Icon name="mdi:email" class="w-5 h-5 mr-2" />
                {maturityCalculatorContent.results.shareResults}
              </button>
              <a
                href={`${base}contact`}
                class="px-6 py-3 bg-lime-400 text-black font-semibold rounded-lg hover:bg-lime-500 transition-colors flex items-center justify-center"
              >
                {maturityCalculatorContent.results.contactUs} →
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ content: maturityCalculatorContent }}>
  // Assessment Data - imported from content file
  const classificationQuestions = content.classificationQuestions;
  const questionSets = content.questions;
  const pathways = content.pathways;
  const maturityLevels = content.maturityLevels;

  // State
  let currentQuestion = 0;
  let classificationAnswers = [];
  let assessmentAnswers = [];
  let currentPathway = null;
  let personalizedQuestions = [];
  let isClassificationPhase = true;
  let TOTAL_QUESTIONS = classificationQuestions.length;

  // Elements
  const introScreen = document.getElementById("intro-screen");
  const questionScreen = document.getElementById("question-screen");
  const resultsScreen = document.getElementById("results-screen");
  const startBtn = document.getElementById("start-btn");
  const totalQuestionsEl = document.getElementById("total-questions");

  // Type guards
  function getElementSafe(id) {
    return document.getElementById(id);
  }

  /**
   * Determine pathway based on classification answers
   */
  function determinePathway() {
    const totalScore = classificationAnswers.reduce(
      (sum, score) => sum + score,
      0,
    );

    // Determine pathway based on score ranges
    if (totalScore <= 6) return "early";
    if (totalScore <= 10) return "growing";
    if (totalScore <= 13) return "medium";
    if (totalScore <= 15) return "advanced";
    return "enterprise";
  }

  /**
   * Build personalized question set based on pathway
   */
  function buildPersonalizedQuestions(pathway) {
    const questions = [];

    // Always include core questions
    questions.push(...questionSets.core);

    // Add pathway-specific questions
    if (pathway === "early") {
      questions.push(...questionSets.early);
    } else if (pathway === "growing" || pathway === "medium") {
      questions.push(
        ...questionSets.early.filter((q) => !q.skipFor?.includes(pathway)),
      );
      questions.push(...questionSets.growing);
    } else if (pathway === "advanced" || pathway === "enterprise") {
      questions.push(...questionSets.growing);
      questions.push(
        ...questionSets.advanced.filter((q) => {
          if (q.skipFor && q.skipFor.includes(pathway)) return false;
          if (q.requiredFor && !q.requiredFor.includes(pathway)) return false;
          return true;
        }),
      );
    }

    return questions;
  }

  /**
   * Get current question based on phase
   */
  function getCurrentQuestion(index) {
    if (isClassificationPhase) {
      return classificationQuestions[index];
    } else {
      return personalizedQuestions[index];
    }
  }

  /**
   * Get current answers array
   */
  function getCurrentAnswers() {
    return isClassificationPhase ? classificationAnswers : assessmentAnswers;
  }

  /**
   * Set answer in current phase
   */
  function setCurrentAnswer(index, score) {
    if (isClassificationPhase) {
      classificationAnswers[index] = score;
    } else {
      assessmentAnswers[index] = score;
    }
  }

  // Start assessment
  startBtn?.addEventListener("click", () => {
    introScreen?.classList.add("hidden");
    questionScreen?.classList.remove("hidden");
    isClassificationPhase = true;
    TOTAL_QUESTIONS = classificationQuestions.length;
    if (totalQuestionsEl) {
      totalQuestionsEl.textContent = String(TOTAL_QUESTIONS);
    }
    showQuestion(0);
  });

  function showQuestion(index) {
    const q = getCurrentQuestion(index);
    if (!q) return;

    currentQuestion = index;
    const currentAnswers = getCurrentAnswers();

    // Update progress
    const progress = ((index + 1) / TOTAL_QUESTIONS) * 100;
    const qNum = getElementSafe("q-num");
    const qProgress = getElementSafe("q-progress");
    const qBar = getElementSafe("q-bar");

    if (qNum) qNum.textContent = String(index + 1);
    if (qProgress) qProgress.textContent = String(Math.round(progress));
    if (qBar) qBar.style.width = `${progress}%`;

    // Update question
    const categoryName = getElementSafe("category-name");
    const questionText = getElementSafe("question-text");

    if (categoryName) categoryName.textContent = q.category;
    if (questionText) questionText.textContent = q.question;

    // Update options
    const optionsContainer = getElementSafe("answer-options");
    if (!optionsContainer) return;
    optionsContainer.innerHTML = "";

    q.options.forEach((option, optIndex) => {
      const button = document.createElement("button");
      const isSelected = currentAnswers[index] === option.score;

      // Enhanced styling with better highlighting
      button.className = isSelected
        ? "answer-option w-full p-4 bg-lime-400/15 border-2 border-lime-400 rounded-lg text-left transition-all shadow-lg shadow-lime-400/20 hover:border-lime-300 hover:bg-lime-400/20"
        : "answer-option w-full p-4 bg-zinc-800 border-2 border-zinc-700 rounded-lg text-left hover:border-lime-400 hover:bg-zinc-700/50 transition-all";

      button.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="${isSelected ? "text-white font-medium" : ""}">${option.text}</span>
          <span class="text-sm ${isSelected ? "text-lime-400 font-semibold" : "text-gray-500"}">${option.score}/5</span>
        </div>
      `;

      button.setAttribute("data-score", String(option.score));
      button.addEventListener("click", (e) =>
        selectAnswer(option.score, optIndex, e),
      );

      optionsContainer.appendChild(button);
    });

    // Update navigation
    const backBtn = getElementSafe("q-back-btn");
    const nextBtn = getElementSafe("q-next-btn");

    if (backBtn) backBtn.disabled = index === 0;
    if (nextBtn) nextBtn.disabled = !currentAnswers[index];
  }

  function selectAnswer(score, optIndex, e) {
    setCurrentAnswer(currentQuestion, score);
    const currentAnswers = getCurrentAnswers();

    // Get all option buttons for current question
    const optionsContainer = getElementSafe("answer-options");
    if (!optionsContainer) return;

    const allButtons = optionsContainer.querySelectorAll(".answer-option");

    // Remove selected styling from all options
    allButtons.forEach((btn) => {
      btn.classList.remove(
        "border-lime-400",
        "bg-lime-400/15",
        "shadow-lg",
        "shadow-lime-400/20",
        "hover:border-lime-300",
        "hover:bg-lime-400/20",
      );
      btn.classList.add("border-zinc-700", "bg-zinc-800");

      // Reset text styling
      const textSpan = btn.querySelector("span:first-child");
      const scoreSpan = btn.querySelector("span:last-child");
      if (textSpan) {
        textSpan.classList.remove("text-white", "font-medium");
      }
      if (scoreSpan) {
        scoreSpan.classList.remove("text-lime-400", "font-semibold");
        scoreSpan.classList.add("text-gray-500");
      }
    });

    // Add selected styling to clicked option
    const clickedButton = e.target.closest(".answer-option");
    if (clickedButton) {
      clickedButton.classList.remove("border-zinc-700", "bg-zinc-800");
      clickedButton.classList.add(
        "border-lime-400",
        "bg-lime-400/15",
        "shadow-lg",
        "shadow-lime-400/20",
        "hover:border-lime-300",
        "hover:bg-lime-400/20",
      );

      // Update text styling for selected option
      const textSpan = clickedButton.querySelector("span:first-child");
      const scoreSpan = clickedButton.querySelector("span:last-child");
      if (textSpan) {
        textSpan.classList.add("text-white", "font-medium");
      }
      if (scoreSpan) {
        scoreSpan.classList.remove("text-gray-500");
        scoreSpan.classList.add("text-lime-400", "font-semibold");
      }
    }

    // Enable next button
    const nextBtn = getElementSafe("q-next-btn");
    if (nextBtn) nextBtn.disabled = false;
  }

  document.getElementById("q-back-btn")?.addEventListener("click", () => {
    if (currentQuestion > 0) {
      showQuestion(currentQuestion - 1);
    }
  });

  document.getElementById("q-next-btn")?.addEventListener("click", () => {
    const currentAnswers = getCurrentAnswers();

    // Check if we're transitioning from classification to assessment
    if (
      isClassificationPhase &&
      currentQuestion === classificationQuestions.length - 1
    ) {
      // Determine pathway and build personalized questions
      currentPathway = determinePathway();
      personalizedQuestions = buildPersonalizedQuestions(currentPathway);

      // Switch to assessment phase
      isClassificationPhase = false;
      currentQuestion = 0;
      TOTAL_QUESTIONS = personalizedQuestions.length;

      // Update total questions display
      if (totalQuestionsEl) {
        totalQuestionsEl.textContent = String(TOTAL_QUESTIONS);
      }

      // Reset assessment answers
      assessmentAnswers = new Array(personalizedQuestions.length).fill(0);

      // Show first assessment question
      showQuestion(0);
    } else if (currentQuestion < TOTAL_QUESTIONS - 1) {
      showQuestion(currentQuestion + 1);
    } else {
      showResults();
    }
  });

  function showResults() {
    questionScreen?.classList.add("hidden");
    resultsScreen?.classList.remove("hidden");

    // Use assessment answers for scoring
    const answers = assessmentAnswers;
    const questions = personalizedQuestions;

    // Calculate scores by dimension
    const dimensionScores = {};

    questions.forEach((q, i) => {
      if (!dimensionScores[q.category]) {
        dimensionScores[q.category] = { total: 0, count: 0 };
      }
      dimensionScores[q.category].total += answers[i] || 0;
      dimensionScores[q.category].count += 1;
    });

    // Calculate average scores
    const avgScores = {};
    Object.keys(dimensionScores).forEach((dim) => {
      avgScores[dim] = dimensionScores[dim].total / dimensionScores[dim].count;
    });

    // Overall maturity
    const overallScore =
      Object.values(avgScores).reduce((a, b) => a + b, 0) /
      Object.keys(avgScores).length;
    const maturityLevel = Math.round(overallScore);

    // Display overall score
    const level = maturityLevels[maturityLevel];
    const levelEl = getElementSafe("maturity-level");
    const descEl = getElementSafe("maturity-description");

    if (levelEl) {
      levelEl.textContent = level.name;
      levelEl.style.color = level.color;
    }
    if (descEl) descEl.textContent = level.description;

    // Display dimension scores
    const dimensionResults = getElementSafe("dimension-results");
    if (!dimensionResults) return;
    dimensionResults.innerHTML = "";

    Object.entries(avgScores).forEach(([dimension, score]) => {
      const percentage = (score / 5) * 100;
      const div = document.createElement("div");
      div.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <span class="font-medium">${dimension}</span>
          <span class="text-lime-400 font-bold">${score.toFixed(1)}/5</span>
        </div>
        <div class="h-3 bg-zinc-800 rounded-full overflow-hidden">
          <div class="h-full bg-gradient-to-r from-lime-400 to-green-500 transition-all duration-1000" style="width: ${percentage}%"></div>
        </div>
      `;
      dimensionResults.appendChild(div);
    });

    // Generate recommendations
    const recommendations = document.getElementById("recommendations");
    if (!recommendations) return;
    const recs = generateRecommendations(avgScores, maturityLevel);
    recommendations.innerHTML = recs.map((rec) => `<p>✓ ${rec}</p>`).join("");

    // Scroll to top
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function generateRecommendations(scores, overall) {
    const recs = [];

    // Find lowest scoring dimension
    const lowest = Object.entries(scores).sort((a, b) => a[1] - b[1])[0];

    if (overall <= 2) {
      recs.push(
        "Start by establishing a centralized data infrastructure with basic quality controls",
      );
      recs.push("Invest in foundational data skills training for your team");
      recs.push(
        "Create a simple data governance framework to ensure security and compliance",
      );
    } else if (overall <= 3) {
      recs.push(
        "Focus on improving your " +
          lowest[0] +
          " - currently your biggest opportunity area",
      );
      recs.push(
        "Implement self-service analytics tools to democratize data access",
      );
      recs.push(
        "Develop a data strategy roadmap aligned with business objectives",
      );
    } else if (overall <= 4) {
      recs.push(
        "Consider advanced analytics and machine learning for predictive insights",
      );
      recs.push(
        "Build a center of excellence to scale best practices across the organization",
      );
      recs.push("Implement real-time data pipelines and streaming analytics");
    } else {
      recs.push(
        "Explore cutting-edge AI and automation to maintain your competitive advantage",
      );
      recs.push(
        "Share your data-driven culture and learnings with the broader community",
      );
      recs.push(
        "Continuously innovate with emerging technologies like generative AI",
      );
    }

    recs.push(
      "Partner with experts like AUXO Data Labs to accelerate your data analytics journey",
    );

    return recs;
  }

  // Download report (stub)
  document.getElementById("download-btn")?.addEventListener("click", () => {
    alert(
      "PDF download functionality would be implemented here with your backend.",
    );
  });

  // Email results (stub)
  document.getElementById("email-btn")?.addEventListener("click", () => {
    const email = prompt("Enter your email to receive the results:");
    if (email) {
      alert(
        `Results would be sent to ${email}. This requires backend integration.`,
      );
    }
  });
</script>
