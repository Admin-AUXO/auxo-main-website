---
import { getCollection, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Breadcrumbs } from "astro-breadcrumbs";
import { SocialShare } from "astro-social-share";
import PageContainer from "../../components/layouts/PageContainer.astro";
import ContentWrapper from "../../components/layouts/ContentWrapper.astro";
import { Icon } from "astro-icon/components";
import { calculateReadTime } from "../../utils/content";
import { formatDateLong } from "../../utils/date";
import { generateBlogBreadcrumbs } from "../../utils/breadcrumbs";
import BlogPostCard from "../../components/sections/blog/BlogPostCard.astro";

const base = import.meta.env.BASE_URL;

// Get all posts for related posts functionality
const allPosts = await getCollection("blog", ({ data }) => {
  return data.draft !== true;
});

// Generate static paths for all blog posts
export async function getStaticPaths() {
  try {
    // Get all blog posts that are not drafts
    const posts = await getCollection("blog", ({ data }) => {
      return data.draft !== true;
    });

    // If no posts exist, return empty array
    if (!posts || posts.length === 0) {
      if (import.meta.env.DEV) {
        console.warn("No blog posts found");
      }
      return [];
    }

    if (import.meta.env.DEV) {
      console.log(`Generating ${posts.length} blog post pages`);
    }

    return posts
      .map((post) => {
        if (!post.id) {
          if (import.meta.env.DEV) {
            console.error("Post missing id:", post);
          }
          return null;
        }

        // Use id instead of slug for better compatibility
        const slug = post.id.replace(/\.mdx?$/, "");

        return {
          params: { slug },
          props: { post },
        };
      })
      .filter(Boolean);
  } catch (error) {
    if (import.meta.env.DEV) {
      console.error("Error fetching blog posts:", error);
    }
    return [];
  }
}

const { post } = Astro.props;

// If post doesn't exist, this will be handled by Astro's 404 page
if (!post) {
  return Astro.redirect("/404");
}

// Render the post content using the render function from astro:content
const { Content } = await render(post);

// Generate formatted breadcrumbs
const breadcrumbItems = generateBlogBreadcrumbs(
  Astro.url.pathname,
  post.data.title,
);

// Generate table of contents from headings in content with hierarchy
const contentText = post.body;
const headingRegex = /^(#{2,3})\s+(.+)$/gm;
const toc: Array<{
  level: number;
  text: string;
  id: string;
  children?: Array<{ level: number; text: string; id: string }>;
}> = [];
let match;
const allHeadings: Array<{ level: number; text: string; id: string }> = [];
if (contentText) {
  while ((match = headingRegex.exec(contentText)) !== null) {
    const level = match[1].length;
    const text = match[2].trim();
    const id = text
      .toLowerCase()
      .replace(/[^\w\s-]/g, "")
      .replace(/\s+/g, "-")
      .replace(/-+/g, "-");
    allHeadings.push({ level, text, id });
  }
}

// Build hierarchical TOC structure
let currentH2: {
  level: number;
  text: string;
  id: string;
  children?: Array<{ level: number; text: string; id: string }>;
} | null = null;
allHeadings.forEach((heading) => {
  if (heading.level === 2) {
    // New H2 section
    if (currentH2) {
      toc.push(currentH2);
    }
    currentH2 = { ...heading, children: [] };
  } else if (heading.level === 3 && currentH2) {
    // H3 is a child of current H2
    currentH2.children = currentH2.children || [];
    currentH2.children.push(heading);
  }
});
// Add the last H2 section
if (currentH2) {
  toc.push(currentH2);
}

// Find related posts based on tags and category
const currentPostTags = post.data.tags || [];
const currentPostId = post.id;

const relatedPosts = allPosts
  .filter((p) => p.id !== currentPostId)
  .map((p) => {
    const postTags = p.data.tags || [];
    const commonTags = currentPostTags.filter((tag) => postTags.includes(tag));
    return {
      post: p,
      score: commonTags.length,
      commonTags,
    };
  })
  .filter((item) => item.score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 3)
  .map((item) => ({
    ...item.post,
    readTime: calculateReadTime(item.post.body),
  }));

// Get next and previous posts for navigation
const sortedPosts = allPosts.sort(
  (a, b) =>
    new Date(b.data.publishDate).getTime() -
    new Date(a.data.publishDate).getTime(),
);
const currentIndex = sortedPosts.findIndex((p) => p.id === currentPostId);
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : undefined;
const prevPost =
  currentIndex < sortedPosts.length - 1
    ? sortedPosts[currentIndex + 1]
    : undefined;

// Generate article URL for sharing
const articleUrl = `${Astro.site || "https://auxodata.com"}${base}blog/${post.id.replace(/\.mdx?$/, "")}/`;
const articleTitle = post.data.title;
const articleDescription = post.data.description;

// Determine contextual CTA based on article tags
const getContextualCTA = () => {
  const tags = post.data.tags || [];
  const title = post.data.title.toLowerCase();
  const description = (post.data.description || "").toLowerCase();

  if (
    tags.some((t) => t.toLowerCase().includes("data strategy")) ||
    title.includes("data strategy") ||
    description.includes("data strategy")
  ) {
    return {
      title: "Get Your Data Strategy Assessment",
      description:
        "Let's evaluate your current data capabilities and create a roadmap for success.",
      href: `${base}contact/`,
      icon: "mdi:strategy",
    };
  } else if (
    tags.some((t) => t.toLowerCase().includes("business intelligence")) ||
    tags.some((t) => t.toLowerCase().includes("bi")) ||
    title.includes("business intelligence") ||
    title.includes("bi ")
  ) {
    return {
      title: "Schedule BI Consultation",
      description:
        "Discover how business intelligence can transform your decision-making.",
      href: `${base}contact/`,
      icon: "mdi:chart-bar",
    };
  } else if (
    tags.some((t) => t.toLowerCase().includes("machine learning")) ||
    tags.some((t) => t.toLowerCase().includes("ml")) ||
    tags.some((t) => t.toLowerCase().includes("ai")) ||
    title.includes("machine learning") ||
    title.includes("ml ")
  ) {
    return {
      title: "Explore ML Solutions",
      description:
        "See how machine learning can solve your business challenges.",
      href: `${base}services/`,
      icon: "mdi:robot",
    };
  } else {
    return {
      title: "Ready to Transform Your Data?",
      description:
        "Let's discuss how AUXO Data Labs can help your business leverage data analytics.",
      href: `${base}contact/`,
      icon: "mdi:lightbulb",
    };
  }
};

const contextualCTA = getContextualCTA();
---

<BaseLayout
  title={`${post.data.title} | AUXO Data Labs Blog`}
  description={post.data.description}
  article={true}
  publishedTime={post.data.publishDate.toISOString()}
  author="AUXO Data Labs"
  tags={post.data.tags}
>
  <PageContainer maxWidth="4xl" paddingTop="pt-24" paddingBottom="pb-16">
    <!-- Reading Progress Bar -->
    <div
      id="reading-progress"
      class="fixed top-0 left-0 right-0 h-1 bg-accent-green/20 z-50 transition-all duration-300"
      style="width: 0%"
    >
      <div
        class="h-full bg-accent-green transition-all duration-300"
        id="reading-progress-bar"
        style="width: 0%"
      >
      </div>
    </div>

    <article>
      <!-- Breadcrumb with Structured Data -->
      <ContentWrapper maxWidth="4xl" class="mb-8">
        <Breadcrumbs
          class="text-sm breadcrumb-theme"
          separator="chevron"
          crumbs={breadcrumbItems}
        />
      </ContentWrapper>

      <!-- Article Header -->
      <ContentWrapper maxWidth="4xl" class="mb-10 sm:mb-12">
        <!-- Tags -->
        {
          post.data.tags && post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4 sm:mb-6">
              {post.data.tags.map((tag: string) => (
                <span class="px-2.5 sm:px-3 py-1 sm:py-1.5 bg-accent-green/10 text-accent-green transition-colors text-xs sm:text-sm rounded-full border border-accent-green font-medium">
                  #{tag}
                </span>
              ))}
            </div>
          )
        }

        <!-- Title -->
        <h1
          class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 sm:mb-6 leading-tight"
          id="article-title"
        >
          {post.data.title}
        </h1>

        <!-- Meta Information -->
        <div
          class="flex flex-wrap items-center gap-3 sm:gap-4 text-secondary transition-colors text-xs sm:text-sm border-l-4 border-accent-green pl-3 sm:pl-4 py-2 sm:py-2 bg-accent-green/5 rounded-r-lg"
        >
          <div class="flex items-center gap-2">
            <Icon
              name="mdi:calendar"
              class="w-5 h-5 text-accent-green transition-colors"
            />
            <span>{formatDateLong(post.data.publishDate)}</span>
          </div>
          <span class="text-tertiary transition-colors">•</span>
          <div class="flex items-center gap-2">
            <Icon
              name="mdi:account"
              class="w-5 h-5 text-accent-green transition-colors"
            />
            <span>{post.data.author}</span>
          </div>
          <span class="text-tertiary transition-colors">•</span>
          <div class="flex items-center gap-2">
            <Icon
              name="mdi:clock"
              class="w-5 h-5 text-accent-green transition-colors"
            />
            <span id="read-time">{calculateReadTime(post.body)} min read</span>
          </div>
          <span class="text-tertiary transition-colors hidden sm:inline">•</span
          >
          <div class="flex items-center gap-2 hidden sm:flex">
            <button
              id="print-button"
              class="flex items-center gap-1.5 text-secondary hover:text-accent-green transition-colors"
              aria-label="Print article"
              title="Print article"
            >
              <Icon name="mdi:file-document" class="w-4 h-4" />
              <span class="text-xs">Print</span>
            </button>
          </div>
        </div>

        <!-- Description -->
        <p
          class="text-lg sm:text-xl text-secondary transition-colors mt-4 sm:mt-6 leading-relaxed"
        >
          {post.data.description}
        </p>
      </ContentWrapper>

      <!-- Featured Image (if available) -->
      {
        post.data.image && (
          <ContentWrapper maxWidth="4xl" class="mb-10 sm:mb-12">
            <figure class="my-0">
              <img
                src={post.data.image}
                alt={post.data.title}
                class="w-full rounded-xl border border-theme shadow-2xl object-cover"
                loading="eager"
                decoding="async"
              />
            </figure>
          </ContentWrapper>
        )
      }

      <!-- Article Content with Sidebar Layout -->
      <ContentWrapper maxWidth="4xl">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12">
          <!-- Main Content -->
          <div class="lg:col-span-3">
            <div
              id="article-content"
              class="prose prose-sm sm:prose-base md:prose-lg max-w-none
          prose-headings:text-primary prose-headings:font-bold
          prose-h1:text-lg sm:prose-h1:text-xl md:prose-h1:text-2xl prose-h1:mb-4 sm:prose-h1:mb-5 prose-h1:mt-0
          prose-h2:text-xl sm:prose-h2:text-2xl md:prose-h2:text-3xl prose-h2:mt-8 sm:prose-h2:mt-10 prose-h2:mb-4 sm:prose-h2:mb-5 prose-h2:text-primary prose-h2:font-bold prose-h2:leading-tight
          prose-h3:text-lg sm:prose-h3:text-xl md:prose-h3:text-2xl prose-h3:mt-6 sm:prose-h3:mt-8 prose-h3:mb-3 sm:prose-h3:mb-4 prose-h3:text-primary prose-h3:font-semibold
          prose-h4:text-base sm:prose-h4:text-lg prose-h4:mt-5 sm:prose-h4:mt-6 prose-h4:mb-2 sm:prose-h4:mb-3 prose-h4:text-secondary
          prose-p:text-secondary prose-p:leading-relaxed prose-p:mb-5 sm:prose-p:mb-6 prose-p:text-sm sm:prose-p:text-base prose-p:font-normal
          prose-a:text-primary prose-a:no-underline hover:prose-a:text-accent-green hover:prose-a:underline prose-a:font-medium prose-a:transition-colors
          prose-strong:text-primary prose-strong:font-semibold
          prose-ul:text-secondary prose-ul:my-5 sm:prose-ul:my-6 prose-ul:space-y-2
          prose-ol:text-secondary prose-ol:my-5 sm:prose-ol:my-6 prose-ol:space-y-2
          prose-li:my-2 prose-li:text-sm sm:prose-li:text-base prose-li:leading-relaxed
          prose-li::marker:text-primary
          prose-code:text-primary prose-code:bg-card/80 prose-code:px-2 prose-code:py-1 prose-code:rounded prose-code:text-xs sm:prose-code:text-sm prose-code:font-mono prose-code:before:content-none prose-code:after:content-none
          prose-pre:bg-card prose-pre:border prose-pre:border-theme prose-pre:rounded-xl prose-pre:shadow-lg prose-pre:text-xs sm:prose-pre:text-sm prose-pre:overflow-x-auto prose-pre:text-primary
          prose-pre code:text-primary prose-pre code:bg-transparent prose-pre code:p-0
          prose-blockquote:border-l-4 prose-blockquote:border-accent-green prose-blockquote:bg-accent-green/5 prose-blockquote:pl-4 sm:prose-blockquote:pl-6 prose-blockquote:pr-4 sm:prose-blockquote:pr-6 prose-blockquote:py-4 prose-blockquote:my-6 sm:prose-blockquote:my-8 prose-blockquote:rounded-r-lg prose-blockquote:not-italic
          prose-blockquote p:text-secondary prose-blockquote p:mb-0
          prose-img:rounded-xl prose-img:border prose-img:border-theme prose-img:my-6 sm:prose-img:my-8 prose-img:shadow-xl prose-img:w-full prose-img:h-auto
          prose-hr:border-theme prose-hr:my-8 sm:prose-hr:my-12
          prose-table:w-full prose-table:my-6 sm:prose-table:my-8
          prose-thead:border-b prose-thead:border-theme
          prose-th:bg-card prose-th:text-primary prose-th:font-semibold prose-th:p-3 sm:prose-th:p-4 prose-th:text-left prose-th:text-sm sm:prose-th:text-base
          prose-td:border-b prose-td:border-theme prose-td:p-3 sm:prose-td:p-4 prose-td:text-secondary prose-td:text-sm sm:prose-td:text-base
          prose-tr:hover:bg-card/50 prose-tr:transition-colors"
            >
              <Content />
            </div>
          </div>

          <!-- Table of Contents Sidebar -->
          {
            toc.length > 0 && (
              <aside class="lg:col-span-2 hidden lg:block">
                <div class="sticky top-24">
                  <div class="bg-card border border-theme rounded-xl p-5 sm:p-6 min-w-[280px]">
                    <h3 class="font-bold text-primary mb-4 flex items-center gap-2 transition-colors">
                      <Icon
                        name="mdi:book-open"
                        class="w-5 h-5 text-accent-green transition-colors"
                      />
                      Table of Contents
                    </h3>
                    <nav class="space-y-1">
                      {toc.map((section) => (
                        <div class="toc-section">
                          <a
                            href={`#${section.id}`}
                            class="block px-3 py-2 rounded-lg text-sm font-semibold text-primary hover:text-accent-green hover:bg-accent-green/10 transition-all min-h-[44px] flex items-center justify-between group"
                          >
                            <span>{section.text}</span>
                            {section.children &&
                              section.children.length > 0 && (
                                <Icon
                                  name="mdi:chevron-down"
                                  class="w-4 h-4 text-tertiary group-hover:text-accent-green transition-all toc-chevron"
                                  data-section-id={section.id}
                                />
                              )}
                          </a>
                          {section.children && section.children.length > 0 && (
                            <div
                              class="toc-subsection hidden pl-4 space-y-1"
                              data-section-children={section.id}
                            >
                              {section.children.map((subsection) => (
                                <a
                                  href={`#${subsection.id}`}
                                  class="block px-3 py-2 rounded-lg text-sm text-secondary hover:text-accent-green hover:bg-accent-green/10 transition-all min-h-[44px] flex items-center"
                                >
                                  {subsection.text}
                                </a>
                              ))}
                            </div>
                          )}
                        </div>
                      ))}
                    </nav>
                  </div>
                </div>
              </aside>
            )
          }
        </div>

        <!-- Social Share Buttons -->
        <div class="mt-10 sm:mt-12 pt-6 sm:pt-8 border-t border-theme">
          <div
            class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"
          >
            <div class="w-full sm:w-auto">
              <p
                class="text-xs sm:text-sm font-semibold text-primary transition-colors mb-3 sm:mb-2"
              >
                Share this article:
              </p>
              <div class="flex flex-wrap items-center gap-3">
                <SocialShare
                  description={post.data.description}
                  title={post.data.title}
                  url={articleUrl}
                />
                <!-- Copy Link Button -->
                <button
                  id="copy-link-button"
                  class="inline-flex items-center gap-2 px-4 py-2 bg-surface text-primary rounded-lg hover:bg-accent-green/10 hover:text-accent-green transition-all min-h-[44px] touch-manipulation"
                  aria-label="Copy link"
                  title="Copy link to clipboard"
                >
                  <Icon name="mdi:share-variant" class="w-4 h-4" />
                  <span class="text-sm font-medium hidden sm:inline"
                    >Copy Link</span
                  >
                </button>
                <!-- Email Share -->
                <a
                  href={`mailto:?subject=${encodeURIComponent(articleTitle)}&body=${encodeURIComponent(`${articleTitle}\n\n${articleDescription}\n\n${articleUrl}`)}`}
                  class="inline-flex items-center gap-2 px-4 py-2 bg-surface text-primary rounded-lg hover:bg-accent-green/10 hover:text-accent-green transition-all min-h-[44px] touch-manipulation"
                  aria-label="Share via email"
                  title="Share via email"
                >
                  <Icon name="mdi:email-outline" class="w-4 h-4" />
                  <span class="text-sm font-medium hidden sm:inline">Email</span
                  >
                </a>
              </div>
            </div>
          </div>
        </div>
      </ContentWrapper>

      <!-- Key Takeaways Section -->
      {
        // Extract or manually add takeaways - using a placeholder for now
        // In a real implementation, this could come from frontmatter or be auto-extracted
        true && (
          <ContentWrapper maxWidth="4xl" class="mt-12 sm:mt-16">
            <div
              class="bg-gradient-to-br from-accent-green/10 to-accent-green/5 border-2 border-accent-green/20 rounded-2xl p-6 sm:p-8"
              id="key-takeaways"
            >
              <h2 class="text-2xl sm:text-3xl font-bold mb-5 sm:mb-6 flex items-center text-primary transition-colors">
                <Icon
                  name="mdi:lightbulb"
                  class="w-6 h-6 sm:w-7 sm:h-7 text-accent-green transition-colors mr-3"
                />
                Key Takeaways
              </h2>
              <div class="space-y-3 sm:space-y-4">
                <div class="flex items-start gap-3">
                  <Icon
                    name="mdi:check-circle"
                    class="w-5 h-5 sm:w-6 sm:h-6 text-accent-green transition-colors flex-shrink-0 mt-0.5"
                  />
                  <p class="text-sm sm:text-base text-secondary transition-colors leading-relaxed">
                    This article provides insights into data analytics and
                    business intelligence best practices.
                  </p>
                </div>
                <div class="flex items-start gap-3">
                  <Icon
                    name="mdi:check-circle"
                    class="w-5 h-5 sm:w-6 sm:h-6 text-accent-green transition-colors flex-shrink-0 mt-0.5"
                  />
                  <p class="text-sm sm:text-base text-secondary transition-colors leading-relaxed">
                    Understanding your data capabilities is the first step
                    toward transformation.
                  </p>
                </div>
                <div class="flex items-start gap-3">
                  <Icon
                    name="mdi:check-circle"
                    class="w-5 h-5 sm:w-6 sm:h-6 text-accent-green transition-colors flex-shrink-0 mt-0.5"
                  />
                  <p class="text-sm sm:text-base text-secondary transition-colors leading-relaxed">
                    Partnering with experienced data consultants can accelerate
                    your journey.
                  </p>
                </div>
              </div>
              <div class="mt-6 sm:mt-8 pt-6 sm:pt-8 border-t border-theme">
                <h3 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-primary transition-colors">
                  What's Next?
                </h3>
                <div class="space-y-2 sm:space-y-3">
                  <a
                    href={`${base}contact/`}
                    class="flex items-center gap-2 text-accent-green hover:text-accent-green/80 transition-colors font-medium text-sm sm:text-base min-h-[44px] touch-manipulation"
                  >
                    <Icon name="mdi:arrow-right" class="w-4 h-4" />
                    <span>
                      Schedule a consultation to discuss your data needs
                    </span>
                  </a>
                  <a
                    href={`${base}services/`}
                    class="flex items-center gap-2 text-accent-green hover:text-accent-green/80 transition-colors font-medium text-sm sm:text-base min-h-[44px] touch-manipulation"
                  >
                    <Icon name="mdi:arrow-right" class="w-4 h-4" />
                    <span>Explore our data analytics services</span>
                  </a>
                </div>
              </div>
            </div>
          </ContentWrapper>
        )
      }

      <!-- Related Posts Section -->
      {
        relatedPosts.length > 0 && (
          <ContentWrapper maxWidth="4xl" class="mt-12 sm:mt-16">
            <div class="mb-6 sm:mb-8">
              <h2 class="text-2xl sm:text-3xl font-bold text-primary transition-colors flex items-center gap-3">
                <Icon
                  name="mdi:book-open"
                  class="w-6 h-6 sm:w-7 sm:h-7 text-accent-green transition-colors"
                />
                Related Posts
              </h2>
              <p class="text-sm sm:text-base text-secondary transition-colors mt-2">
                Continue reading with these related articles
              </p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 blog-posts-container">
              {relatedPosts.map((relatedPost) => (
                <div class="blog-related-post blog-post-item" data-categories={JSON.stringify(relatedPost.data.tags || [])}>
                  <BlogPostCard post={relatedPost} featured={false} />
                </div>
              ))}
            </div>
          </ContentWrapper>
        )
      }

      <!-- Next/Previous Post Navigation -->
      {
        (nextPost || prevPost) && (
          <ContentWrapper maxWidth="4xl" class="mt-10 sm:mt-12">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
              {prevPost && (
                <a
                  href={`${base}blog/${prevPost.id.replace(/\.mdx?$/, "")}/`}
                  class="group bg-card border border-theme rounded-xl p-5 sm:p-6 hover:border-accent-green transition-all min-h-[44px] touch-manipulation"
                >
                  <div class="flex items-center gap-2 mb-2 text-xs sm:text-sm text-tertiary transition-colors">
                    <Icon name="mdi:arrow-left" class="w-4 h-4" />
                    <span>Previous Post</span>
                  </div>
                  <h3 class="text-base sm:text-lg font-semibold text-primary group-hover:text-accent-green transition-colors line-clamp-2">
                    {prevPost.data.title}
                  </h3>
                </a>
              )}
              {nextPost && (
                <a
                  href={`${base}blog/${nextPost.id.replace(/\.mdx?$/, "")}/`}
                  class="group bg-card border border-theme rounded-xl p-5 sm:p-6 hover:border-accent-green transition-all min-h-[44px] touch-manipulation md:text-right"
                >
                  <div class="flex items-center gap-2 mb-2 text-xs sm:text-sm text-tertiary transition-colors md:justify-end">
                    <span>Next Post</span>
                    <Icon name="mdi:arrow-right" class="w-4 h-4" />
                  </div>
                  <h3 class="text-base sm:text-lg font-semibold text-primary group-hover:text-accent-green transition-colors line-clamp-2">
                    {nextPost.data.title}
                  </h3>
                </a>
              )}
            </div>
          </ContentWrapper>
        )
      }

      <!-- Call to Action -->
      <ContentWrapper maxWidth="4xl" class="mt-12 sm:mt-16">
        <div
          class="bg-gradient-to-r from-accent-green/10 to-accent-green/20 border-2 border-accent-green/20 rounded-2xl p-6 sm:p-8 md:p-12 text-center"
        >
          <div class="flex items-center justify-center gap-2 mb-4">
            <Icon
              name={contextualCTA.icon}
              class="w-6 h-6 sm:w-7 sm:h-7 text-accent-green transition-colors"
            />
            <h2 class="text-2xl sm:text-3xl font-bold">
              {contextualCTA.title}
            </h2>
          </div>
          <p
            class="text-sm sm:text-base text-secondary transition-colors mb-6 sm:mb-8 max-w-2xl mx-auto leading-relaxed"
          >
            {contextualCTA.description}
          </p>
          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
            <a
              href={contextualCTA.href}
              class="px-6 sm:px-8 py-3 sm:py-4 bg-accent-green text-on-accent font-bold rounded-lg hover:bg-accent-green/90 active:bg-accent-green/80 transition-colors active:scale-95 inline-flex items-center justify-center gap-2 text-sm sm:text-base min-h-[44px] touch-manipulation animate-pulse"
            >
              <Icon name="mdi:email" class="w-4 h-4 sm:w-5 sm:h-5" />
              Get In Touch
            </a>
            <a
              href={`${base}services/`}
              class="px-6 sm:px-8 py-3 sm:py-4 bg-surface text-primary font-bold rounded-lg hover:bg-surface/80 active:bg-surface/70 transition-all transform hover:scale-105 active:scale-95 inline-flex items-center justify-center gap-2 text-sm sm:text-base min-h-[44px] touch-manipulation"
            >
              <Icon name="mdi:briefcase" class="w-4 h-4 sm:w-5 sm:h-5" />
              View Our Services
            </a>
          </div>
        </div>
      </ContentWrapper>

      <!-- Back to Blog -->
      <ContentWrapper maxWidth="4xl" class="mt-10 sm:mt-12 text-center">
        <a
          href={`${base}blog/`}
          class="inline-flex items-center gap-2 text-accent-green transition-colors hover:text-accent-green/80 active:text-accent-green/70 transition-colors font-semibold text-sm sm:text-base py-2 touch-manipulation min-h-[44px] justify-center"
        >
          <Icon name="mdi:arrow-left" class="w-4 h-4 sm:w-5 sm:h-5" />
          Back to All Posts
        </a>
      </ContentWrapper>
    </article>
  </PageContainer>
</BaseLayout>

<style>
  /* Code block base styling */
  .prose pre {
    padding: 1rem 1.25rem;
    margin: 0 !important;
    overflow-x: auto;
    border-radius: 0;
  }

  /* Code element styling */
  .prose pre code {
    background: transparent !important;
    padding: 0 !important;
    font-size: 0.875rem;
    line-height: 1.75;
    display: block;
    width: 100%;
  }

  /* Non-Shiki code blocks (fallback) */
  .prose pre:not(.astro-code):not([class*="astro-code"]) {
    background: var(--bg-card) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 0.5rem;
    color: var(--text-primary) !important;
  }

  .prose pre:not(.astro-code):not([class*="astro-code"]) * {
    color: var(--text-primary) !important;
  }

  /* Responsive tables */
  @media (max-width: 768px) {
    .prose table {
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .prose table thead {
      display: none;
    }

    .prose table tbody {
      display: block;
      width: 100%;
    }

    .prose table tr {
      display: block;
      margin-bottom: 1rem;
      border: 1px solid var(--border-color) !important;
      border-radius: 0.5rem;
      padding: 0.75rem;
      background: var(--bg-card) !important;
    }

    .prose table td {
      display: block;
      text-align: right;
      padding: 0.5rem 0;
      border: none;
      border-bottom: 1px solid var(--border-color) !important;
    }

    .prose table td:last-child {
      border-bottom: none;
    }

    .prose table td::before {
      content: attr(data-label) ": ";
      float: left;
      font-weight: 600;
      color: var(--accent-green) !important;
    }
  }

  /* Better code inline styling - Theme-aware */
  .prose code:not(pre code) {
    background: rgba(var(--accent-green-rgb), 0.1) !important;
    border: 1px solid rgba(var(--accent-green-rgb), 0.2) !important;
  }

  /* Enhanced blockquote */
  .prose blockquote {
    border-left-width: 4px;
  }

  .prose blockquote p:first-child {
    margin-top: 0;
  }

  .prose blockquote p:last-child {
    margin-bottom: 0;
  }

  /* Better list spacing */
  .prose ul > li,
  .prose ol > li {
    padding-left: 0.5rem;
  }

  /* Nested lists */
  .prose ul ul,
  .prose ol ol,
  .prose ul ol,
  .prose ol ul {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  /* Improved image rendering */
  .prose img {
    max-width: 100%;
    height: auto;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }


  /* Ensure proper text selection - Theme-aware */
  .prose *::selection {
    background: rgba(var(--accent-green-rgb), 0.3) !important;
  }

  /* Add IDs to headings for TOC navigation */
  .prose h2,
  .prose h3 {
    scroll-margin-top: 5rem;
  }

  /* Code block wrapper with header */
  .code-block-wrapper {
    position: relative;
    margin: 1.5rem 0;
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid var(--border-color);
    background: var(--bg-card);
    box-shadow:
      0 1px 3px 0 rgba(0, 0, 0, 0.1),
      0 1px 2px 0 rgba(0, 0, 0, 0.06);
  }

  .code-block-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border-color);
    font-size: 0.75rem;
    min-height: 2.25rem;
    gap: 0.75rem;
  }

  .code-block-language {
    color: var(--text-tertiary);
    font-family:
      ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas,
      "Liberation Mono", monospace;
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.025em;
    text-transform: capitalize;
  }

  .code-copy-button {
    padding: 0.375rem 0.75rem;
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    color: var(--text-secondary);
    cursor: pointer;
    opacity: 1;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    font-size: 0.7rem;
    font-weight: 500;
    line-height: 1;
    min-height: 1.75rem;
    min-width: 3.5rem;
    z-index: 10;
    margin: 0;
    white-space: nowrap;
  }

  .code-copy-button:hover {
    opacity: 1;
    background: var(--accent-green);
    color: var(--bg-primary);
    border-color: var(--accent-green);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .code-copy-button:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .code-copy-button:focus {
    outline: 2px solid var(--accent-green);
    outline-offset: 2px;
  }

  .code-copy-button:focus-visible {
    outline: 2px solid var(--accent-green);
    outline-offset: 2px;
  }

  .code-copy-button.copied {
    background: var(--accent-green);
    color: var(--bg-primary);
    border-color: var(--accent-green);
    opacity: 1;
    animation: copySuccess 0.3s ease;
  }

  @keyframes copySuccess {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
    100% {
      transform: scale(1);
    }
  }

  .code-copy-button .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  .code-copy-button .copy-text {
    font-weight: 500;
    letter-spacing: 0.025em;
  }

  /* Code blocks inside wrapper */
  .code-block-wrapper pre {
    border-radius: 0;
    margin: 0;
  }

  /* TOC expandable sections */
  .toc-section {
    margin-bottom: 0.25rem;
  }

  .toc-chevron {
    transition: transform 0.2s ease;
  }

  .toc-section.active .toc-chevron {
    transform: rotate(180deg);
  }

  .toc-subsection {
    max-height: 0;
    overflow: hidden;
    transition:
      max-height 0.3s ease,
      opacity 0.2s ease;
    opacity: 0;
  }

  .toc-section.active .toc-subsection {
    max-height: 1000px;
    opacity: 1;
    display: block;
  }

  /* Print styles */
  @media print {
    #reading-progress,
    #copy-link-button,
    #print-button,
    .code-copy-button,
    .code-block-header,
    aside,
    nav,
    footer,
    header {
      display: none !important;
    }

    .code-block-wrapper {
      border: 1px solid #ccc;
      page-break-inside: avoid;
    }

    .prose {
      max-width: 100% !important;
    }

    .prose pre {
      page-break-inside: avoid;
    }

    .prose img {
      max-width: 100%;
      page-break-inside: avoid;
    }
  }
</style>

<script is:inline define:vars={{ base }}>
  import { initializeBlogPostScripts } from "../../scripts/blog-post";
  document.addEventListener("DOMContentLoaded", () => {
    initializeBlogPostScripts(base);
  });
</script>
